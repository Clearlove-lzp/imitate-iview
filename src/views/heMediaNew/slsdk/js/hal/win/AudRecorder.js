import Recorder from"../../module/audio/src/recorder-core.js";var AudRecorder=function(e){this.transferUploadNumberMax=0,this.realTimeSendTryTime=0,this.realTimeSendTryEncBusy=0,this.realTimeSendTryNumber=0,this.realTimeSendTryChunk=null,this.send_interval=100,this.testSampleRate=8e3,this.realTimeSendTryType="pcm",this.testBitRate=16,this.recAudBuffer=new Array;var r=this;this.transferUpload=function(e,t,i,n,a){if(this.transferUploadNumberMax=Math.max(this.transferUploadNumberMax,e),console.info("blob:",t),t){var s=t,o=s.encTime;console.info("encTime:"+o);var d=new FileReader;d.addEventListener("loadend",(function(){for(var e=new Uint8Array(d.result),t=0;t<e.byteLength;t++)r.recAudBuffer.push(e[t])})),d.readAsArrayBuffer(s)}a&&console.info("No."+(e<100?("000"+e).substr(-3):e)+":已停止传输")},this.transferUpload=this.transferUpload.bind(this),this.realTimeSendTry=function(e){var t=this.audio,i=Date.now();if(0==this.realTimeSendTryTime&&(this.realTimeSendTryTime=i,this.realTimeSendTryEncBusy=0,this.realTimeSendTryNumber=0,this.transferUploadNumberMax=0,this.realTimeSendTryChunk=null),e||!(i-this.realTimeSendTryTime<this.send_interval)){this.realTimeSendTryTime=i;for(var n=++this.realTimeSendTryNumber,a=Recorder.SampleData(t.buffers,t.srcSampleRate,this.testSampleRate,this.realTimeSendTryChunk,{frameType:e?"":this.realTimeSendTryType}),s=this.realTimeSendTryChunk?this.realTimeSendTryChunk.index:0;s<a.index;s++)t.buffers[s]=null;if(this.realTimeSendTryChunk=a,!(0==a.data.length||e&&a.data.length<2e3))if(!e&&this.realTimeSendTryEncBusy>=2)console.error("编码队列阻塞，已丢弃一帧");else{this.realTimeSendTryEncBusy++;var o=Date.now(),d=Recorder({type:this.realTimeSendTryType,sampleRate:this.testSampleRate,bitRate:this.testBitRate});d.mock(a.data,a.sampleRate),d.stop((function(t,i){r.realTimeSendTryEncBusy&&r.realTimeSendTryEncBusy--,t.encTime=Date.now()-o,r.transferUpload(n,t,i,d,e)}),(function(e){r.realTimeSendTryEncBusy&&r.realTimeSendTryEncBusy--,console.error("不应该出现的错误:"+e)}))}}},this.realTimeSendTry=this.realTimeSendTry.bind(this),this.audio=Recorder({type:"unknown",sampleRate:this.testSampleRate,bitRate:this.testBitRate,onProcess:function(e,t,i,n){r.realTimeSendTry(!1)}})};AudRecorder.prototype.start=function(){var e=this;console.log("Recorder start");var r=setTimeout((function(){console.error("无法录音：权限请求被忽略（超时假装手动点击了确认对话框）")}),8e3);return this.audio.open((function(){clearTimeout(r),console.info("rec start"),e.realTimeSendTryTime=0,e.audio.start()}),(function(e,t){clearTimeout(r),console.error((t?"UserNotAllow，":"")+"无法录音:"+e)})),0},AudRecorder.prototype.stop=function(){console.log("Recorder stop"),this.audio&&(this.audio.stop(),this.audio.close())},AudRecorder.prototype.read_frame=function(){return this.recAudBuffer.shift()},AudRecorder.prototype.get_audio_buffer_len=function(){return this.recAudBuffer.length};export default AudRecorder;