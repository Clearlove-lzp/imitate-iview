import event_status_total from "../common/event_status.js"; const EVENT_STATUS = event_status_total.EVENT_STATUS, PLATFORM = 0; import { openLog, logInfo, warn, error } from "../core/log.js"; var WebConnect = function (t, o, s, e) { this.url = null, this.is_wss = t.profile.is_wss, this.connect_cb = o, this.command_cb = s, this.audio_cb = e, this.log = function (t, o, s) { switch (t) { case 1: default: logInfo("WebConnect", o, s); break; case 2: warn("WebConnect", o, s); break; case 3: error("WebConnect", o, s) } }, this.log = this.log.bind(this) }; WebConnect.prototype.connect = function (t) { console.log(t, "this.is_wss"), this.url = (this.is_wss ? "wss://" : "ws://") + t, console.log("WebConnect connect:", this.url), this.socket = new WebSocket(this.url), this.socket.uuid = (new Date).getTime(), console.log("socket connect conn uuid:", this.socket.uuid), this.log("socket connect conn uuid:", this.socket.uuid), this.socket.onopen = function (t) { console.log("WebConnect onopen", this.socket), this.log(1, "WebConnect onopen", this.socket.url), this.connect_cb && this.connect_cb(EVENT_STATUS.WEBCONNECT_OPEN, this.socket) }, this.socket.onopen = this.socket.onopen.bind(this), this.socket.onmessage = function (t) { var o = t.data; if ("string" == typeof o) { const t = JSON.parse(o); this.command_cb && this.command_cb(this.socket.uuid, t.msg_name, t.msg_body) } else o instanceof Blob && this.audio_cb && this.audio_cb(o) }, this.socket.onmessage = this.socket.onmessage.bind(this), this.socket.onclose = function (t) { console.log("真正断开socket链接", this.socket), this.socket && this.log(1, "web_connect_onclose_断开socket链接", this.socket.url), console.log("onclose", t), this.socket ? this.log(1, "web_connect_uuid", this.socket.uuid) : this.log(1, "web_connect_uuid为空,this.socket为空"), this.connect_cb && this.connect_cb(EVENT_STATUS.WEBCONNECT_CLOSE, this.socket) }, this.socket.onclose = this.socket.onclose.bind(this), this.socket.onerror = function (t) { this.socket ? this.log(1, "web_connect_uuid", this.socket.uuid) : this.log(1, "web_connect_uuid为空,this.socket为空"), this.connect_cb && this.connect_cb(EVENT_STATUS.WEBCONNECT_ERROR, this.socket) }, this.socket.onerror = this.socket.onerror.bind(this) }, WebConnect.prototype.close = function (t) { console.log("执行断开socket链接", this.socket), this.socket && this.log(1, "web_connect_close_uuid执行断开socket链接", this.socket.url), this.socket ? (console.log("conn uuid:", this.socket.uuid), this.log(1, "web_connect_close_uuid", this.socket.uuid)) : this.log(1, "web_connect_uuid为空,this.socket为空"), this.socket && (this.socket.close(), this.socket = null) }, WebConnect.prototype.send_cmd = function (t, o) { var s = { msg_name: t, msg_body: o, platform: 0 }, e = JSON.stringify(s); this.socket && this.socket.send(e) }, WebConnect.prototype.send_audio = function (t) { this.socket.send(t) }; export default WebConnect;