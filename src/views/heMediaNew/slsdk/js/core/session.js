import event_status_total from"../common/event_status.js";import{current_time_millisec,current_time_sec}from"../common/helper.js";import WebConnect from"../hal/web_connect.js";import Config from"./config.js";import StreamOut from"./streamout.js";import StreamIn from"./streamin.js";import{openLog,logInfo,warn,error}from"./log.js";var config;config=new Config;const EVENT_STATUS=event_status_total.EVENT_STATUS,SESSION_STATUS=event_status_total.SESSION_STATUS,SESSION_SIGNAL=event_status_total.SESSION_SIGNAL,ECHAT_ERR=event_status_total.ECHAT_ERR,GROUP_TYPE=event_status_total.GROUP_TYPE;var Session=function(s,t,i,e){this.RECORD_REQUESTOR=1;this.log=function(s,t,i){switch(s){case 1:default:logInfo("Session",t,i);break;case 2:warn("Session",t,i);break;case 3:error("Session",t,i)}},this.log=this.log.bind(this),this.ctx=s;let _=this.ctx.cache.get_group_by_gid(t);this.group_type=_?_.type:GROUP_TYPE.GROUP_STATIC,this.address=i,this.status=SESSION_STATUS.SESSION_STATUS_INIT,this.gid=t,this.conn=null,this.stream_out=null,this.stream_in=null,this.packet_frames=this.ctx.config.audio.packet_frames,this.speaker=0,this.speaker_name="",this.speaker_tmp=0,this.priority=e+this.ctx.focus.PriorityType.SESSION_SPEAK_PRIOR_BASE,5!=this.group_type&&this.group_type!=GROUP_TYPE.GROUP_SESSION||(this.priority=this.ctx.focus.PriorityType.SESSION_SESSION_GROUP_PRIORITY),this.speak_status_connecting_count=0,this.tv_get_mic=0,this.tv_last_try_speak=0,this.has_record_focus=!1,this.myuid=this.ctx.cache.get_current_uid(),this.is_member=!1,this.is_leaving=!1,this.is_listener=!1,this.tv_last_watch_sync=0,this.tv_last_listen_sync=0,this.locked_gid="0",this.has_play_focus=!1,this.tv_last_write=0,this.udp_ping_expired_count=0,this.recv_audio_size=0,this.tv_member_get_mic=0,this.tv_last_member_get_mic=0,this.aud_listen_retry_count=0,this.actived=!1,this.tv_last_read=0,this.ping_seq=0,this.member_speak_active_timer=null,this.request_mic_timeout_timer=null,this.listen_group_timeout_timer=null,this.active_timer=null,this.ping_timeout_timer=null,this.member_speak_actived=!1,this.tv_recv_member_audio=0,this.sid="0",this.current_session_playing=!1,this.ignore=!1,this.audio_packet=null,this.notify_process=function(s,t){this.log(1,"notify_process code:",s.code),this.ctx.notify_cb(s,t),s.code==EVENT_STATUS.WEBCONNECT_OPEN.code&&this.ping()},this.notify_process=this.notify_process.bind(this),this.command_process=function(s,t,i){console.log("ChatGroup command process name:",t),this.log(1,"ChatGroup command process name:",t),console.log("conn uuid:",s),this.log(1,"conn uuid:",s),this.tv_last_read=current_time_millisec();var e=this.dispatcher[t];"function"==typeof e&&e(i)},this.command_process=this.command_process.bind(this),this.audio_process=function(s){this.tv_last_read=current_time_millisec(),this.audio_packet=s;const t=s.slice(0,12);this.session_signal(SESSION_SIGNAL.SESSION_SIG_MEMBER_AUDIO),this.readBlobAsArrayBuffer(t)},this.audio_process=this.audio_process.bind(this),this.readBlobAsArrayBuffer=async function(s){const t=new Response(s);var i=new DataView(await t.arrayBuffer()),e=i.getUint8(1),_=i.getUint16(2),o=i.getUint32(4),n=i.getUint32(8);console.log("pt:",e,"session uid:",n,"seq:",_,"ts:",o),this.log(1,"pt:",e),this.log(1,"session uid:",n),this.log(1,"seq:",_),this.log(1,"ts:",o),this.session_try_do_fake_get_mic(e,n,_)},this.readBlobAsArrayBuffer=this.readBlobAsArrayBuffer.bind(this),this.session_try_do_fake_get_mic=function(s,t,i){let e=null,_=t;if(101==s){if(0==this.gid||this.speaker>0)return this.last_fake_speaker=0,this.fake_probation=3,void(this.last_fake_seq=0);if(this.last_fake_speaker>0&&_!=this.last_fake_speaker)return this.last_fake_speaker=_,this.fake_probation=3,void(this.last_fake_seq=i);if(this.last_fake_seq>0&&i-this.last_fake_seq>2)return this.last_fake_speaker=_,this.fake_probation=3,void(this.last_fake_seq=i);if(this.fake_probation>0)this.fake_probation--;else if(this.last_fake_speaker=_,this.last_fake_seq=i,this.status==SESSION_STATUS.SESSION_STATUS_IDLE&&(e=this.ctx.cache.get_member_by_uid(this.gid,_),null!=e)){var o=new Object;o.gid=this.gid,o.uid=_,o.sid=0,o.uname=e.name;var n=this.ctx.cache.get_group_session_by_gid(this.gid);null!=n&&n.gid>0&&(o.gname=n.name,o.type=n.type),o.connecttime=current_time_millisec(),this.ctx.notify_cb(EVENT_STATUS.EN_MEMBER_GET_MIC,o),this.speaker=_,this.speaker_tmp=_,this.sid=0,this.ignore=!1,this.tv_last_member_get_mic=this.tv_member_get_mic=current_time_millisec(),this.session_signal(SESSION_SIGNAL.SESSION_SIG_MEMBER_GET_MIC)}}},this.session_try_do_fake_get_mic=this.session_try_do_fake_get_mic.bind(this),this.send_message=function(s,t){if(null!=this.conn){var i={msg_name:s,msg_body:t};console.log(t,s,"--json_msg");var e=JSON.stringify(i),_={type:1};_.uid=this.myuid,_.msg=btoa(e),this.log(1,"send_message uid:"+this.myuid),this.conn.send_cmd("et.net.WebsocketSessionPack",_)}else console.log("Group connection is error"),this.log(1,"Group connection is error")},this.send_message=this.send_message.bind(this),this.sendaudio=function(s){if(this.log(1,"sendaudio"),null!=this.conn){var t={type:2};t.uid=this.myuid,t.msg=btoa(s),this.log(1,"send_message uid:"+this.myuid),this.conn.send_cmd("et.net.WebsocketSessionPack",t)}else console.log("Group connection is error"),this.log(1,"Group connection is error")},this.sendaudio=this.sendaudio.bind(this),this.shutdown=function(){this.log(1,"shutdown"),this.is_member=!1,this.is_listener=!1,this.has_play_focus=!1,this.has_record_focus=!1,this.ctx.sound.stop_all(),this.ctx.focus.release(this,0),this.ctx.focus.release(this,this.RECORD_REQUESTOR),null!=this.stream_in&&(this.stream_in.stop(),this.stream_in=null),null!=this.stream_out&&(this.stream_out.stop(),this.stream_out=null),null!=this.conn&&(console.log("执行断开链接1"),this.log(1,"执行断开链接1"),this.conn.close()),this.speaker_name="",this.status=SESSION_STATUS.SESSION_STATUS_INIT},this.shutdown=this.shutdown.bind(this),this.get_listening_enable=function(){return this.log(1,"get_listening_enable"),"0"==this.locked_gid||0==this.locked_gid||this.locked_gid==this.gid},this.get_listening_enable=this.get_listening_enable.bind(this),this.send_heartbeat=function(){this.log(1,"send_heartbeat");var s={};s.gid=this.gid,s.uid=this.myuid,s.timestamp=current_time_sec(),s.seq=this.heartbeat_seq++,this.send_message("et.net.HeartBeat",s)},this.send_heartbeat=this.send_heartbeat.bind(this),this.send_continuetalk=function(){this.log(1,"send_continuetalk"),this.send_heartbeat(self),this.ignore=!1},this.send_continuetalk=this.send_continuetalk.bind(this),this.on_play_focus_notify=function(s,t){console.log("SESSION_SIGNAL.SESSION_SIG_GET_PLAY_FOCUS",SESSION_SIGNAL.SESSION_SIG_GET_PLAY_FOCUS),this.log(1,"SESSION_SIGNAL.SESSION_SIG_GET_PLAY_FOCUS",SESSION_SIGNAL.SESSION_SIG_GET_PLAY_FOCUS),t?(this.has_play_focus=!0,this.speaker=this.speaker_tmp,this.start_member_speak_active(),this.session_signal(SESSION_SIGNAL.SESSION_SIG_GET_PLAY_FOCUS)):(this.has_play_focus=!1,this.session_signal(SESSION_SIGNAL.SESSION_SIG_LOST_PLAY_FOCUS))},this.on_play_focus_notify=this.on_play_focus_notify.bind(this),this.on_record_focus_notify=function(s,t){var i=s;t||(i.has_record_focus=!1,i.session_signal(SESSION_SIGNAL.SESSION_SIG_STOP_SPEAK_NO_SUF))},this.on_record_focus_notify=this.on_record_focus_notify.bind(this),this.send_release=function(){this.log(1,"send_release");var s={};s.gid=this.gid,s.uid=this.myuid,s.sid=this.sid,this.send_message("et.aud.Release",s),console.log("release mic gid:",this.gid,"uid:",this.myuid),this.log(1,"release mic gid:",this.gid,"uid:",this.myuid)},this.send_release=this.send_release.bind(this),this.send_release_mic=function(){console.log("send_release_mic",this.tv_get_mic),this.log(1,"send_release_mic",this.tv_get_mic),0!=this.tv_get_mic&&(this.send_release(),this.tv_get_mic=0)},this.send_release_mic=this.send_release_mic.bind(this),this.on_request_mic_timeout=function(){this.session_signal(SESSION_SIGNAL.SESSION_SIG_REFUSE_MIC),this.post_event_notify_error(ECHAT_ERR.REQMIC_TIMEOUT,0),console.log("requst mic timeout!"),this.log(1,"requst mic timeout!"),this.udp_ping_expired_count++,console.log("session udp ping expired:",this.udp_ping_expired_count),this.log(1,"session udp ping expired:",this.udp_ping_expired_count),this.udp_ping_expired_count>3&&(console.log("session udp ping expired to MAX:",3),this.log(1,"session udp ping expired to MAX:",3),this.udp_ping_expired_count=0)},this.on_request_mic_timeout=this.on_request_mic_timeout.bind(this),this.send_request=function(){this.log(1,"send_request");var s={};return s.gid=this.gid,s.uid=this.myuid,s.payload=this.ctx.config.audio.codec_type,this.send_message("et.aud.Request",s),this.request_mic_timeout_timer=setTimeout(this.on_request_mic_timeout,2e3),0},this.send_request=this.send_request.bind(this),this.on_listen_group_timeout=function(){console.log("isten group timeout, request grouplist to update ip/port"),this.log(1,"isten group timeout, request grouplist to update ip/port"),this.aud_listen_retry_count<=3&&(this.send_listen_req(),this.aud_listen_retry_count++),console.log("listen group timeout, retry tcp listen."),this.log(1,"listen group timeout, retry tcp listen."),this.unlisten(),this.aud_listen_retry_count=0},this.on_listen_group_timeout=this.on_listen_group_timeout.bind(this),this.on_ping_timeout=function(){console.log("send ping timeout!"),this.log(1,"send ping timeout!"),this.udp_ping_expired_count++,console.log("session udp ping expired:",this.udp_ping_expired_count),this.log(1,"session udp ping expired:",this.udp_ping_expired_count),this.udp_ping_expired_count>3?(console.log("session udp ping expired to MAX:",3),this.log(1,"session udp ping expired to MAX:",3),this.udp_ping_expired_count=0):this.send_ping()},this.on_ping_timeout=this.on_ping_timeout.bind(this),this.send_listen_req=function(){this.log(1,"send listen request","gid:"+this.gid+",is_listener:"+this.is_listener);var s={};s.gid=this.gid,s.uid=this.myuid,s.expect_pt=this.ctx.config.audio.codec_type,s.accept_pt=this.ctx.config.audio.codec_type,this.send_message("et.aud.Listen",s),clearTimeout(this.listen_group_timeout_timer),this.listen_group_timeout_timer=setTimeout(this.on_listen_group_timeout,2e3)},this.send_listen_req=this.send_listen_req.bind(this),this.send_ping=function(){this.log(1,"send_ping");var s={};s.gid=this.gid,s.uid=this.myuid,s.seq=this.ping_seq++,s.timestamp=current_time_sec(),this.send_message("et.net.Ping",s),clearTimeout(this.ping_timeout_timer),this.ping_timeout_timer=setTimeout(this.on_ping_timeout,2e3)},this.send_ping=this.send_ping.bind(this),this.post_event_notify_error=function(s,t){this.log(1,"post_event_notify_error",s);var i=new Object;i.error=s,i.reason=t,this.ctx.notify_cb(EVENT_STATUS.EN_ERROR_NOTIFY,i)},this.post_event_notify_error=this.post_event_notify_error.bind(this),this.post_event_member_speaking_stop=function(s,t){this.log(1,"post_event_member_speaking_stop gid:",s);var i=new Object;i.gid=s,i.uid=t;var e=this.ctx.cache.get_group_session_by_gid(this.gid);e.gid>0&&(i.gname=e.name);var _=this.ctx.cache.get_user(t);_.uid>0&&(i.uname=_.name),i.sid=this.sid,this.ctx.notify_cb(EVENT_STATUS.EN_MEMBER_SPEAKING_STOP,i)},this.post_event_member_speaking_stop=this.post_event_member_speaking_stop.bind(this),this.post_event_member_speaking_start=function(s,t){console.log("发送请求话权|",this.ctx),this.log(1,"发送请求话权|",this.ctx);var i=new Object;i.gid=s,i.uid=t;var e=this.ctx.cache.get_group_session_by_gid(this.gid);e.gid>0&&(i.gname=e.name);var _=this.ctx.cache.get_user(t);_.uid>0&&(i.uname=_.name),this.ctx.notify_cb(EVENT_STATUS.EN_MEMBER_SPEAKING_START,i)},this.post_event_member_speaking_start=this.post_event_member_speaking_start.bind(this),this.post_event_self_start_speak=function(s){this.log(1,"post_event_self_start_speak gid:",this.gid);var t=new Object;t.gid=this.gid,t.uid=this.myuid;var i=this.ctx.cache.get_group_session_by_gid(this.gid);i&&i.gid>0&&(t.gname=i.name);var e=this.ctx.cache.get_user(this.myuid);e&&e.uid>0&&(t.uname=e.name),this.ctx.notify_cb(EVENT_STATUS.EN_SELF_SPEAKING_START,t)},this.post_event_self_start_speak=this.post_event_self_start_speak.bind(this),this.post_event_self_stop_speak=function(s){this.log(1,"post_event_self_stop_speak gid:",this.gid);var t=new Object;t.gid=this.gid,t.uid=this.myuid;var i=this.ctx.cache.get_group_session_by_gid(this.gid);i&&i.gid>0&&(t.gname=i.name);var e=this.ctx.cache.get_user(this.myuid);e&&e.uid>0&&(t.uname=e.name),t.audiotime=0,this.stream_out&&(this.stream_out.packet_count(),this.packet_frames),this.ctx.notify_cb(EVENT_STATUS.EN_SELF_SPEAKING_STOP,t)},this.post_event_self_stop_speak=this.post_event_self_stop_speak.bind(this),this.post_event_member_get_mic=function(){},this.post_event_member_get_mic=this.post_event_member_get_mic.bind(this),this.post_event_member_lost_mic=function(s,t,i,e,_){this.log(1,"post_event_member_lost_mic gid:",s);var o=new Object;o.gid=s,o.uid=t,o.sid=i,o.uname=e;var n=this.ctx.cache.get_group_session_by_gid(s);o.type=GROUP_TYPE.GROUP_STATIC,null!=n&&n.gid>0&&(o.gname=n.name,o.type=n.type),o.elapsedms=_,o.size=0,this.stream_in&&(o.size=this.stream_in.packet_buf_size()),console.log("somebody uid:",t,"start speak in gid:",s,"sid:",i),this.log(1,"somebody speaker:",t),this.log(1,"start speak in gid:",s),this.log(1,"sid:",i),this.ctx.notify_cb(EVENT_STATUS.EN_MEMBER_LOST_MIC,o)},this.post_event_member_lost_mic=this.post_event_member_lost_mic.bind(this),this.on_member_speak_active_timer=function(){this.log(1,"on_member_speak_active_timer gid:");var s=current_time_millisec();if(s-this.tv_last_write>=5e3&&this.send_heartbeat(self),console.log("status:",this.status,"time:",s-this.tv_recv_member_audio),this.log(1,"status:",this.status),this.log(1,"time:",s-this.tv_recv_member_audio),this.status==SESSION_STATUS.SESSION_STATUS_LISTENING&&s-this.tv_recv_member_audio>=2e3){var t=this.stream_in.packet_count()*this.packet_frames*20;console.log("Wait packet expired! speaking_member:",this.speaker,"elapsed_ms:",t),this.log(1,"Wait packet expired! speaking_member:",this.speaker),this.log(1,"elapsed_ms:",t),this.session_signal(SESSION_SIGNAL.SESSION_SIG_MEMBER_LOST_MIC)}},this.on_member_speak_active_timer=this.on_member_speak_active_timer.bind(this),this.start_member_speak_active=function(){this.log(1,"start_member_speak_active"),this.member_speak_actived||(this.member_speak_actived=!0,this.member_speak_active_timer=setTimeout(this.on_member_speak_active_timer,1e3))},this.start_member_speak_active=this.start_member_speak_active.bind(this),this.stop_member_speak_active=function(){this.log(1,"stop_member_speak_active"),this.member_speak_actived&&(this.member_speak_actived=!1,clearTimeout(this.member_speak_active_timer))},this.stop_member_speak_active=this.stop_member_speak_active.bind(this),this.send_ignoretalk=function(){console.log("send_ignoretalk"),this.log(1,"send_ignoretalk"),this.ignore=!0},this.send_ignoretalk=this.send_ignoretalk.bind(this),this.on_sound_stop=function(){this.log(1,"on_sound_stop"),this.post_event_member_speaking_stop(this.gid,this.speaker),this.ctx.sound.play_tone(this.ctx.sound.tone.STOP_LISTEN),this.speaker=0,this.sid=0,this.tv_member_get_mic=0,this.current_session_playing=!1},this.on_sound_stop=this.on_sound_stop.bind(this),this.on_ostream_notify=function(s){switch(s){case 2:this.tv_last_write=current_time_millisec();break;case 1:this.session_signal(SESSION_SIGNAL.SESSION_SIG_OSTREAM_STOP)}},this.on_ostream_notify=this.on_ostream_notify.bind(this),this.on_recorder_stop=function(){console.log("session_on_recorder_stop"),this.log(1,"session_on_recorder_stop"),this.stream_out.set_shutdown(),this.ctx.sound.play_tone(this.ctx.sound.tone.STOP_SPEAK)},this.session_action_none=function(s,t){return console.log("session_action_none session status:",s,"sig:",t),this.log(1,"session_action_none session status:",s,"sig:",t),0},this.session_action_none=this.session_action_none.bind(this),this.session_action_trap=function(s,t){return console.log("session_action_trap session status:",s,"sig:",t),this.log(1,"session_action_trap session status:",s,"sig:",t),0},this.session_action_trap=this.session_action_trap.bind(this),this.session_action_start=function(s,t){return console.log("session_action_start session status:",s,"sig:",t),this.log(1,"session_action_start session status:",s,"sig:",t),this.log(1,"session_action_start session gid:",this.gid),this.log(1,",is_listener:",this.is_listener),null!=this.address&&(this.conn=new WebConnect(this.ctx.config,this.notify_process,this.command_process,this.audio_process),this.conn.connect(this.address)),this.tv_last_watch_sync=0,this.tv_last_listen_sync=0,0},this.session_action_start=this.session_action_start.bind(this),this.session_action_connecting_2_idle=function(s,t){return console.log("session_action_connecting_2_idle session status:",s,"sig:",t),this.log(1,"session_action_connecting_2_idle session status:",s,"sig:",t),0},this.session_action_connecting_2_idle=this.session_action_connecting_2_idle.bind(this),this.session_send_continuetalk=function(s,t){this.ignore=!1},this.session_send_continuetalk=this.session_send_continuetalk.bind(this),this.session_action_on_member_get_mic=function(s,t){console.log("session_action_on_member_get_mic session status:",s,"sig:",t),this.log(1,"session_action_on_member_get_mic session status:",s,"sig:",t),this.log(1,"session_sig:",t);var i=this.priority;return this.status==SESSION_STATUS.SESSION_STATUS_SPEAKING?(console.log("session_is_speaking return"),this.log(1,"session_is_speaking return"),0):(console.log("this.ctx.cache.get_group_session_by_gid(this.gid)",this.ctx.cache.get_group_session_by_gid(this.gid)),this.log(1,"this.ctx.cache.get_group_session_by_gid(this.gid)",this.ctx.cache.get_group_session_by_gid(this.gid)),this.group_type=this.ctx.cache.get_group_session_by_gid(this.gid).type,console.log("this.priority:",this.priority,"is_member:",this.is_member),this.log(1,"this.priority:",this.priority),this.log(1,"current_priority:",i),this.log(1,"is_member:",this.is_member),console.log("this.group_type:",this.group_type),this.log(1,"this.group_type:",this.group_type),this.group_type==GROUP_TYPE.GROUP_SESSION&&(i=this.ctx.focus.PriorityType.SESSION_SESSION_GROUP_PRIORITY),this.ctx.sessionset.is_speaking()?(this.log(1,"session_action_on_member_get_mic"," now is speaking, do not play other audio."),this.send_continuetalk(),0):(console.log("PLAY_REQUESTOR",0),console.log("current_priority",i),this.log(1,"PLAY_REQUESTOR",0),this.log(1,"current_priority",i),this.ctx.focus.require(this,0,i,this.on_play_focus_notify)?(this.has_play_focus=!0,this.ctx.sound.stop_all(),this.ctx.sound.play_tone(this.ctx.sound.tone.START_LISTEN),current_time_millisec()-this.tv_last_write>5e3&&this.send_continuetalk(),this.speaker=this.speaker_tmp,this.start_member_speak_active(),this.session_signal(SESSION_SIGNAL.SESSION_SIG_GET_PLAY_FOCUS)):this.send_ignoretalk(self),0))},this.session_action_on_member_get_mic=this.session_action_on_member_get_mic.bind(this),this.session_on_play_focus_notify=function(s,t){focus?(this.has_play_focus=!0,this.speaker=this.speaker_tmp):this.has_play_focus=!1},this.session_action_on_member_lost_mic=function(s,t){console.log("session_action_on_member_lost_mic session status:",s,"sig:",t),this.log(1,"session_action_on_member_lost_mic session status:",s),this.log(1,"sig:",t);var i=this.ctx.focus.current_requestor(),e=this.ctx.focus.current_status();if(console.log("f_current",i,"f_status:",e,"PLAY_REQUESTOR",0),this.log(1,"session_f_current",i),this.log(1,"session_f_status:",e),this.log(1,"session_PLAY_REQUESTOR",0),i&&i.gid==this.gid&&0==e){if(this.status==SESSION_STATUS.SESSION_STATUS_SPEAKING)return console.log("session_is_speaking return"),this.log(1,"session_is_speaking return"),0;this.has_play_focus=!1,this.stop_member_speak_active(),null!=this.stream_in&&this.stream_in.set_shutdown(),this.is_leaving,this.ctx.sound.stop_play(),this.on_sound_stop(),this.stream_in&&(this.stream_in.stop(),this.stream_in=null),console.log("member_lost_mic,async stop play with append frames  with leaving:",this.is_leaving),this.log(1,"member_lost_mic,async stop play with append frames  with leaving:",this.is_leaving)}else console.log("this.ctx.sound.action",this.ctx.sound.action),this.log(1,"this.ctx.sound.action",this.ctx.sound.action),console.log("this.ctx.sound.type.PLAY",this.ctx.sound.type.PLAY),this.log(1,"this.ctx.sound.type.PLAY",this.ctx.sound.type.PLAY),this.ctx.sound.action!=this.ctx.sound.type.PLAY&&(this.post_event_member_speaking_stop(this.gid,this.speaker),this.speaker=0,this.sid=0,this.tv_member_get_mic=0);return this.ctx.focus.release(this,0),0},this.session_action_on_member_lost_mic=this.session_action_on_member_lost_mic.bind(this),this.session_action_get_play_focus=function(s,t){return console.log("session_action_get_play_focus session status:",s,"sig:",t,"this.ignore",this.ignore),this.log(1,"session_action_get_play_focus session status:",s),this.log(1,"sig:",t),this.log(1,"this.ignore",this.ignore),this.ignore&&this.send_continuetalk(self),this.stream_in=new StreamIn(this.ctx),this.stream_in.start(),this.ctx.sound.start_play(),this.tv_recv_member_audio=current_time_millisec(),this.speaker=this.speaker_tmp,this.post_event_member_speaking_start(this.gid,this.speaker),this.current_session_playing=!0,0},this.session_action_get_play_focus=this.session_action_get_play_focus.bind(this),this.session_action_ignore_talk=function(s,t){return this.send_ignoretalk(),0},this.session_action_ignore_talk=this.session_action_ignore_talk.bind(this),this.session_send_ignoretalk=function(s,t){this.ignore=!0},this.session_send_ignoretalk=this.session_send_ignoretalk.bind(this),this.session_action_2_wait_mic=function(s,t){console.log("session_action_2_wait_mic session status:",s,"sig:",t),this.log(1,"session_action_2_wait_mic session status:",s),this.log(1,"sig:",t);var i=-1;if(this.speaker>0){var e=this.ctx.cache.get_user(this.speaker);null!=e&&(console.log("speaker role:",e.role),this.log(1,"speaker role:",e.role));var _=this.ctx.cache.get_myself();null!=_&&(console.log("myself role:",_.role),this.log(1,"myself role:",_.role));var o=this.ctx.cache.get_member_by_uid(this.gid,this.speaker),n=this.ctx.cache.get_member_by_uid(this.gid,this.myuid);if(null!=o&&null!=n&&o.priority>=n.priority)return console.log("priority: myself:",n.priority,"speak:",o.priority),this.log(1,"priority: myself:",n.priority),this.log(1,"speak:",o.priority),this.session_signal(SESSION_SIGNAL.SESSION_SIG_REFUSE_MIC),this.post_event_notify_error(ECHAT_ERR.REQMIC_IN_LOW_ROLE,0),console.log("u r in low role or no role!"),this.log(1,"u r in low role or no role!"),0}return 0!=this.send_request()?-1:(this.post_event_self_start_speak(0),this.ctx.sound.play_tone(this.ctx.sound.tone.type),this.ctx.sound.play_tone(this.ctx.sound.tone.START_SPEAK),0!=(i=this.ctx.sound.start_record())?(this.session_signal(SESSION_SIGNAL.SESSION_SIG_REFUSE_MIC),this.post_event_notify_error(ECHAT_ERR.RECORD_DEVICE,0),console.log("hal_sound_start_record result:",i),void this.log(1,"hal_sound_start_record result:",i)):0)},this.session_action_2_wait_mic=this.session_action_2_wait_mic.bind(this),this.session_send_request=function(s,t){},this.session_send_request=this.session_send_request.bind(this),this.session_update_record_quality=function(s,t){},this.session_update_record_quality=this.session_update_record_quality.bind(this),this.session_action_release_mic=function(s,t){return console.log("session_action_release_mic session status:",s,"sig:",t),this.log(1,"session_action_release_mic session status:",s),this.log(1,"sig:",t),this.send_release_mic(self),this.post_event_self_stop_speak(this.sid),0},this.session_action_release_mic=this.session_action_release_mic.bind(this),this.session_send_release_mic=function(s,t){this.log(1,"session_send_release_mic"),0!=this.tv_get_mic&&(this.tv_get_mic=0)},this.session_send_release_mic=this.session_send_release_mic.bind(this),this.session_on_request_mic_timeout=function(s,t){this.log(1,"session_on_request_mic_timeout"),this.udp_ping_expired_count++,this.udp_ping_expired_count},this.session_on_request_mic_timeout=this.session_on_request_mic_timeout.bind(this),this.session_action_lost_play_focus=function(s,t){return console.log("session_action_lost_play_focus session status:",s,"sig:",t),this.log(1,"session_action_lost_play_focus session status:",s),this.log(1,"sig:",t),this.ctx.sound.stop_play(),null!=this.stream_in&&(this.stream_in.stop(),this.stream_in=null),this.ignore||this.send_ignoretalk(),this.post_event_member_speaking_stop(this.gid,this.speaker),this.current_session_playing=!1,0},this.session_action_lost_play_focus=this.session_action_lost_play_focus.bind(this),this.session_action_trans_member_audio=function(s,t){return this.status==SESSION_STATUS.SESSION_STATUS_SPEAKING?(console.log("session_is_speaking return"),this.log(1,"session_is_speaking return"),0):GROUP_TYPE.GROUP_SESSION==this.group_type||this.get_listening_enable()?(this.stream_in?this.stream_in.write_packet(this.audio_packet):(console.error("status error stream_in not init"),this.log(2,"status error stream_in not init")),0):(console.log("this not lock group return"),this.log(1,"this not lock group return"),0)},this.session_action_trans_member_audio=this.session_action_trans_member_audio.bind(this),this.session_action_wait_mic_2_idle=function(s,t){return console.log("session_action_wait_mic_2_idle session status:",s,"sig:",t),this.log(1,"session_action_wait_mic_2_idle session status:",s),this.log(1,"sig:",t),null!=this.stream_out&&(this.stream_out.stop(),this.stream_out=null),this.ctx.sound.stop_all(),this.ctx.sound.play_tone(this.ctx.sound.tone.STOP_SPEAK),this.ctx.focus.release(this,this.RECORD_REQUESTOR),clearTimeout(this.request_mic_timeout_timer),this.post_event_self_stop_speak(0),0},this.session_action_wait_mic_2_idle=this.session_action_wait_mic_2_idle.bind(this),this.session_action_wait_mic_2_speak=function(s,t){return console.log("session_action_wait_mic_2_speak session status:",s,"sig:",t),this.log(1,"session_action_wait_mic_2_speak session status:",s),this.log(1,"sig:",t),null==this.stream_out&&(this.stream_out=new StreamOut(this.ctx,this.myuid,this.on_ostream_notify,this.conn)),0},this.session_action_wait_mic_2_speak=this.session_action_wait_mic_2_speak.bind(this),this.session_action_speak_refuse_mic=function(s,t){return console.log("session_action_speak_refuse_mic session status:",s,"sig:",t),this.log(1,"session_action_speak_refuse_mic session status:",s),this.log(1,"sig:",t),this.tv_get_mic=0,this.ctx.sound.stop_all(),this.ctx.sound.play_tone(this.ctx.sound.tone.ERROR),null!=this.stream_out&&(this.stream_out.stop(),this.stream_out=null),this.ctx.focus.release(this,this.RECORD_REQUESTOR),this.post_event_self_stop_speak(this.sid),0},this.session_action_speak_refuse_mic=this.session_action_speak_refuse_mic.bind(this),this.session_action_speak_lost_mic=function(s,t){console.log("session_action_speak_lost_mic session status:",s,"sig:",t),this.log(1,"session_action_speak_lost_mic session status:",s),this.log(1,"sig:",t),this.tv_get_mic=0;var i=this.sid;return this.sid=0,this.ctx.sound.stop_all(),this.ctx.sound.play_tone(this.ctx.sound.tone.STOP_SPEAK),null!=this.stream_out&&(this.stream_out.stop(),this.stream_out=null),this.ctx.focus.release(this,this.RECORD_REQUESTOR),this.post_event_self_stop_speak(i),0},this.session_action_speak_lost_mic=this.session_action_speak_lost_mic.bind(this),this.session_action_speak_2_suf=function(s,t){return console.log("session_action_speak_2_suf session status:",s,"sig:",t),console.log("gid:",this.gid,"is_leaving:",this.is_leaving),this.log(1,"gid:",this.gid),this.log(1,"is_leaving:",this.is_leaving),null!=this.stream_out&&this.stream_out.is_output()&&!this.is_leaving?this.ctx.sound.async_stop_record(this.on_recorder_stop):(this.ctx.sound.stop_record(),this.ctx.sound.play_tone(this.ctx.sound.tone.STOP_SPEAK),this.post_event_self_stop_speak(this.sid),this.session_signal(SESSION_SIGNAL.SESSION_SIG_OSTREAM_STOP)),0},this.session_action_speak_2_suf=this.session_action_speak_2_suf.bind(this),this.session_action_speak_2_idle=function(s,t){return console.log("session_action_speak_2_idle session status:",s,"sig:",t),this.log(1,"session_action_speak_2_idle session status:",s),this.log(1,"sig:",t),console.log("gid:",this.gid),this.log(1,"gid:",this.gid),this.ctx.sound.stop_record(),this.ctx.sound.play_tone(this.ctx.sound.tone.ERROR),this.post_event_self_stop_speak(this.sid),this.ctx.focus.release(this,this.RECORD_REQUESTOR),this.send_release_mic(),null!=this.stream_out&&(this.stream_out.stop(),this.stream_out=null),0},this.session_action_speak_2_idle=this.session_action_speak_2_idle.bind(this),this.session_action_speak_suf_2_idle=function(s,t){return console.log("session_action_speak_suf_2_idle session status:",s,"sig:",t),this.log(1,"session_action_speak_suf_2_idle session status:",s),this.log(1,"sig:",t),this.post_event_self_stop_speak(this.sid),this.ctx.focus.release(this,this.RECORD_REQUESTOR),this.send_release_mic(),null!=this.stream_out&&(this.stream_out.stop(),this.stream_out=null),0},this.session_action_speak_suf_2_idle=this.session_action_speak_suf_2_idle.bind(this),this.trans_table=[[{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_start},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_INIT,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap}],[{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_connecting_2_idle},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_CONNECTING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap}],[{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_on_member_get_mic},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_on_member_lost_mic},{next:SESSION_STATUS.SESSION_STATUS_LISTENING,action:this.session_action_get_play_focus},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_ignore_talk},{next:SESSION_STATUS.SESSION_STATUS_WAIT_MIC,action:this.session_action_2_wait_mic},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_release_mic},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap}],[{next:SESSION_STATUS.SESSION_STATUS_LISTENING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_LISTENING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_LISTENING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_on_member_lost_mic},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_lost_play_focus},{next:SESSION_STATUS.SESSION_STATUS_LISTENING,action:this.session_action_trans_member_audio},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_LISTENING,action:this.session_action_release_mic},{next:SESSION_STATUS.SESSION_STATUS_LISTENING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_LISTENING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap}],[{next:SESSION_STATUS.SESSION_STATUS_WAIT_MIC,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_WAIT_MIC,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_WAIT_MIC,action:this.session_action_on_member_get_mic},{next:SESSION_STATUS.SESSION_STATUS_WAIT_MIC,action:this.session_action_on_member_lost_mic},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_lost_play_focus},{next:SESSION_STATUS.SESSION_STATUS_WAIT_MIC,action:this.session_action_ignore_talk},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_wait_mic_2_idle},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_wait_mic_2_idle},{next:SESSION_STATUS.SESSION_STATUS_SPEAKING,action:this.session_action_wait_mic_2_speak},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_speak_refuse_mic},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_speak_lost_mic},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap}],[{next:SESSION_STATUS.SESSION_STATUS_SPEAKING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_SPEAKING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_SPEAKING,action:this.session_action_on_member_get_mic},{next:SESSION_STATUS.SESSION_STATUS_SPEAKING,action:this.session_action_on_member_lost_mic},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_SPEAKING,action:this.session_action_ignore_talk},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_SUF_SPEAK,action:this.session_action_speak_2_suf},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_speak_2_idle},{next:SESSION_STATUS.SESSION_STATUS_SPEAKING,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_speak_refuse_mic},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_speak_lost_mic},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap}],[{next:SESSION_STATUS.SESSION_STATUS_SUF_SPEAK,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_SUF_SPEAK,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_SUF_SPEAK,action:this.session_action_on_member_get_mic},{next:SESSION_STATUS.SESSION_STATUS_SUF_SPEAK,action:this.session_action_on_member_lost_mic},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_SUF_SPEAK,action:this.session_action_ignore_talk},{next:SESSION_STATUS.SESSION_STATUS_TRAP,action:this.session_action_trap},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_speak_suf_2_idle},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_speak_2_idle},{next:SESSION_STATUS.SESSION_STATUS_SUF_SPEAK,action:this.session_action_none},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_speak_refuse_mic},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_speak_lost_mic},{next:SESSION_STATUS.SESSION_STATUS_IDLE,action:this.session_action_speak_suf_2_idle}]],this.session_signal=function(s){this.log(1,"session_signal");var t=this.status;return this.status=this.trans_table[t][s].next,console.log("session_signal current status:",t,"next:",this.trans_table[t][s].next,"sig:",s),this.status,this.trans_table[t][s].action(t,s)},this.session_signal=this.session_signal.bind(this),this.on_active_timer=function(){console.log("status:",this.status,"is_listener:",this.is_listener,"is_member:",this.is_member),this.log(1,"status:",this.status),this.log(1,"is_listener:",this.is_listener),this.log(1,"is_member:",this.is_member),current_time_millisec()-this.tv_last_read>=3e3&&(this.is_listener&&this.send_listen_req(),this.is_member&&this.send_ping()),this.status==SESSION_STATUS.SESSION_STATUS_IDLE&&this.session_stop_active()},this.on_active_timer=this.on_active_timer.bind(this),this.session_start_active=function(){this.log(1,"session_start_active"),this.actived||(this.actived=!0,this.active_timer=setInterval(this.on_active_timer,1e3))},this.session_start_active=this.session_start_active.bind(this),this.session_stop_active=function(){this.log(1,"session_stop_active"),this.actived&&(this.actived=!1,clearInterval(this.active_timer))},this.session_stop_active=this.session_stop_active.bind(this),this.session_on_msg_requestmic=function(s){console.log("ChatGroup RequestMicAck result:",s.result),this.ctx.notify_cb(EVENT_STATUS.RR_REQUEST_MIC_ACK,null),this.udp_ping_expired_count=0,clearTimeout(this.request_mic_timeout_timer),console.log("result:",s.result,"sid:",s.sid,"gid:",s.gid,"this.myuid:",this.myuid,"this.gid:",this.gid,"this.status:",this.status),this.log(1,"result:",s.result),this.log(1,"sid:",s.sid),this.log(1,"gid:",s.gid),this.log(1,"this.myuid:",this.myuid),this.log(1,"this.gid:",this.gid),this.log(1,"this.status:",this.status),0===s.result&&(s.gid>0&&s.gid==this.gid||this.status==SESSION_STATUS.SESSION_STATUS_WAIT_MIC?(this.tv_get_mic=current_time_millisec(),this.sid=s.sid,this.session_signal(SESSION_SIGNAL.SESSION_SIG_GET_MIC)):(this.sid=0,this.session_signal(SESSION_SIGNAL.SESSION_SIG_REFUSE_MIC),this.post_event_notify_error(ECHAT_ERR.REQMIC_REFUSED,0),console.log("requestmic failed!result:",s.result),this.log(1,"requestmic failed!result:",s.result)))},this.session_on_msg_requestmic=this.session_on_msg_requestmic.bind(this),this.session_on_msg_releasemic=function(s){console.log("ChatGroup ReleaseMicAck result:",s.result),this.log(1,"ChatGroup ReleaseMicAck result:",s.result),this.ctx.notify_cb(EVENT_STATUS.RR_RELEASE_MIC_ACK,null)},this.session_on_msg_releasemic=this.session_on_msg_releasemic.bind(this),this.session_on_msg_memgetmic=function(s){if(console.log("ChatGroup MemberGetMic gid:",s.gid,"uid:",s.uid,"sid:",s.sid,"this.gid:",this.gid,"speaker:",this.speaker,"this.sid:",this.sid,"payload:",s.payload,"name:",s.name),this.recv_audio_size=0,console.log("is_listener:",this.is_listener,"this.myuid:",this.myuid),this.log(1,"session_on_msg_memgetmic is_listener:",this.is_listener),this.log(1,"session_on_msg_memgetmic this.myuid:",this.myuid),this.log(1,"session_on_msg_memgetmice","gid:"+s.gid+"name:"+s.name+", payload:"+s.payload+", sid:"+s.sid+", uid:"+s.uid),s.gid!=this.gid)return console.log("speak group not current or listened."),void this.log(1,"speak group not current or listened.");var t,i=new Object;if(i.gid=s.gid,i.uid=s.uid,i.sid=s.sid,i.uname=s.name,null!=(t=this.ctx.cache.get_group_session_by_gid(s.gid))&&t.gid>0&&(i.gname=t.name,i.type=t.type),i.connecttime=current_time_millisec(),console.log("somebody uid:",s.uid,"start speak in gid:",s.gid,"sid:",s.sid),this.log(1,"session somebody uid:",s.uid),this.log(1,"session start speak in gid:",s.gid),this.log(1,"session sid:",s.sid),this.ctx.notify_cb(EVENT_STATUS.EN_MEMBER_GET_MIC,i),null!=(t=this.ctx.cache.get_group_session_by_gid(this.gid))&&1==t.dnd_enabled)return console.log("myself current gid:",this.gid,"already dnd enable!"),void this.log(1,"already dnd enable! myself current gid:",this.gid,"already dnd enable!");s.uid!=this.myuid&&s.gid===this.gid&&(this.speaker&&this.speaker!=s.uid&&(this.session_signal(SESSION_SIGNAL.SESSION_SIG_MEMBER_LOST_MIC),this.speaker=0),this.status==SESSION_STATUS.SESSION_STATUS_SPEAKING&&(console.log("add lost mic session."),this.log(1,"add lost mic session."),this.session_signal(SESSION_SIGNAL.SESSION_SIG_LOST_MIC)),this.speaker!=s.uid?(this.speaker_name=s.name,this.speaker_tmp=s.uid,this.speaker=s.uid,this.sid=s.sid,this.ignore=!1,this.tv_last_member_get_mic=this.tv_member_get_mic=current_time_millisec(),this.session_signal(SESSION_SIGNAL.SESSION_SIG_MEMBER_GET_MIC)):this.is_listener?(console.log("reset speaker:",this.speaker,"to new:",s.uid),this.log(1,"session reset speaker:",this.speaker),this.log(1,"session to new:",s.uid),this.speaker_name=s.name,this.speaker_tmp=s.uid,this.speaker=s.uid,this.tv_last_member_get_mic=this.tv_member_get_mic=current_time_millisec(),this.session_signal(SESSION_SIGNAL.SESSION_SIG_MEMBER_GET_MIC)):(this.session_signal(SESSION_SIGNAL.SESSION_SIG_MEMBER_LOST_MIC),this.speaker=0,this.speaker_tmp=s.uid,this.speaker_name=s.name,this.sid=s.sid,this.ignore=!1,this.tv_last_member_get_mic=this.tv_member_get_mic=current_time_millisec(),this.session_signal(SESSION_SIGNAL.SESSION_SIG_MEMBER_GET_MIC)))},this.session_on_msg_memgetmic=this.session_on_msg_memgetmic.bind(this),this.session_on_msg_memlostmic=function(s){if(this.log(1,"session_on_msg_memlostmic 释放话权",s.gid),this.log(1,"session_on_msg_memlostmic","gid:"+s.gid+"name:"+s.name+", payload:"+s.payload+", sid:"+s.sid+", uid:"+s.uid),console.log("gid:",s.gid,"uid:",s.uid,"sid:",s.sid,"this.gid:",this.gid,"this.speaker:",this.speaker,"this.sid:",this.sid,"payload:",s.payload,"name:",s.name,"this.myuid",this.myuid),s.gid!=this.gid)return console.log("speak group not current."),void this.log(1,"speak group not current.");var t=0;null!=s.speech_info&&(console.log("media_bytes:",s.speech_info.media_bytes,"pkg_count:",s.speech_info.pkg_count),this.log(1,"media_bytes:",s.speech_info.media_bytes),this.log(1,"pkg_count:",s.speech_info.pkg_count),t=s.speech_info.elapsed_ms),this.post_event_member_lost_mic(s.gid,s.uid,s.sid,s.name,t);var i=this.ctx.cache.get_group_session_by_gid(this.gid);if(null!=i&&1==i.dnd_enabled)return console.log("myself current gid:",this.gid," already dnd enable!"),void this.log(1,"already dnd enable:",this.gid," already dnd enable!");s.uid!=this.myuid&&s.gid==this.gid&&s.uid==this.speaker&&this.session_signal(SESSION_SIGNAL.SESSION_SIG_MEMBER_LOST_MIC)},this.session_on_msg_memlostmic=this.session_on_msg_memlostmic.bind(this),this.session_on_msg_lostmic=function(s){console.log("ChatGroup LostMic gid:",s.gid,"uid:",s.uid,"sid:",s.sid,"reason:",s.reason),this.log(1,"session 摘麦 ChatGroup LostMic gid:",s.gid),this.log(1,"session 摘麦 uid:",s.uid),this.log(1,"session 摘麦 reason:",s.reason),console.log("this.gid:",this.gid,"this.speaker:",this.speaker),s.gid==this.gid&&0==this.speaker&&(this.session_signal(SESSION_SIGNAL.SESSION_SIG_LOST_MIC),0==s.reason?this.post_event_notify_error(ECHAT_ERR.SPEAKING_ROBBED,this.sid):2==s.reason&&this.post_event_notify_error(ECHAT_ERR.SPEAKING_TIMEOUT,0))},this.session_on_msg_lostmic=this.session_on_msg_lostmic.bind(this),this.session_on_msg_listenack=function(s){console.log("ChatGroup ListenAck gid:",s.gid,"uid:",s.uid),this.log(1,"ChatGroup ListenAck gid:",s.gid),this.log(1,"uid:",s.uid),this.tv_last_listen_sync=current_time_millisec(),this.session_signal(SESSION_SIGNAL.SESSION_SIG_ALIVE),this.aud_listen_retry_count=0,console.log("result:",s.result,"gid:",s.gid,"this.gid:",this.gid,"is_listener:",this.is_listener),clearTimeout(this.listen_group_timeout_timer)},this.session_on_msg_listenack=this.session_on_msg_listenack.bind(this),this.session_on_msg_unlistenack=function(s){console.log("ChatGroup UnListenAck gid:",s.gid,"uid:",s.uid),this.log(1,"ChatGroup UnListenAck gid:",s.gid),this.log(1,"uid:",s.uid)},this.session_on_msg_unlistenack=this.session_on_msg_unlistenack.bind(this),this.on_pong=function(s){if(console.log("ChatGroup Pong"),this.log(1,"ChatGroup Pong"),this.ctx.notify_cb(EVENT_STATUS.NET_RECV_PONG,null),this.udp_ping_expired_count=0,clearTimeout(this.ping_timeout_timer),s.timestamp>0){var t=current_time_millisec()-s.timestamp;console.log("gid:",this.gid,"diff:",t),this.log(1,"gid:",this.gid),this.log(1,"diff:",t)}else console.log("gid:",this.gid," not timestamp!"),this.log(1,"not timestamp!",this.gid," ");this.session_signal(SESSION_SIGNAL.SESSION_SIG_ALIVE)},this.on_pong=this.on_pong.bind(this),this.dispatcher={"et.aud.RequestAck":this.session_on_msg_requestmic,"et.aud.ReleaseAck":this.session_on_msg_releasemic,"et.aud.MemberGetMic":this.session_on_msg_memgetmic,"et.aud.MemberLostMic":this.session_on_msg_memlostmic,"et.aud.LostMic":this.session_on_msg_lostmic,"et.aud.ListenAck":this.session_on_msg_listenack,"et.aud.UnListenAck":this.session_on_msg_unlistenack,"et.net.Pong":this.on_pong}};Session.prototype.destroy=function(){console.log("session_destroy gid:",this.gid),this.log(1,"session_destroy gid:",this.gid),this.current_session_playing&&this.ctx.sound.stop_play(),clearTimeout(this.request_mic_timeout_timer),clearTimeout(this.ping_timeout_timer),this.session_stop_active(),this.stop_member_speak_active(),this.unlisten(),this.leave(),null!=this.conn&&this.conn.close()},Session.prototype.ping=function(){this.ctx.notify_cb(EVENT_STATUS.NET_SEND_PING,null);var s={};s.gid=this.gid,s.uid=this.myuid,s.seq=this.ping_seq++,this.send_message("et.net.Ping",s)},Session.prototype.bye_group=function(){console.log("ChatGroup ByeGroup gid:",this.gid,"uid:",this.myuid),this.log(1,"ChatGroup ByeGroup gid:",this.gid),this.log(1,"uid:",this.myuid),this.ctx.notify_cb(EVENT_STATUS.RR_BYE_GROUP,null);var s={};s.gid=this.gid,s.uid=this.myuid},Session.prototype.start_speak=function(){this.log(1,"start_speak 请求话权",this.priority),console.log("请求话权");var s=this.priority;this.send_audio_size=0,this.send_audio_frame=0;let t=this.ctx.cache.get_group_by_gid_self(this.gid);if(null==t||0==t.gid)return console.log("start speak cache no find gid=",this.gid),this.log(1,"start speak cache no find gid=",this.gid),this.ctx.sound.play_tone(this.ctx.sound.tone.ERROR),this.post_event_notify_error(ECHAT_ERR.REQMIC_REFUSED,0),-1;let i=this.ctx.cache.get_audio_enabled(),e=t.audioEnabled;if(!(i&&e||t.type==GROUP_TYPE.GROUP_SESSION||5==t.type))return console.log("u r in audio_enable:",i,", g.audio_enabled:",e),this.log(1,"u r in audio_enable:",i),this.log(1,"g.audio_enabled:",e),this.ctx.sound.play_tone(this.ctx.sound.tone.ERROR),this.post_event_notify_error(ECHAT_ERR.REQMIC_IN_AUDIOENABLE,0),-1;if(console.log("bad status:",this.status),this.log(1,"bad status:",this.status),this.status!=SESSION_STATUS.SESSION_STATUS_IDLE&&this.status!=SESSION_STATUS.SESSION_STATUS_LISTENING)return this.status==SESSION_STATUS.SESSION_STATUS_CONNECTING&&(console.log("session is try to active connection ..."),this.log(1,"session is try to active connection ..."),this.ping(),this.speak_status_connecting_count++,this.speak_status_connecting_count>=4&&(this.speak_status_connecting_count=0)),this.ctx.sound.play_tone(this.ctx.sound.tone.ERROR),this.post_event_notify_error(ECHAT_ERR.REQMIC_IN_ERR_SSTATE,0),-1;if(this.speak_status_connecting_count=0,0!=this.tv_get_mic)return console.log("tv_get_mic is not zero!:"),this.log(1,"tv_get_mic is not zero!:"),-1;console.log("speak gid=",this.gid),this.log(1,"speak gid=",this.gid);var _=current_time_millisec();if(_-this.tv_last_try_speak<500)return console.log("u requested mic more one time in 500ms!"),this.log(1,"u requested mic more one time in 500ms!"),this.ctx.sound.play_tone(this.ctx.sound.tone.ERROR),-1;if(this.speaker>0){var o=this.ctx.cache.get_user_by_uid(this.speaker);o.uid>0&&(console.log("speaker role :",o.role),this.log(1,"speaker role :",o.role));var n=this.ctx.cache.get_myself();null!=n&&(console.log("myself role :",n.role),this.log(1,"myself role :",n.role));let s=this.ctx.cache.get_member_by_uid(this.gid,this.speaker),t=this.ctx.cache.get_member_by_uid(this.gid,this.myuid);if(null!=s&&null!=t&&s.priority>=t.priority)return console.log("priority: myself:",t.priority,"speak:",s.priority),this.ctx.sound.play_tone(this.ctx.sound.tone.ERROR),this.post_event_notify_error(ECHAT_ERR.REQMIC_IN_LOW_ROLE,0),console.log("r in low priority or euqual priority!"),this.log(1,"r in low priority or euqual priority!"),-1}console.log("this.priority:",this.priority),this.log(1,"this.priority:",this.priority);var S=this.ctx.sessionset.is_listening(),h=this.ctx.focus.current_priority();if(console.log("is_listening:",S,"current_priority priority:",s),console.log("focus_priority:",h,"current_priority priority:",s),this.log(1,"is_listening:",S),this.log(1,"current_priority priority:",s),this.log(1,"focus_priority:",h),S){if(console.log("临时提升讲话焦点为最高"),t.type==GROUP_TYPE.GROUP_SESSION||5==t.type)return this.log(1,"start_speak","current group is session and is listening"),-1;console.log("临时提升讲话焦点为最高"),this.log(1,"临时提升讲话焦点为最高"),s=this.ctx.focus.PriorityType.SESSION_SPEAKING_GROUP_PRIORITY}return console.log("current_priority:",s),this.ctx.focus.require_nowait(this,this.RECORD_REQUESTOR,s,this.on_record_focus_notify)?(console.assert(this.status===SESSION_STATUS.SESSION_STATUS_IDLE),console.log("requested mic success!"),this.has_record_focus=!0,this.tv_last_try_speak=_,this.session_signal(SESSION_SIGNAL.SESSION_SIG_START_SPEAK)):(console.log("u requested mic but audio focus was requested failed!"),this.ctx.sound.play_tone(this.ctx.sound.tone.ERROR),this.post_event_notify_error(ECHAT_ERR.REQMIC_NO_AUDIOFOCUS,0),-1)},Session.prototype.stop_speak=function(){return console.log("释放话权"),this.log(1,"释放话权"),console.log("status:",this.status),this.status===SESSION_STATUS.SESSION_STATUS_SPEAKING||this.status===SESSION_STATUS.SESSION_STATUS_WAIT_MIC?(this.has_record_focus=!1,this.session_signal(SESSION_SIGNAL.SESSION_SIG_STOP_SPEAK)):-1},Session.prototype.listen=function(){return this.log(1,"listen"),this.is_listener=!0,this.status!=SESSION_STATUS.SESSION_STATUS_INIT&&this.status!=SESSION_STATUS.SESSION_STATUS_CONNECTING&&this.send_listen_req(),this.session_start_active(),this.session_signal(SESSION_SIGNAL.SESSION_SIG_START)},Session.prototype.unlisten=function(){if(this.is_listener){clearTimeout(this.listen_group_timeout_timer);var s={};return s.gid=this.gid,s.uid=this.myuid,this.send_message("et.aud.UnListen",s),this.is_listener=!1,this.is_member||(console.log("session status:",this.status," speaker",this.speaker),this.log(1,"session status:",this.status),this.log(1," speaker",this.speaker),this.status==SESSION_STATUS.SESSION_STATUS_LISTENING&&(this.post_event_member_speaking_stop(this.gid,this.speaker),this.post_event_member_lost_mic(this.gid,this.speaker,this.sid,this.speaker_name,0)),this.status==SESSION_STATUS.SESSION_STATUS_SPEAKING||(this.status,SESSION_STATUS.SESSION_STATUS_WAIT_MIC),this.shutdown()),this.log(1,"unlisten :",0),0}return this.log(1,"unlisten :",-1),-1},Session.prototype.join=function(){return console.log("进入群组join"),this.log(1,"进入群组join"),this.is_member=!0,this.session_start_active(),this.session_signal(SESSION_SIGNAL.SESSION_SIG_START)},Session.prototype.leave=function(){if(this.log(1,"leave"),!this.is_member)return-1;this.is_leaving=!0,this.status===SESSION_STATUS.SESSION_STATUS_SPEAKING||(this.status,SESSION_STATUS.SESSION_STATUS_WAIT_MIC),console.log("status:",this.status,"is_listener:",this.is_listener),this.status!==SESSION_STATUS.SESSION_STATUS_LISTENING||this.is_listener||this.session_signal(SESSION_SIGNAL.SESSION_SIG_MEMBER_LOST_MIC),this.is_member=!1,this.is_watcher||this.is_listener||this.shutdown()},Session.prototype.is_speaking=function(){return this.log(1,"is_speaking :","status:"+this.status),this.status==SESSION_STATUS.SESSION_STATUS_SPEAKING||this.status==SESSION_STATUS.SESSION_STATUS_SUF_SPEAK},Session.prototype.is_listening=function(){return console.log("session is_listening:",this.status),console.log("session is_listening:",SESSION_STATUS.SESSION_STATUS_LISTENING),this.log(1,"is_listening :","status:"+this.status),this.status==SESSION_STATUS.SESSION_STATUS_LISTENING},Session.prototype.get_speaker=function(){return this.log(1,"get_speaker :","speaker:"+this.speaker),this.speaker},Session.prototype.get_gid=function(){return this.log(1,"get_gid :","gid:"+this.gid),this.gid},Session.prototype.get_addr=function(){return this.log(1,"get_addr :","address:"+this.address),this.address},Session.prototype.is_listen=function(){return this.log(1,"is_listen :","is_listen:"+this.is_listen),this.is_listener},Session.prototype.get_is_member=function(){return this.log(1,"get_is_member :",this.is_member),this.is_member},Session.prototype.set_locked_gid=function(s){this.log(1,"set_locked_gid :","gid:"+s),this.locked_gid=s},Session.prototype.update_priority=function(s,t){return s==this.gid?(this.priority=t+this.ctx.focus.PriorityType.SESSION_SPEAK_PRIOR_BASE,5!=this.group_type&&this.group_type!=GROUP_TYPE.GROUP_SESSION||(this.priority=this.ctx.focus.PriorityType.SESSION_SESSION_GROUP_PRIORITY),this.log(1,"update_priority:",":0,gid :"+s+",priority:"+t+",this.priority:"+this.priority+",this.group_type:",this.group_type),0):(this.log(1,"update_priority:",":-1"),-1)},Session.prototype.session_on_keepalive_timer=function(){this.log(1,"session_on_keepalive_timer"," is_listener:"+this.is_listener+",is_member:"+this.is_member),this.is_listener?this.send_listen_req():this.send_ping()};export default Session;