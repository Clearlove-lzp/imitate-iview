import WebConnect from"../hal/web_connect.js";import event_status_total from"../common/event_status.js";import{current_time_millisec,current_time_sec}from"../common/helper.js";var WEB_CLIENT_VERSION="V1.0.0-20240926";const EVENT_STATUS=event_status_total.EVENT_STATUS;import{openLog,logInfo,warn,error}from"./log.js";var Connection=function(t){this.ctx=t,this.conn=null,this.tv_last_recv=0,this.conn_check_timer=null,this.command_process=function(t,n,i){this.log(1,"CONNECTION_msg_name",n),this.tv_last_recv=current_time_millisec();var o=this.dispatcher[n];"function"==typeof o&&o(i)},this.command_process=this.command_process.bind(this),this.log=function(t,n,i){switch(t){case 1:default:logInfo("Connection",n,i);break;case 2:warn("Connection",n,i);break;case 3:error("Connection",n,i)}},this.log=this.log.bind(this),this.notify_process=function(t,n){switch(this.tv_last_recv=current_time_millisec(),this.ctx.notify_cb(t,n),this.log(1,"CONNECTION_status",t),t.code){case EVENT_STATUS.WEBCONNECT_OPEN.code:this.log(1,"sdktest ===== open"),this.ctx.notify_cb(EVENT_STATUS.CONNECTED,n);break;case EVENT_STATUS.WEBCONNECT_CLOSE.code:this.log(1,"sdktest =====close"),this.ctx.notify_cb(EVENT_STATUS.DISCONNECT,n);break;case EVENT_STATUS.WEBCONNECT_ERROR.code:this.log(1,"sdktest =====error"),this.ctx.notify_cb(EVENT_STATUS.CONNECT_ERROR,n)}},this.notify_process=this.notify_process.bind(this),this.conn=new WebConnect(this.ctx.config,this.notify_process,this.command_process,null),this.connection_restart=function(){console.log("断开conn"),this.conn&&this.conn.close(),this.tv_last_recv=0;var t=this;clearInterval(this.conn_check_timer),setTimeout((()=>{console.log("Connection restart"),this.log(1,"Connection restart"),t.ctx.notify_cb(EVENT_STATUS.RECONNECT_LOGIN,null)}),5e3)},this.connection_restart=this.connection_restart.bind(this),this.conn_check=function(){var t=current_time_millisec();this.log(1,"Connection last_recv:",this.tv_last_recv),this.log("1","this.tv_last_recv",this.tv_last_recv),this.log("1","this.ctx.config.power.conn_timeout_sec",this.ctx.config.power.conn_timeout_sec),this.log("1","now",t),this.tv_last_recv+1e3*this.ctx.config.power.conn_timeout_sec<=t&&(this.log(1,"Connection restart 进入重新连接"),this.connection_restart())},this.conn_check=this.conn_check.bind(this),this.on_login_ack=function(t){this.log(1,"Connection LoginAck result:",t.result);var n={result:t.result,jmsg:t};if(this.ctx.notify_cb(EVENT_STATUS.RR_LOGIN_ACK,n),"SUCCESS"===t.result)this.log(1,"Connection Login uid:",t.self.uid),this.query_group(),this.get_watch_group();else{switch(t.result){case-1:this.ctx.notify_cb(EVENT_STATUS.ERROR_PASSWORD,null);break;case-2:this.ctx.notify_cb(EVENT_STATUS.ERROR_OUT_OF_SERVICE,null);break;case-3:this.ctx.notify_cb(EVENT_STATUS.ERROR_ACCOUNT_NOT_EXIST,null);break;case-4:this.ctx.notify_cb(EVENT_STATUS.ERROR_LOGIN_PRIVILEGE,null);break;case-5:this.ctx.notify_cb(EVENT_STATUS.ERROR_ACCOUNT_BIND_ERROR,null);break;case-6:this.ctx.notify_cb(EVENT_STATUS.ERROR_ACCOUNT_DISABLED,null);break;case 10:break;case 11:this.ctx.notify_cb(EVENT_STATUS.ERROR_ACCOUNT_TIME_OUT,null)}this.conn.close()}},this.on_login_ack=this.on_login_ack.bind(this),this.on_logout_ack=function(t){switch(this.log(1,"Connection LogoutAck result:",t.result),t.result){case 60:this.log(1,"主动消息：账号被锁定"),this.ctx.notify_cb(EVENT_STATUS.ERROR_ACCOUNT_LOCKOUT,null);break;case 61:this.log(1,"主动消息：终端被锁定"),this.ctx.notify_cb(EVENT_STATUS.ERROR_TERMINAL_LOCKOUT,null);break;case 62:this.log(1,"主动消息：机卡被锁定"),this.ctx.notify_cb(EVENT_STATUS.ERROR_TERMINAL_CARD_LOCK,null);break;case 63:this.log(1,"主动消息：没有配置账号信息"),this.ctx.notify_cb(EVENT_STATUS.ERROR_CONFIGURE_MISS,null)}this.ctx.notify_cb(EVENT_STATUS.RR_LOGOUT_ACK,null)},this.on_logout_ack=this.on_logout_ack.bind(this),this.on_query_group_ack=function(t){var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_QUERY_GROUP_ACK,n)},this.on_query_group_ack=this.on_query_group_ack.bind(this),this.on_join_group_ack=function(t){console.log("加入群组服务器回应:",t.result);var n={result:t.result,jmsg:t,gid:t.gid};this.log(1,"on_join_group_ack result:",t.result),this.ctx.notify_cb(EVENT_STATUS.RR_JOIN_GROUP_ACK,n),t.gid>0&&this.log(1,"gid:",t.gid)},this.on_join_group_ack=this.on_join_group_ack.bind(this),this.on_leave_group_ack=function(t){var n={result:t.result,jmsg:t,gid:t.gid};this.ctx.notify_cb(EVENT_STATUS.RR_LEAVE_GROUP_ACK,n),this.log(1,"Connection LeaveGroupAck result:",n)},this.on_leave_group_ack=this.on_leave_group_ack.bind(this),this.on_create_group_ack=function(t){this.log(1,"Connection CreateGroupAck result:",t.result);var n={result:t.result,jmsg:t,gid:t.gid};this.ctx.notify_cb(EVENT_STATUS.RR_CREATE_GROUP_ACK,n),t.group.gid>0&&(this.log(1,"Connection CreateGroupAck:",t.result),this.log(1,"gid:",t.gid),this.query_members(t.group.gid))},this.on_create_group_ack=this.on_create_group_ack.bind(this),this.on_delete_group_ack=function(t){this.log(1,"Connection DestroyGroupAck result:",t.result);var n={result:t.result,jmsg:t,gid:t.gid};this.ctx.notify_cb(EVENT_STATUS.RR_DELETE_CONVERSATION_ACK,n)},this.on_delete_group_ack=this.on_delete_group_ack.bind(this),this.on_query_members_ack=function(t){this.log(1,"Connection QueryMembersAck2 result:",t.result);var n={result:t.result,jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_QUERY_MEMBERS_ACK,n)},this.on_query_members_ack=this.on_query_members_ack.bind(this),this.on_single_call_ack=function(t){this.log(1,"Connection SingleCallAck result:",t.result),"SUCCESS"===t.result?this.ctx.notify_cb(EVENT_STATUS.RR_SINGLE_CALL_ACK,null):this.ctx.notify_cb(EVENT_STATUS.ERROR_SINGLE_CALL,null)},this.on_single_call_ack=this.on_single_call_ack.bind(this),this.on_call_ack=function(t){this.log(1,"Connection CallAck result:",t.result),"SUCCESS"===t.result?this.ctx.notify_cb(EVENT_STATUS.RR_CALL_ACK,null):this.ctx.notify_cb(EVENT_STATUS.ERROR_CALL,null)},this.on_call_ack=this.on_call_ack.bind(this),this.on_invite_ack=function(t){this.log(1,"Connection InviteAck result:",t.result);var n={result:t.result,jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_INVITE_ACK,n)},this.on_invite_ack=this.on_invite_ack.bind(this),this.on_cancel_invite_ack=function(t){this.log(1,"Connection CancelInviteAck result:",t.result);var n={result:t.result,jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_CANCEL_INVITE_ACK,n)},this.on_cancel_invite_ack=this.on_cancel_invite_ack.bind(this),this.on_response_invite_ack=function(t){this.log(1,"Connection ResponseInviteAck result:",t.result);var n={result:t.result,jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_RESPONSE_INVITE_ACK,n)},this.on_response_invite_ack=this.on_response_invite_ack.bind(this),this.on_get_watch_group_ack=function(t){this.log(1,"Connection GetWatchGroupAck result:",t.result);var n={result:t.result,jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_GET_WATCH_GROUP_ACK,n)},this.on_get_watch_group_ack=this.on_get_watch_group_ack.bind(this),this.on_listen_group_ack=function(t){this.log(1,"Connection WatchGroupExAck result:",t.result);var n={result:t.result,jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_LISTEN_GROUP_ACK,n)},this.on_listen_group_ack=this.on_listen_group_ack.bind(this),this.on_unlisten_group_ack=function(t){this.log(1,"Connection RemoveWatchGroupAck result:",t.result);var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_UNLISTEN_GROUP_ACK,n)},this.on_unlisten_group_ack=this.on_unlisten_group_ack.bind(this),this.push_deliver_changed=function(t){var n={result:t.result,jmsg:t};this.ctx.notify_cb(EVENT_STATUS.EN_GROUP_CHANGED_START,n)},this.push_deliver_changed=this.push_deliver_changed.bind(this),this.on_dispatch_ack=function(t){this.log(1,"Connection DispatchAck result:",t.result);var n={result:t.result,jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_DISPATCH_ACK,n)},this.on_dispatch_ack=this.on_dispatch_ack.bind(this),this.on_take_mic_ack=function(t){this.log(1,"Connection TakeMicAck result:",t.result);var n={result:t.result,jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_TAKE_MIC_ACK,n)},this.on_take_mic_ack=this.on_take_mic_ack.bind(this),this.on_configure_user_ack=function(t){this.log(1,"Connection ConfigureUserAck result:",t.result);var n={result:t.result,jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_USER_ACK,n)},this.on_configure_user_ack=this.on_configure_user_ack.bind(this),this.on_query_enterprise_group_ack=function(t){this.log(1,"Connection ConfigureUserAck result:",t.result);var n={result:t.result,jmsg:t};console.log("查询组织群组回应",n),this.ctx.notify_cb(EVENT_STATUS.RR_QUERY_ENTERPRISE_GROUP_ACK,n)},this.on_query_enterprise_group_ack=this.on_query_enterprise_group_ack.bind(this),this.on_users_changed=function(t){this.log(1,"Connection UsersChanged");var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_USERS_CHANGED,n)},this.on_users_changed=this.on_users_changed.bind(this),this.on_members_changed=function(t){this.log(1,"Connection MembersChanged"),t.gid&&this.log(1,"on_members_changed gid:"+t.gid+"joined:"+t.joined+"online.memberCount:"+t.online.memberCount+", online.memberCount:"+t.online.memberIngroup);var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_MEMBERS_CHANGED,n)},this.on_members_changed=this.on_members_changed.bind(this),this.on_group_list_changed=function(t){this.log(1,"Connection GroupListChanged");var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_GROUP_LIST_CHANGED,n)},this.on_group_list_changed=this.on_group_list_changed.bind(this),this.on_user_status_changed=function(t){this.log(1,"离线/上线通知");var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_ON_USER_STATUS_CHANGED,n)},this.on_user_status_changed=this.on_user_status_changed.bind(this),this.on_group_changed=function(t){console.log("----jmsg",t),this.log(1,"on_group_changed gid:"+t.group.gid+"status:"+t.group.session.status+"type:"+t.group.type);var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_ON_GROUP_CHANGED,n)},this.on_group_changed=this.on_group_changed.bind(this),this.on_deliver_changed=function(t){this.log(1,"on_deliver_changed timestamp:"+t.timestamp+"sender:"+t.sender+"msgName:"+t.msgName),t.msg&&(t.msg=function(t){let n=atob(t),i=n.length,o=new Uint8Array(i);for(let t=0;t<i;t++)o[t]=n.charCodeAt(t);return new TextDecoder("utf-8").decode(o)}(t.msg));var n={jmsg:t};n.jmsg.msg&&(console.log("除非基础尺寸"),this.ctx.notify_cb(EVENT_STATUS.PUSH_ON_DELIVER_CHANGED,n))},this.on_deliver_changed=this.on_deliver_changed.bind(this),this.on_change_password_ack=function(t){var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_CHANGE_PASSWORD_ACK,n)},this.on_change_password_ack=this.on_change_password_ack.bind(this),this.on_change_group_name_ack=function(t){var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_CHANGE_GROUP_NAME_ACK,n)},this.on_change_group_name_ack=this.on_change_group_name_ack.bind(this),this.on_set_group_max_speechtime_ack=function(t){var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_SET_GROUP_MAX_SPEECHTIME_ACK,n)},this.on_set_group_max_speechtime_ack=this.on_set_group_max_speechtime_ack.bind(this),this.on_member_priority_ack=function(t){var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_USER_PRECEDENCE,n)},this.on_member_priority_ack=this.on_member_priority_ack.bind(this),this.on_quit_group_changed=function(t){var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_QUIT_GROUP,n)},this.on_quit_group_changed=this.on_quit_group_changed.bind(this),this.on_stop_session_changed=function(t){t.gid&&this.log(1,"on_stop_session_changed gid:"+t.gid+"reason:"+t.reason+"uid:"+t.uid);var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_STOP_SESSION,n)},this.on_stop_session_changed=this.on_stop_session_changed.bind(this),this.on_start_session_ack=function(t){t.gid&&this.log(1,"on_start_session_ack gid:"+t.gid+"reason:"+t.result);var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_START_SESSION_ACK,n)},this.on_start_session_ack=this.on_start_session_ack.bind(this),this.on_stop_session_ack=function(t){this.log(1,"on_stop_session_ack result:"+t.result);var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_STOP_SESSION_ACK,n)},this.on_stop_session_ack=this.on_stop_session_ack.bind(this),this.on_response_session_ack=function(t){t.gid&&this.log(1,"on_response_session_ack gid:"+t.gid+"reason:"+t.reason+"accept:"+t.accept);var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_RESPONSE_SESSION_ACK,n)},this.on_response_session_ack=this.on_response_session_ack.bind(this),this.on_response_join_session_ack=function(t){var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_RESPONSE_JOIN_SESSION_ACK,n)},this.on_response_join_session_ack=this.on_response_join_session_ack.bind(this),this.on_update_user_chat_enable_ack=function(t){var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_UPDATE_USER_CHAT_ENABLE_ACK,n)},this.on_update_user_chat_enable_ack=this.on_update_user_chat_enable_ack.bind(this),this.on_disabled_user_ack=function(t){var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_DISABLED_USER_ACK,n)},this.on_disabled_user_ack=this.on_disabled_user_ack.bind(this),this.on_disabled_user_ack=function(t){var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.RR_ENABLED_USER_ACK,n)},this.on_disabled_user_ack=this.on_disabled_user_ack.bind(this),this.on_response_sessionse_ack=function(t){var n={jmsg:t};t.progress&&this.log(1,"on_response_sessionse_ack paytype:"+t.paytype+NaN+t.sid+", progress:"+t.progress,", isrecord:"+t.isrecord),this.ctx.notify_cb(EVENT_STATUS.RR_RESPONSE_SESSION,n)},this.on_response_sessionse_ack=this.on_response_sessionse_ack.bind(this),this.on_response_session_changed=function(t){this.log(1,"on_response_session_changed");var n={jmsg:t};t.gid&&this.log(1,"on_response_session_changed accept:"+t.accept+"gid:"+t.gid+"reason:"+t.reason+", uid:"+t.uid),this.ctx.notify_cb(EVENT_STATUS.PUSH_ON_RESPONSE_SESSION_CHANGED,n)},this.on_response_session_changed=this.on_response_session_changed.bind(this),this.on_request_join_session_changed=function(t){this.log(1,"请求加入会话通知");var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_ON_REQUEST_JOIN_SESSION_CHANGED,n)},this.on_request_join_session_changed=this.on_request_join_session_changed.bind(this),this.on_current_group=function(t){this.log(1,"Connection CurrentGroup"),this.log(1,"on_current_group gid:"+t.gid);var n={jmsg:t,gid:t.gid};this.ctx.notify_cb(EVENT_STATUS.PUSH_CURRENT_GROUP,n)},this.on_current_group=this.on_current_group.bind(this),this.on_response_invite=function(t){this.log(1,"Connection ResponseInvite");var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_RESPONSE_INVITE,n)},this.on_response_invite=this.on_response_invite.bind(this),this.on_invite=function(t){this.log(1,"Connection Invite",t);var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_INVITE,n)},this.on_invite=this.on_invite.bind(this),this.on_kickout=function(t){this.log(1,"Connection Kickout",t);var n={jmsg:t};this.ctx.notify_cb(EVENT_STATUS.PUSH_KICKOUT,n)},this.on_kickout=this.on_kickout.bind(this),this.on_pong=function(t){this.log(1,"Connection Pong"),this.ctx.notify_cb(EVENT_STATUS.NET_RECV_PONG,null)},this.on_pong=this.on_pong.bind(this),this.on_ping=function(t){this.log(1,"Connection recv Ping");var n=new Object;n.uid=t.uid,n.seq=t.seq,n.suspend=t.suspend,n.gid=t.gid,this.conn.send_cmd("et.net.Pong",n)},this.on_ping=this.on_ping.bind(this),this.frequency=1,this.on_restoration_ack=function(t){this.ctx.notify_cb(EVENT_STATUS.RR_RESTOR_ATION,t)},this.on_restoration_ack=this.on_restoration_ack.bind(this),this.set_member_top_ack=function(t){this.ctx.notify_cb(EVENT_STATUS.RR_SET_MEMBER_TOP_ACK,t)},this.set_member_top_ack=this.set_member_top_ack.bind(this),this.session_kick=function(t){this.ctx.notify_cb(EVENT_STATUS.ERROR_LOGIN_PRIVILEGE,t)},this.session_kick=this.session_kick.bind(this),this.SetGroupSpeakTimeAck_ack=function(t){this.ctx.notify_cb(EVENT_STATUS.UI_SET_GROUP_SPEAK_TIME_ACK,t)},this.SetGroupSpeakTimeAck_ack=this.SetGroupSpeakTimeAck_ack.bind(this),this.SetGroupPriorityAck_ack=function(t){this.ctx.notify_cb(EVENT_STATUS.UI_SET_GROUP_PRIORITY_ACK,t)},this.SetGroupPriorityAck_ack=this.SetGroupPriorityAck_ack.bind(this),this.dispatcher={"et.rr.LoginAck":this.on_login_ack,"et.rr.LogoutAck":this.on_logout_ack,"et.rr.QueryGroupAck":this.on_query_group_ack,"et.rr.JoinGroupAck":this.on_join_group_ack,"et.rr.LeaveGroupAck":this.on_leave_group_ack,"et.rr.QueryMembersAck":this.on_query_members_ack,"et.rr.CreateGroupAck":this.on_create_group_ack,"et.rr.DeleteSessionAck":this.on_delete_group_ack,"et.rr.SingleCallAck":this.on_single_call_ack,"et.rr.CallAck":this.on_call_ack,"et.rr.InviteAck":this.on_invite_ack,"et.rr.CancelInviteAck":this.on_cancel_invite_ack,"et.rr.ResponseInviteAck":this.on_response_invite_ack,"et.rr.QueryListenGroupAck":this.on_get_watch_group_ack,"et.rr.DispatchAck":this.on_dispatch_ack,"et.rr.RestorationAck":this.on_restoration_ack,"et.rr.TakeMicAck":this.on_take_mic_ack,"et.rr.ConfigureUserAck":this.on_configure_user_ack,"et.rr.QueryEnterpriseGroupAck":this.on_query_enterprise_group_ack,"et.rr.ChangePasswordAck":this.on_change_password_ack,"et.rr.ChangeGroupNameAck":this.on_change_group_name_ack,"et.rr.SetGroupMaxSpeechTimeAck":this.on_set_group_max_speechtime_ack,"et.rr.SetMemberPriorityAck":this.on_member_priority_ack,"et.rr.UpdateUserChatEnabledAck":this.on_update_user_chat_enable_ack,"et.push.UsersChanged":this.on_users_changed,"et.push.UserChanged":this.on_users_changed,"et.push.GroupListChanged":this.on_group_list_changed,"et.push.CurrentGroup":this.on_current_group,"et.push.ResponseInvite":this.on_response_invite,"et.push.Invite":this.on_invite,"et.push.Kick":this.on_kickout,"et.net.Pong":this.on_pong,"et.net.Ping":this.on_ping,"et.push.UserStatusChanged":this.on_user_status_changed,"et.push.GroupChanged":this.on_group_changed,"et.push.MemberChanged":this.on_members_changed,"et.push.Deliver":this.on_deliver_changed,"et.push.QuitGroup":this.on_quit_group_changed,"et.push.ResponseSession":this.on_response_session_changed,"et.push.RequestJoinSession":this.on_request_join_session_changed,"et.push.StopSession":this.on_stop_session_changed,"et.rr.StartSessionAck":this.on_start_session_ack,"et.rr.StopSessionAck":this.on_stop_session_ack,"et.rr.ResponseSessionAck":this.on_response_session_ack,"et.rr.ResponseJoinSessionAck":this.on_response_join_session_ack,"et.rr.DisableUserAck":this.on_disabled_user_ack,"et.rr.EnableUserAck":this.on_disabled_user_ack,"et.rr.ListenGroupAck":this.on_listen_group_ack,"et.rr.UnListenGroupAck":this.on_unlisten_group_ack,"et.rr.UpdateMemberTopAck":this.set_member_top_ack,"et.session.Kick":this.session_kick,"et.rr.SetGroupMaxSpeechTimeAck":this.SetGroupSpeakTimeAck_ack,"et.rr.SetGroupPriorityAck":this.SetGroupPriorityAck_ack}};Connection.prototype.connect=function(t){console.log("Connection connect",t),this.log(1,"Connection connect"),this.conn.connect(t);let n=this;n.conn_check_timer=setInterval((()=>{n.conn_check()}),5e3)},Connection.prototype.disconnect=function(){this.log(1,"Connection disconnect"),console.log("Connection disconnect"),this.conn.close(),clearInterval(this.conn_check_timer),this.conn_check_timer=null},Connection.prototype.login=function(t,n,i,o){this.log(1,"Connection Login"),this.ctx.notify_cb(EVENT_STATUS.RR_LOGIN,null);var e={},s={};s.account=t,s.pri=n,s.role=i,1==o?s.method="":(s.method="token",s.type=3),o>0&&(s.method="token",s.type=o);var _={};_.device_model=this.ctx.config.device.device,_.os=this.ctx.config.device.os,_.device_id="00000000000";_.cards=[{operator:"",no:"",imsi:"00000000000",iccid:"00000000000"}];var c={};c.ctx=this.ctx.config.device.platform,c.version=WEB_CLIENT_VERSION,c.support_invite=!0,e.auth=s,e.device=_,e.client=c,this.conn.send_cmd("et.rr.Login",e)},Connection.prototype.logout=function(t,n,i){console.log("Connection Logout"),this.log(1,"Connection Logout"),this.ctx.notify_cb(EVENT_STATUS.RR_LOGOUT,null);this.conn.send_cmd("et.rr.Logout",{})},Connection.prototype.query_group=function(){console.log("请求群组列表"),this.ctx.notify_cb(EVENT_STATUS.RR_QUERY_GROUP,null);this.conn.send_cmd("et.rr.QueryGroup",{})},Connection.prototype.join_group=function(t){this.log(1,"Connection JoinGroup gid:",t),this.ctx.notify_cb(EVENT_STATUS.RR_JOIN_GROUP,null);var n={};n.gid=t,this.conn.send_cmd("et.rr.JoinGroup",n)},Connection.prototype.leave_group=function(t){this.log(1,"Connection LeaveGroup gid:",t),this.ctx.notify_cb(EVENT_STATUS.RR_LEAVE_GROUP,null);var n={};n.gid=t,this.conn.send_cmd("et.rr.LeaveGroup",n)},Connection.prototype.client_send_file=function(t){this.log(1,"Connection sendFile status:",t),this.ctx.notify_cb(EVENT_STATUS.RR_UPLOAD_FILE,{})},Connection.prototype.response_sesssion=function(t,n,i){this.log(1,"response_sesssion","sesssion sid:"+t+", accept:"+n+",reasons:"+i),this.ctx.notify_cb(EVENT_STATUS.RR_RESPONSE_SESSION,null);var o={};o.gid=t,o.accept=n,o.reason=i,this.conn.send_cmd("et.rr.ResponseSession",o)},Connection.prototype.quit_group=function(t){this.log(1,"Connection QuitGroup gid:",t),this.ctx.notify_cb(EVENT_STATUS.RR_LEAVE_GROUP,null);var n={};n.gid=t,this.conn.send_cmd("et.rr.QuitGroup",n)},Connection.prototype.query_members=function(t){this.log(1,"请求成员列表:connection",t),this.ctx.notify_cb(EVENT_STATUS.RR_QUERY_MEMBERS,null);var n={};n.gid=t,this.conn.send_cmd("et.rr.QueryMembers",n)},Connection.prototype.create_group=function(t,n,i,o,e,s){this.log(1,"Connection create_group name:",t),this.ctx.notify_cb(EVENT_STATUS.RR_CREATE_GROUP,null);var _={};_.accounts=n,_.name=t,_.msg="",_.type=i,_.start_invite=o,_.temp=e,_.desc=s,this.conn.send_cmd("et.rr.CreateGroup",_)},Connection.prototype.delete_session=function(t){this.log(1,"Connection delete_session gid:",t),this.ctx.notify_cb(EVENT_STATUS.RR_DELETE_CONVERSATION,null);var n={};n.gid=t,this.conn.send_cmd("et.rr.DeleteSession",n)},Connection.prototype.start_session=function(t){this.log(1,"Connection start_session gid:",t),this.ctx.notify_cb(EVENT_STATUS.RR_START_SESSION,null);var n={};n.gid=t,this.conn.send_cmd("et.rr.StartSession",n)},Connection.prototype.stop_session=function(t,n){this.log(1,"Connection stop_session sid:",t),this.ctx.notify_cb(EVENT_STATUS.RR_STOP_SESSION,null);var i={};i.gid=t,console.log(n,"---reasons"),n=n?0:1,i.reason=n,this.conn.send_cmd("et.rr.StopSession",i)},Connection.prototype.Query_Enterprise_Group=function(t,n){this.log(1,"Connection Query_Enterprise_Group did:",t),this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_QUERY_ENTERPRISE,{});var i={};i.range=n,i.did=t,this.conn.send_cmd("et.rr.QueryEnterpriseGroup",i)},Connection.prototype.set_member_top=function(t,n,i,o){this.log(1,"Connection set_member_top gid:",t),this.ctx.notify_cb(EVENT_STATUS.RR_SET_MEMBER_TOP,{});var e={};e.gid=t,e.uids=n,e.top=o,this.conn.send_cmd("et.rr.UpdateMemberTop",e)},Connection.prototype.restoration=function(t){this.log(1,"Connection restoration account:",t),this.ctx.notify_cb(EVENT_STATUS.RR_RESTOR_ATION,null)},Connection.prototype.single_call=function(t,n){this.log(1,"Connection SingleCall uid:",t),this.ctx.notify_cb(EVENT_STATUS.RR_SINGLE_CALL,null);var i={};i.uid=t,i.fullDuplex=n,this.conn.send_cmd("et.rr.SingleCall",i)},Connection.prototype.call=function(t){this.log(1,"Connection Call uids:",t),this.ctx.notify_cb(EVENT_STATUS.RR_CALL,null);var n={};n.uids=t,n.type=0,this.conn.send_cmd("et.rr.Call",n)},Connection.prototype.single_call_invite=function(t,n){this.log(1,"Connection Invite uid:",t),this.ctx.notify_cb(EVENT_STATUS.RR_INVITE,null);var i={};i.invitees=[t],i.withAudio=!0,i.fullDuplex=n,this.conn.send_cmd("et.rr.Invite",i)},Connection.prototype.cancel_invite=function(t,n){this.ctx.notify_cb(EVENT_STATUS.RR_CANCEL_INVITE,null);var i={};i.inviteId=t,i.invitee=n,i.reason=0,this.conn.send_cmd("et.rr.CancelInvite",i)},Connection.prototype.connection_group_speakTime=function(t,n){var i={};i.gid=t,i.duration=n,this.conn.send_cmd("et.rr.SetGroupMaxSpeechTime",i)},Connection.prototype.response_invite=function(t,n,i,o){this.ctx.notify_cb(EVENT_STATUS.RR_RESPONSE_INVITE,null);var e={};e.inviteId=t,e.inviter=n,e.accept=i,e.reason=o,this.conn.send_cmd("et.rr.ResponseInvite",e)},Connection.prototype.get_watch_group=function(){this.log(1,"Connection QueryListenGroup"),this.ctx.notify_cb(EVENT_STATUS.RR_GET_WATCH_GROUP,null);this.conn.send_cmd("et.rr.QueryListenGroup",{})},Connection.prototype.msg_content=function(){this.log(1,"Connection QueryListenGroup"),this.ctx.notify_cb(EVENT_STATUS.RR_MSG_CONTENT_ACK,{})},Connection.prototype.watch_group_ex=function(t,n){this.log(1,"Connection WatchGroupEx gids:",t),this.ctx.notify_cb(EVENT_STATUS.RR_LISTEN_GROUP,null);var i={};i.gid=t,i.uid=n,i.expect_pt=this.ctx.config.audio.codec_type,i.accept_pt=[this.ctx.config.audio.codec_type],this.conn.send_cmd("et.rr.ListenGroup",i)},Connection.prototype.unlisten_group_ex=function(t,n){this.log(1,"Connection RemoveWatchGroup"," gids:"+t+"uid:"+n),this.ctx.notify_cb(EVENT_STATUS.RR_UNLISTEN_GROUP,null);var i={};i.gid=t,i.uid=n,this.conn.send_cmd("et.rr.UnListenGroup",i)},Connection.prototype.dispatch=function(t,n){this.ctx.notify_cb(EVENT_STATUS.RR_DISPATCH,null);var i={};i.gid=t,i.uids=n,this.conn.send_cmd("et.rr.Dispatch",i)},Connection.prototype.take_mic=function(t){this.log(1,"Connection take mic ","uids:"+t),this.ctx.notify_cb(EVENT_STATUS.RR_TAKE_MIC,null);var n={};n.uids=t,this.conn.send_cmd("et.rr.TakeMic",n)},Connection.prototype.user_enable=function(t,n){this.log(1,"Connection user enable:"," uids :"+t),this.log(1,"enable:",n),this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_USER,null);var i={};i.uids=t,i.accountEnabled=n,this.conn.send_cmd("et.rr.ConfigureUser",i)},Connection.prototype.audio_enable=function(t,n){this.log(1,"Connection audio enable:","uids:"+t),this.log(1,"enable:",n),this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_USER,null);var i={};i.uids=t,i.enabled=n,this.conn.send_cmd("et.rr.UpdateUserChatEnabled",i)},Connection.prototype.switch_location=function(t,n,i){this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_USER,null);var o={};o.uids=t,o.switchLocation=n,o.locationReportPeriod=i,this.conn.send_cmd("et.rr.ConfigureUser",o)},Connection.prototype.ping=function(){var t=0,n=this.ctx.cache.get_myself();null!=n&&(t=n.uid),this.log(1,"Connection Ping gid:",0),this.log(1,"uid:",t),this.ctx.notify_cb(EVENT_STATUS.NET_SEND_PING,null);var i={};i.timestamp=current_time_sec(),i.gid=0,i.uid=t,i.seq=1,this.conn.send_cmd("et.net.Ping",i)},Connection.prototype.user_name=function(t){this.log(1,"userName:",t),this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_USER_NAME,null);var n={};n.name=t,this.conn.send_cmd("et.rr.ChangeName",n)},Connection.prototype.user_password=function(t){this.log(1,"user_password:",t),this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_USER_PASSWORD,null);var n={};n.old_pwd_md5=hex_md5(1),n.new_pwd_md5=hex_md5(t),this.conn.send_cmd("et.rr.ChangePassword",n)},Connection.prototype.user_mailbox=function(t){this.log(1,"user_mailbox:",t),this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_USER_MAILBOX,null);var n={};n.phone=t,this.conn.send_cmd("et.rr.ChangePhone",n)},Connection.prototype.group_duration=function(t,n){this.log(1,"group_duration:","gid:"+t+", time:"+n),this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_GROUP_DURATION,null);var i={};i.gid=t,i.duration=n,this.conn.send_cmd("et.rr.SetGroupMaxSpeechTime",i)},Connection.prototype.group_precedence=function(t,n){this.log(1,"group_precedence:","gid:"+t);var i={};i.gid=t,i.priority=n,this.conn.send_cmd("et.rr.SetGroupPriority",i)},Connection.prototype.do_cancel_user_precedence=function(t,n,i){this.log(1,"do_cancel_user_precedence:","gid:"+t+", uid:"+n);var o={};o.gid=t,o.uid=n,o.priority=i,this.conn.send_cmd("et.rr.SetMemberPriority",o)},Connection.prototype.do_cancel_group_name=function(t,n){this.log(1,"do_cancel_group_name:","gid:"+t+", groupName:"+n),this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_GROUP_NAME,null);var i={};i.gid=t,i.name=n,this.conn.send_cmd("et.rr.ChangeGroupName",i)},Connection.prototype.do_cancel_group_remark=function(t,n){this.log(1,"do_cancel_group_remark:","gid:"+t+", remake:"+n),this.ctx.notify_cb(EVENT_STATUS.RR_CONFIGURE_GROUP_REMARK,null);var i={};i.gid=t,i.desc=n,this.conn.send_cmd("et.rr.ChangeGroupDesc",i)},Connection.prototype.client_play_recordfile_on_stop=function(t){this.log(1,"client_play_recordfile_on_stop:"),this.ctx.notify_cb(EVENT_STATUS.EN_PLAY_AUDIO_FILE_STATUS,t)};export default Connection;