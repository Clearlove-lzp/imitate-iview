import event_status_total from"../common/event_status.js";import Session from"./session.js";import{openLog,logInfo,warn,error}from"./log.js";const EVENT_STATUS=event_status_total.EVENT_STATUS,ECHAT_ERR=event_status_total.ECHAT_ERR;var SessionSet=function(t){this.JOIN_DEFAULT_PROGRESS={NOT_START:0,LAST_GROUP:1,DEFAULT_GROUP:2,WAIT_GROUPLIST:3,FIRST_GROUP:4},this.ctx=t,this.gid="0",this.in_join_gid=0,this.join_group_timer=null,this.try_join_group_timer=null,this.current=null,this.listens=[],this.retry_count=0,this.in_join_contact_id=0,this.in_join_token="",this.last_gid="0",this.locked_gid="0",this.join_default_progress=this.JOIN_DEFAULT_PROGRESS.NOT_START,this.log=function(t,i,s){switch(t){case 1:default:logInfo("SessionSet",i,s);break;case 2:warn("SessionSet",i,s);break;case 3:error("SessionSet",i,s)}},this.log=this.log.bind(this),this.post_event_current_group_changed=function(t){console.log("群组变更通知",t),this.log(1,"群组变更通知",t);var i=new Object;if(i.gid=t,i.groups={},0!=t){var s=this.ctx.cache.get_group_session_by_gid(t);console.log(s,"-----g"),null!=s&&0!=s.gid&&(i.groups=s)}console.log("群组变更通知",EVENT_STATUS.NOTICE_CURRENT_GROUP_CHANGED,i),this.ctx.notify_cb(EVENT_STATUS.NOTICE_CURRENT_GROUP_CHANGED,i)},this.post_event_current_group_changed=this.post_event_current_group_changed.bind(this),this.post_event_listen_grouplist_changed=function(t){this.ctx.notify_cb(EVENT_STATUS.NOTICE_LISTEN_GROUP_UPDATE,t)},this.post_event_listen_grouplist_changed=this.post_event_listen_grouplist_changed.bind(this),this.post_event_notify_error=function(t,i){this.log(1,"post_event_notify_error","error:"+t+",reason:"+i);var s=new Object;s.error=t,s.reason=i,this.ctx.notify_cb(EVENT_STATUS.EN_ERROR_NOTIFY,s)},this.post_event_notify_error=this.post_event_notify_error.bind(this),this.do_leave_group=function(t){if(console.log("sessionset do_leave_group:",this.current),this.log(1,"sessionset do_leave_group:",this.current),this.current){var i=this.current.get_gid();return this.log(1,"Leave group : ",i),this.current.leave(),this.current.is_listen()||this.current.destroy(),this.current=null,t&&this.ctx.connection.leave_group(i),this.post_event_current_group_changed("0"),0}return this.in_join_gid=0,this.in_join_contact_id=0,this.in_join_token="",-1},this.do_leave_group=this.do_leave_group.bind(this),this.get_listened=function(t){return this.listens.find((i=>i.get_gid()===t?i:null))},this.get_listened=this.get_listened.bind(this),this.sessionset_try_join_next_time=function(){var t=this.in_join_gid;this.log(1,"with gid:",this.in_join_gid),clearInterval(this.try_join_group_timer),this.in_join_gid=0,this.join_group(t)},this.sessionset_try_join_next_time=this.sessionset_try_join_next_time.bind(this),this.ss_on_joingroup_timeout=function(){clearInterval(this.join_group_timer),this.in_join_gid&&null==this.current?this.try_join_group_timer=setInterval(this.sessionset_try_join_next_time,1e3):(this.in_join_gid=0,this.log(1,"not next try join group!"))},this.ss_on_joingroup_timeout=this.ss_on_joingroup_timeout.bind(this),this.ss_change_current_group=function(t,i,s){if(console.log("sessionset ss gid:",t,",addr:",i,",priority:",s),this.current){if(console.log("sessionset ss change_current_group this.current.get_gid():",this.current.get_gid()),t==this.current.get_gid())return console.log("alread in group ",t),this.log(1,"alread in group ",t),void this.post_event_current_group_changed(t);this.do_leave_group(!1)}if(t.length>1&&i.length>0){var e=this.get_listened(t);null!=e?(this.log(1,"join watched group ",t),e.join(),this.current=e):(this.log(1,"Try join group: gid=",t),this.log(1,",addr",i),this.log(1,"priority=",s),0==(e=new Session(this.ctx,t,i,s)).join()?(this.current=e,e.set_locked_gid(this.locked_gid)):(this.log(1,"Can not create session for current group notify"),this.current.destroy(),this.ctx.connection.leave_group(t)))}this.post_event_current_group_changed(this.get_current_group())},this.ss_change_current_group=this.ss_change_current_group.bind(this),this.ss_add_listened_session=function(t){t.listen(),void 0===this.listens.find((i=>t.get_gid()===i.get_gid()))&&this.listens.push(t)},this.ss_add_listened_session=this.ss_add_listened_session.bind(this),this.ss_is_listened=function(t){return null!=this.listens.find((i=>t===i.get_gid()))},this.ss_is_listened=this.ss_is_listened.bind(this),this.ss_get_listened=function(t){var i=this.listens.find((i=>t===i.get_gid()));return void 0!==i?i:null},this.ss_get_listened=this.ss_get_listened.bind(this),this.ss_on_join_group_ack=function(t){if(console.log("SessionSet ss_on_join_group_ack 进入群组join",t),this.log(1,"SessionSet ss_on_join_group_ack 进入群组join",t),clearInterval(this.join_group_timer),"SUCCESS"===t.result){var i=t.gruntime,s=0;this.retry_count=0;var e=i.group.gid;this.in_join_gid=0,this.in_join_contact_id=0,""!==this.in_join_token&&(this.in_join_token=""),this.last_gid=e,this.join_default_progress=this.JOIN_DEFAULT_PROGRESS.NOT_START;var n="";if(null!=i.group&&i.domain.length>0&&i.wsport>0?(s=i.group.priority,n=i.domain+":"+String(i.wsport)):(this.ctx.connection.leave_group(i.group.gid),this.log(1,"current group notify has no address info")),""===n)return void this.log(1,"group address error!!!");if(null!=this.current){var o=this.current.get_addr();o!==n?(this.log(1,"current group address changed (",o),this.do_leave_group(!1)):this.do_leave_group(!1)}this.ss_change_current_group(e,n,s)}else{if(this.retry_count<=3){if("UNEXIST"==t.result&&this.ctx.cache.get_group_by_gid(this.in_join_gid))return this.log(1,"ss_on_join_group_ack"," retry join gid="+this.in_join_gid),this.try_join_group_timer=setInterval(this.sessionset_try_join_next_time,1e3),void this.retry_count++;if("ERROR"==t.result&&(""!=this.in_join_token||0!=this.in_join_gid||0!=this.in_join_contact_id))return this.log(1,"ss_on_join_group_ack"," retry join with token="+this.in_join_token),this.try_join_group_timer=setInterval(this.sessionset_try_join_next_time,1e3),void this.retry_count++}let i=ECHAT_ERR.JOIN_GROUP_FAILED,s=this.in_join_gid;switch(t.result){case"ERROR":i=ECHAT_ERR.JOIN_GROUP_FAILED;break;case"AUTH":i=ECHAT_ERR.JOIN_GROUP_AUTH;break;case"NORIGHT":i=ECHAT_ERR.JOIN_GROUP_NORIGHT;break;case"UNEXIST":i=ECHAT_ERR.JOIN_GROUP_UNEXISTS;break;case"EXPIRED":i=ECHAT_ERR.JOIN_GROUP_EXPIRED;break;case"LIMIT":i=ECHAT_ERR.JOIN_GROUP_LIMIT;break;case"EMPTY":i=ECHAT_ERR.JOIN_GROUP_EMPTY;break;case"DISABLED":i=ECHAT_ERR.JOIN_GROUP_DIABLED}this.retry_count=0,this.in_join_gid=0,this.in_join_contact_id=0,""!=this.in_join_token&&(this.in_join_token=""),this.log(1,"ss_on_join_group_ack"," result="+t.result+" failed! in_join_gid="+this.in_join_token),this.post_event_notify_error(i,s)}},this.ss_on_join_group_ack=this.ss_on_join_group_ack.bind(this),this.ss_on_current_group=function(t){this.log(1,"SessionSet ss_on_current_group ",t);var i=t.gid;if(this.in_join_gid=0,this.in_join_contact_id=0,this.in_join_token="",this.join_default_progress=this.JOIN_DEFAULT_PROGRESS.NOT_START,i.length>1&&(this.last_gid=i),null!=this.current){if(i===this.current.get_gid())return void this.log(1,"but alread in it");this.do_leave_group(!1)}if(i.length>1){var s=0,e=t.gruntime,n="";if(null!=e.group&&e.domain.length>0&&e.wsport>0?(s=e.group.priority,n=e.domain+":"+String(e.wsport)):(this.ctx.connection.leave_group(e.group.gid),this.log(1,"notify has no address info")),""===n)return void this.log(1,"group address error!!!");this.ss_change_current_group(i,n,s)}else this.ss_change_current_group(0,n,0)},this.ss_on_current_group=this.ss_on_current_group.bind(this),this.ss_on_create_group_ack=function(t){this.log(1,"SessionSet ss_on_create_group_ack")},this.ss_on_create_group_ack=this.ss_on_create_group_ack.bind(this),this.ss_on_listen_group_ack=function(t){if(console.log("SessionSet ss_on_listen_group_ack:",t),"SUCCESS"==t.result){let i=t.gruntime.group.gid;""!=i&&(this.listen_group(i),this.ctx.notify_cb(EVENT_STATUS.NOTICE_LISTEN_GROUP_UPDATE,null))}this.log(1,"SessionSet ss_on_listen_group_ack")},this.ss_on_listen_group_ack=this.ss_on_listen_group_ack.bind(this),this.ss_on_unlisten_group_ack=function(t){if(console.log("ss on_unlisten_group_ack jmsg:",t),console.log("ss on_unlisten_group_ack result:",t.result,", gid:%llu",t.gid),this.log(1,"ss on_unlisten_group_ack result:",t.result),this.log(1,"gid:%llu",t.gid),"SUCCESS"==t.result&&"0"!=t.gid&&""!=t.gid){let i=this.ctx.cache.get_group_by_gid(t.gid);i&&this.unlisten_group(i.gid)}},this.ss_on_unlisten_group_ack=this.ss_on_unlisten_group_ack.bind(this),this.ss_on_msg_memgetmic=function(t){this.log(1,"SessionSet ss_on_unlisten_group_ack")},this.ss_on_msg_memgetmic=this.ss_on_msg_memgetmic.bind(this),this.ss_on_msg_memlostmic=function(t){this.log(1,"SessionSet ss_on_msg_memlostmic")},this.ss_on_msg_memlostmic=this.ss_on_msg_memlostmic.bind(this),this.command_process=function(t,i){var s=this.dispatcher.find((function(i){return i.code===t.code}));null!=s&&"function"==typeof s.action&&s.action(i)},this.command_process=this.command_process.bind(this),this.dispatcher=[{code:EVENT_STATUS.RR_JOIN_GROUP_ACK.code,action:this.ss_on_join_group_ack},{code:EVENT_STATUS.PUSH_CURRENT_GROUP.code,action:this.ss_on_current_group},{code:EVENT_STATUS.RR_CREATE_GROUP_ACK.code,action:this.ss_on_create_group_ack},{code:EVENT_STATUS.RR_LISTEN_GROUP_ACK.code,action:this.ss_on_listen_group_ack},{code:EVENT_STATUS.RR_UNLISTEN_GROUP_ACK.code,action:this.ss_on_unlisten_group_ack},{code:EVENT_STATUS.PUSH_MEMBER_GET_MIC.code,action:this.ss_on_msg_memgetmic},{code:EVENT_STATUS.PUSH_MEMBER_LOST_MIC.code,action:this.ss_on_msg_memlostmic}]};SessionSet.prototype.join_group=function(t){if(this.in_join_gid==t)return this.log(1,"gid=",t),void this.log(1,"in_join_gid=",this.in_join_gid);this.ctx.connection.join_group(t),this.in_join_gid=t,this.join_group_timer=setInterval(this.ss_on_joingroup_timeout,3e3)},SessionSet.prototype.leave_group=function(){console.log(this.current,"---this.current"),this.do_leave_group(!0)},SessionSet.prototype.quit_group=function(t){this.do_leave_group(!0),this.ctx.connection.quit_group(t)},SessionSet.prototype.listen_group=function(t){var i=!1,s="",e=0,n=this.ctx.cache.get_group_session_by_gid(t);if(null!=n&&n.gid.length>1){i=!0;var o=this.ctx.cache.get_group_runtime(t);null!=o&&(s=o.domain,e=o.wsport)}if(!i||0==s.length||0==e)return-1;if(null!=this.current&&this.current.get_gid()===t)return this.ss_add_listened_session(this.current),this.post_event_listen_grouplist_changed(this.listens.length),0;if(this.ss_is_listened(n.gid))return null!=(_=this.ss_get_listened(n.gid))&&(this.log(1,"retry listen."),_.listen()),-1;var _,r=s+":"+String(e);if(null===(_=new Session(this.ctx,n.gid,r,n.priority))){this.log(1,"new session failed, send unlisten msg.");var u=0,g=this.ctx.cache.get_myself();return null!=g&&(u=g.uid),this.ctx.connection.unlisten_group_ex(t,u),-1}return 0==_.listen()?(this.listens.push(_),_.set_locked_gid(this.locked_gid),console.log("进入监听群组"),this.post_event_listen_grouplist_changed(this.listens.length),0):-1},SessionSet.prototype.unlisten_group=function(t){if(console.log("Try unlisten group: gid=",t),t.length<=1)return-1;var i=this.listens.find((function(i){if(i&&i.get_gid()===t)return i}));return null!=i?(i.unlisten(),i.get_is_member()||i.destroy(),this.listens=this.listens.filter((function(i){return i.get_gid()!==t})),0):-1},SessionSet.prototype.get_listen_group_count=function(){this.ctx.cache.get_watch_group_list()},SessionSet.prototype.get_listen_groups=function(){this.ctx.cache.get_watch_group_list_info()},SessionSet.prototype.is_listen_group=function(t){let i=!1;return!!this.ctx.cache.get_group_by_gid(t)&&(i=this.ss_is_listened(t),i)},SessionSet.prototype.speak=function(){if(console.log("开始讲话",this.current),this.current){this.log(1,"SessionSet.speak","开始讲话");let t=this.current.start_speak();this.ctx.notify_cb(EVENT_STATUS.RR_SPEAK,t)}else this.log(1,"start_speak failed, not join group!!")},SessionSet.prototype.stop_speak=function(){if(this.current){let t=this.current.stop_speak();this.ctx.notify_cb(EVENT_STATUS.RR_SPEAK_STOP,t)}else this.log(1,"stop_speak failed, not join group!!")},SessionSet.prototype.get_current=function(){return this.current},SessionSet.prototype.is_speaking=function(){return!!this.current&&this.current.is_speaking()},SessionSet.prototype.is_listening=function(){if(this.current&&1==this.current.is_listening())return!0;this.listens.forEach((t=>this.current.is_listening(t.status)));for(let t=0;t<this.listens.length;t++)if(this.current.is_listening(this.listens[t].status))return!0;return!1},SessionSet.prototype.get_speakers=function(){var t=new Array;if(this.listens.forEach((i=>{var s=i.get_speaker();if(s>0){var e=new Object;e.uid=s,e.gid=i.get_gid(),t.push(e)}})),this.current&&!this.current.is_listener()&&this.current.get_speaker()>0){var i=new Object;i.gid=this.current.get_gid(),i.uid=this.current.get_speaker(),t.push(i)}return t},SessionSet.prototype.reset=function(){null!=this.current&&(this.current.is_listen()?this.current=null:this.current.destroy()),this.listens.forEach((t=>{null!=t&&t.destroy()})),this.in_join_gid=0,this.in_join_contact_id=0,this.in_join_token=""},SessionSet.prototype.set_last_group=function(t){},SessionSet.prototype.get_last_group=function(t){},SessionSet.prototype.join_default=function(t){},SessionSet.prototype.get_current_group=function(){return console.log("查询当前组的gid",this.current),this.current?this.current.gid:""},SessionSet.prototype.update_group_priority=function(t,i){return this.listens.forEach((s=>{null!=s&&s.update_priority(t,i)})),this.current&&this.current.update_priority(t,i),0},SessionSet.prototype.reset_session_locked_gid=function(t){console.log("reset_session_locked_gid gid:",t),this.listens.forEach((i=>{null!=i&&i.set_locked_gid(t)})),this.current&&this.current.set_locked_gid(t)},SessionSet.prototype.set_locked_group=function(t){this.locked_gid=t;let i=!0;if(this.listens.forEach((s=>{null!=s&&s.get_gid()==t&&(i=!1)})),i&&"0"!=t&&0!=t&&null!=t){let i=this.ctx.cache.get_myself().uid;this.ctx.connection.watch_group_ex(t,i)}return this.reset_session_locked_gid(t),0},SessionSet.prototype.get_locked_group=function(){return this.locked_gid},SessionSet.prototype.notify_process=function(t,i){null!=i&&this.command_process(t,i.jmsg)},SessionSet.prototype.sessionset_on_keepalive_timer=function(){this.current&&this.current.session_on_keepalive_timer(),this.listens.forEach((t=>{null!=t&&t.session_on_keepalive_timer()}))};export default SessionSet;