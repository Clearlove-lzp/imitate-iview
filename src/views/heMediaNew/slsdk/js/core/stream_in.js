import{roundToDecimalPlace}from"../common/helper.js";import{openLog,logInfo}from"./js/core/log.js";var StreamIn=function(t){this.ctx=t,this.decoder=null,this.file_reader=new FileReader,this.pcm_buffer=[],this.pcm_buffer_file=[],this.start_ts=0,this.pack_count=0,this.pack_buf_size=0,this.unpack_duration=0,this.log=function(t,e,i){switch(t){case 1:default:logInfo("StreamIn",e,i);break;case 2:warn("StreamIn",e,i);break;case 3:error("StreamIn",e,i)}},this.log=this.log.bind(this),this.file_reader.onload=function(t){var e=Date.now();const i=t.target.result;var r=new DataView(i),n=(r.getUint8(1),r.getUint16(2),r.getUint32(4),r.getUint32(8));this.log(1,"StreamIn uid:",n);var o=new Uint8Array(i.slice(12,i.length)),a=new Uint8Array(6+o.length);a[0]=35,a[1]=33,a[2]=65,a[3]=77,a[4]=82,a[5]=10;for(var c=0;c<o.length;c++)a[c+6]=o[c];this.pack_buf_size+=o.length;var s=AMR.decode_run(this.decoder,a);if(s)for(c=0;c<s.length;c++)this.pcm_buffer.push(s[c]),this.ctx.config.audio.save_play_pcm&&this.pcm_buffer_file.push(s[c]);var h=Date.now()-e;this.unpack_duration+=h,this.pack_count+=1},this.file_reader.onload=this.file_reader.onload.bind(this),this.read_pcm=this.read_pcm.bind(this)};StreamIn.prototype.start=function(){this.decoder=AMR.decode_init(),this.start_ts=Date.now(),this.pack_count=0,this.unpack_duration=0},StreamIn.prototype.stop=function(){this.decoder&&(AMR.decode_deinit(this.decoder),this.decoder=null),this.sav_pcm_to_file("play.pcm"),this.pcm_buffer_file=[];var t=Date.now()-this.start_ts,e=roundToDecimalPlace(t/this.pack_count,2),i=roundToDecimalPlace(this.unpack_duration/this.pack_count,2);this.log(1,"StreamIn pack count:",this.pack_count),this.log(1,"pack avg duration:",i),this.log(1,"recv duration:",t),this.log(1,"recv avg dration:",e)},StreamIn.prototype.write_packet=function(t){this.file_reader.readAsArrayBuffer(t)},StreamIn.prototype.read_pcm=function(t){if(this.pcm_buffer.length>=t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.pcm_buffer.shift();return e}return[]},StreamIn.prototype.packet_count=function(){return this.pack_count},StreamIn.prototype.packet_buf_size=function(){return this.pack_buf_size},StreamIn.prototype.sav_pcm_to_file=function(t){if(this.pcm_buffer_file.length>0){const e=new Blob([new Uint16Array(this.pcm_buffer_file).buffer],{type:"application/octet-stream"}),i=URL.createObjectURL(e),r=document.createElement("a");r.href=i,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}};export default StreamIn;