import{roundToDecimalPlace}from"../common/helper.js";var StreamIn=function(t){this.ctx=t,this.pcm_buffer=[],this.pcm_buffer_file=[],this.start_ts=0,this.pack_count=0,this.pack_buf_size=0,this.unpack_duration=0,this.file_reader=new FileReader,this.play_audio_buffer=[],this.file_reader.onload=function(t){Date.now();const e=t.target.result;var i=new DataView(e),r=i.getUint8(1);i.getUint16(2),i.getUint32(4),i.getUint32(8);101==r?this.play(e.slice(12,e.byteLength)):console.error("error pt : ",r)},this.file_reader.onload=this.file_reader.onload.bind(this),this.readBlobWithXHR=function(t,e){const i=new XMLHttpRequest,r=URL.createObjectURL(t);i.open("GET",r,!0),i.responseType="arraybuffer",i.onload=function(){200===i.status?e(i.response):e(null),URL.revokeObjectURL(r)},i.onerror=function(){e(null),URL.revokeObjectURL(r)},i.send()},this.readBlobWithXHR=this.readBlobWithXHR.bind(this),this.play=function(t){if(this.ctx.sound.player)if(t.byteLength){var e=new Uint8Array(t);console.info("buff len:",e.length),this.pack_buf_size+=e.length,this.ctx.sound.write_frame(t)}else console.error("amr buffer len == 0");else console.error("play stream not init")},this.play=this.play.bind(this)};StreamIn.prototype.start=function(){this.start_ts=Date.now(),this.pack_count=0,this.unpack_duration=0,this.play_timer_id&&(console.log("setInterval start clear."),clearInterval(this.play_timer_id),this.play_timer_id=null);console.log("setInterval start."),this.play_timer_id=setInterval(play_audio_buffer_on_timer,100,this)};var play_audio_buffer_on_timer=function(t){if(t.play_audio_buffer.length>=1){const a=t.play_audio_buffer.shift();var e=new DataView(a),i=e.getUint8(1),r=e.getUint16(2),o=e.getUint32(4),n=e.getUint32(8);console.log("StreamIn uid:",n,"seq:",r,"pt:",i,"ts:",o),101==i?t.play(a.slice(12,a.byteLength)):console.error("error pt : ",i)}};StreamIn.prototype.stop=function(){console.log("setInterval clear@1."),this.play_timer_id&&(console.log("setInterval clear@2."),clearInterval(this.play_timer_id),this.play_timer_id=null),this.play_audio_buffer=[],this.sav_pcm_to_file("play.pcm"),this.pcm_buffer_file=[];var t=Date.now()-this.start_ts;roundToDecimalPlace(t/this.pack_count,2),roundToDecimalPlace(this.unpack_duration/this.pack_count,2);this.pack_count=0,this.pack_buf_size=0},StreamIn.prototype.write_packet=function(t){this.pack_count++,this.readBlobWithXHR(t,(t=>{t?(console.log("push arrayBuffer"),this.play_audio_buffer.push(t)):console.error("读取出错")}))},StreamIn.prototype.set_shutdown=function(){},StreamIn.prototype.packet_count=function(){return this.pack_count},StreamIn.prototype.packet_buf_size=function(){return this.pack_buf_size},StreamIn.prototype.sav_pcm_to_file=function(t){if(this.pcm_buffer_file.length>0){const e=new Blob([new Uint16Array(this.pcm_buffer_file).buffer],{type:"application/octet-stream"}),i=URL.createObjectURL(e),r=document.createElement("a");r.href=i,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}};export default StreamIn;