import Tts from "../hal/tts.js"; import Tone from "../hal/tone.js"; import AMR from "../module/amrnb.js"; import AudRecorder from "../hal/win/AudRecorder.js"; import AudPlayer from "../hal/win/AudPlayer.js"; import event_status_total from "../common/event_status.js"; import { openLog, logInfo, warn, error } from "./log.js"; const EVENT_STATUS = event_status_total.EVENT_STATUS; var Sound = function (t) { this.type = { NONE: 0, RECORD: 1, PLAY: 2, TONE: 3, TTS: 4 }, this.action = this.type.NONE, this.ctx = t, this.encoder = null, this.recorder = new AudRecorder(this.ctx.notify_cb), this.decoder = null, this.player = new AudPlayer(this.ctx.notify_cb), this.tts = new Tts(this.ctx.notify_cb), this.tone = new Tone(this.ctx.notify_cb), this.log = function (t, o, e) { switch (t) { case 1: default: logInfo("Sound", o, e); break; case 2: warn("Sound", o, e); break; case 3: error("Sound", o, e) } }, this.log = this.log.bind(this) }; Sound.prototype.start_record = function () { return this.action = this.type.RECORD, this.ctx.notify_cb(EVENT_STATUS.SOUND_AUDIO_RECORD_START, null), this.play_tone(this.tone.type.START_LISTEN), this.encoder = AMR.encode_init(8e3, this.ctx.config.audio.amr_mode), this.recorder.start() }, Sound.prototype.stop_record = function () { this.action = this.type.NONE, this.ctx.notify_cb(EVENT_STATUS.SOUND_AUDIO_RECORD_STOP, null), this.play_tone(this.tone.type.STOP_LISTEN), this.recorder.stop(), this.encoder && (AMR.encode_deinit(this.encoder), this.encoder = null) }, Sound.prototype.async_stop_record = function (t) { this.action = this.type.NONE, this.ctx.notify_cb(EVENT_STATUS.SOUND_AUDIO_RECORD_STOP, null), this.play_tone(this.tone.type.STOP_LISTEN), this.recorder.stop(), this.encoder && (AMR.encode_deinit(this.encoder), this.encoder = null), t() }, Sound.prototype.read_frame = function () { return this.recorder.read_frame() }, Sound.prototype.recoder_get_buffer_len = function () { return this.recorder.get_audio_buffer_len() }, Sound.prototype.encode_pcm = function (t) { return null == this.encoder ? null : AMR.encode_run(this.encoder, t, 8e3, this.ctx.config.audio.amr_mode) }, Sound.prototype.start_play = function () { this.action = this.type.PLAY, this.ctx.notify_cb(EVENT_STATUS.SOUND_AUDIO_PLAY_START, null), this.play_tone(this.tone.type.START_SPEAK), this.decoder = AMR.decode_init(), this.player.start() }, Sound.prototype.stop_play = function () { this.action = this.type.NONE, this.ctx.notify_cb(EVENT_STATUS.SOUND_AUDIO_PLAY_STOP, null), this.play_tone(this.tone.type.STOP_SPEAK), this.player.stop(), this.decoder && (AMR.decode_deinit(this.decoder), this.decoder = null) }, Sound.prototype.start_tts = function () { this.action = this.type.TTS, this.ctx.notify_cb(EVENT_STATUS.SOUND_TTS_PLAY_START, null) }, Sound.prototype.stop_tts = function () { this.action = this.type.NONE, this.ctx.notify_cb(EVENT_STATUS.SOUND_TTS_PLAY_STOP, null) }, Sound.prototype.play_tone = function (t) { this.ctx.config.audio.tone_enable && (this.ctx.notify_cb(EVENT_STATUS.SOUND_TONE_PLAY_START, null), this.tone.play(t), this.ctx.notify_cb(EVENT_STATUS.SOUND_TONE_PLAY_STOP, null)) }, Sound.prototype.write_frame = function (t) { var o = new Uint8Array(t), e = new Uint8Array(6 + o.length); e[0] = 35, e[1] = 33, e[2] = 65, e[3] = 77, e[4] = 82, e[5] = 10; for (var n = 0; n < o.length; n++)e[n + 6] = o[n]; var i = AMR.decode_run(this.decoder, e); this.player.play(i) }, Sound.prototype.stop_all = function () { this.action == this.type.PLAY && (this.player.stop(), this.decoder && (AMR.decode_deinit(this.decoder), this.decoder = null)), this.action == this.type.RECORD && (this.recorder.stop(), this.encoder && (AMR.encode_deinit(this.encoder), this.encoder = null)), this.action == this.type.TTS && this.stop_tts() }; export default Sound;