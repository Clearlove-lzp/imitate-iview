import{roundToDecimalPlace,current_time_millisec}from"../common/helper.js";import AMR from"../module/amrnb.js";var StreamOut=function(t,e,i,s){this.status=0,this.ctx=t,this.cb=i,this.socket=s,this.ssrc=e,this.buf_size=1024,this.seq=0,this.pcm_buffer=[],this.ts=0,this.amr_buffer_file=[],this.start_ts=0,this.pack_count=0,this.pack_duration=0,this.frame_per_packet=this.ctx.config.audio.packet_frames,this.next_tv=0,this.pack_rtp_data=function(t,e,i,s){s.setUint8(0,128),s.setUint8(1,101),s.setUint16(2,t),s.setUint32(4,e),s.setUint32(8,this.ssrc);for(var r=i.length,a=0;a<r;a++)s.setUint8(a+12,i[a]);return r+12},this.pack_rtp_data=this.pack_rtp_data.bind(this),this.send_audio_data=function(t,e,i){var s=new ArrayBuffer(this.buf_size),r=new DataView(s),a=this.pack_rtp_data(t,e,i,r),n=new Uint8Array(s.slice(0,a));if(a>12&&null!=this.socket){var h={type:2};h.uid=this.ssrc,h.msg=btoa(n),this.socket.send_cmd("et.net.WebsocketSessionPack",h)}},this.make_send_packet=function(){this.pcm_buffer.length;var t=new ArrayBuffer(this.buf_size),e=new DataView(t);if(null!=this.ctx.sound.encoder){for(var i=new Uint16Array(160*this.frame_per_packet),s=0;s<160*this.frame_per_packet;s++)if(this.pcm_buffer.length>=2){var r=new DataView(new ArrayBuffer(2));r.setUint8(0,this.pcm_buffer.shift()),r.setUint8(1,this.pcm_buffer.shift()),i[s]=r.getUint16(0,!0)}var a=this.ctx.sound.encode_pcm(i);if(a){for(s=0;s<a.length;s++)e.setUint8(s,a[s]),this.amr_buffer_file.push(a[s]);this.pack_count++,this.ts+=160*this.frame_per_packet,this.seq++,this.next_tv+=20*this.frame_per_packet;var n=new Uint8Array(t.slice(0,a.length));this.send_audio_data(this.seq,this.ts,n),this.cb(2)}}},this.make_send_packet=this.make_send_packet.bind(this),this.read_frame=function(){for(var t=0,e=this.ctx.sound.recoder_get_buffer_len(),i=0;i<e;i++){var s=this.ctx.sound.read_frame();this.pcm_buffer.push(s),t++}return t},this.read_frame=this.read_frame.bind(this),this.on_timer=function(){this.read_frame();var t=current_time_millisec();switch(this.status){case 0:this.pcm_buffer.length/320>=this.frame_per_packet&&(this.status=1,this.next_tv=t,this.make_send_packet());break;case 1:if(t+20>=this.next_tv){var e=this.pcm_buffer.length/320;if(e>=this.frame_per_packet)do{this.make_send_packet(),e=this.pcm_buffer.length/320}while(e>=this.frame_per_packet)}break;case 2:t>=this.next_tv&&this.pcm_buffer.length&&this.make_send_packet(),0==this.pcm_buffer.length&&this.cb(1)}},this.on_timer=this.on_timer.bind(this),this.timer=setInterval(this.on_timer,20)};StreamOut.prototype.start=function(){},StreamOut.prototype.stop=function(){clearInterval(this.timer),this.amr_buffer_file=[],this.pcm_buffer=[],this.seq=0,this.ts=0;var t=Date.now()-this.start_ts;roundToDecimalPlace(t/this.pack_count,2),roundToDecimalPlace(this.pack_duration/this.pack_count,2);this.pack_count=0},StreamOut.prototype.set_shutdown=function(){this.status!=this.RO_SHUTDOWN&&(this.status=this.RO_SHUTDOWN)},StreamOut.prototype.packet_count=function(){return this.pack_count},StreamOut.prototype.is_output=function(){return this.status==this.RO_OUTPUT},StreamOut.prototype.save_amr_to_file=function(t){if(this.amr_buffer_file.length>0){const e=new Blob([new Uint16Array(this.amr_buffer_file).buffer],{type:"application/octet-stream"}),i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}};export default StreamOut;