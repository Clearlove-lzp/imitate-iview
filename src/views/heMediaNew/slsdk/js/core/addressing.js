import WebConnect from "../hal/web_connect.js"; import event_status_total from "../common/event_status.js"; var WEB_CLIENT_VERSION = "V1.0.0-20240926"; import { openLog, logInfo, warn, error } from "./log.js"; const EVENT_STATUS = event_status_total.EVENT_STATUS; var Addressing = function (ctx) { this.ctx = ctx, this.log = function (level, fun, msg) { switch (level || (level = 1), level) { case 1: default: logInfo("Addressing", fun, msg); break; case 2: warn("Addressing", fun, msg); break; case 3: error("Addressing", fun, msg) } }, this.log = this.log.bind(this), this.notify_process = function (status, param) { this.ctx.notify_cb(status, param) }, this.command_process = function (uuid, msg_name, jmsg) { console.log("conn uuid:", uuid), this.log(1, "Addressing conn uuid:", uuid); var cfun = this.dispatcher[msg_name]; "function" == typeof cfun && cfun(jmsg) }, this.command_process = this.command_process.bind(this), this.notify_process = this.notify_process.bind(this), this.conn = new WebConnect(this.ctx.config, this.notify_process, this.command_process, null), this.on_query_server = function (jmsg) { console.log("请求服务器地址回应:", jmsg.result), this.log(1, "请求服务器地址回应:", jmsg.result); var param = { result: jmsg.result, jmsg: jmsg }; switch (this.ctx.notify_cb(EVENT_STATUS.RR_QUERY_SERVERA_ACK, param), jmsg.result) { case -1: this.ctx.notify_cb(EVENT_STATUS.ERROR_INVALID_CONTEXT, null); break; case -2: this.ctx.notify_cb(EVENT_STATUS.ERROR_INVALID_ACCOUNT, null); break; case -4: this.ctx.notify_cb(EVENT_STATUS.ERROR_ACCOUNT_LOCK, null); break; case -5: this.ctx.notify_cb(EVENT_STATUS.ERROR_TERMINAL_LOCK, null); break; case -6: this.ctx.notify_cb(EVENT_STATUS.ERROR_TERMINAL_CARD_LOCK, null); break; case -7: this.ctx.notify_cb(EVENT_STATUS.ERROR_CONFIGURE_MISS, null) }this.conn.close() }, this.on_query_server = this.on_query_server.bind(this), this.dispatcher = { "et.disp.QueryServerAck": this.on_query_server } }; Addressing.prototype.connect = function () { console.log("Addressing connect 调用新建链接"), this.log(1, "Addressing connect 调用新建链接"), this.conn.connect(this.ctx.config.profile.dns()) }, Addressing.prototype.disconnect = function () { this.log(1, "Addressing disconnect"), this.conn.close() }, Addressing.prototype.query_server = function (account) { this.ctx.notify_cb(EVENT_STATUS.RR_QUERY_SERVER, null); var jsonQueryServer = {}; jsonQueryServer.version = WEB_CLIENT_VERSION, jsonQueryServer.account = account, jsonQueryServer.accountModel = 0; var jsonSystem = {}; jsonSystem.os = this.ctx.config.device.os, jsonSystem.serialNumber = this.ctx.config.device.serialNumber, jsonQueryServer.system = jsonSystem, console.log("Addressing QueryServer登录", jsonQueryServer), this.log(1, "Addressing QueryServer登录", jsonQueryServer), this.conn && this.conn.send_cmd("et.disp.QueryServer", jsonQueryServer) }; export default Addressing;