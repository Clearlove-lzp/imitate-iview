import{roundToDecimalPlace}from"../common/helper.js";import{openLog,logInfo}from"./js/core/log.js";var StreamOut=function(t,e){this.log=function(t,e,i){switch(t){case 1:default:logInfo("StreamOut",e,i);break;case 2:warn("StreamOut",e,i);break;case 3:error("StreamOut",e,i)}},this.log=this.log.bind(this),this.ctx=t,this.uid=e,this.buf_size=1024,this.seq=0,this.ts=0,this.pcm_buffer=[],this.pcm_buffer_file=[],this.encoder=null,this.write_pcm=this.write_pcm.bind(this),this.start_ts=0,this.pack_count=0,this.pack_duration=0};StreamOut.prototype.start=function(){this.encoder=AMR.encode_init(8e3,this.ctx.config.audio.amr_mode),this.start_ts=Date.now(),this.pack_count=0,this.pack_duration=0},StreamOut.prototype.stop=function(){this.encoder&&(AMR.encode_deinit(this.encoder),this.encoder=null),this.sav_pcm_to_file("record.pcm"),this.pcm_buffer_file=[],this.pcm_buffer=[],this.seq=0,this.ts=0;var t=Date.now()-this.start_ts,e=roundToDecimalPlace(t/this.pack_count,2),i=roundToDecimalPlace(this.pack_duration/this.pack_count,2);console.log("StreamOut pack count:",this.pack_count,"pack avg duration:",i,"send duration:",t,"send avg dration:",e),this.log(1,"StreamOut pack count:",this.pack_count),this.log(1,"pack avg duration:",i),this.log(1,"send duration:",t),this.log(1,"send avg dration:",e)},StreamOut.prototype.write_pcm=function(t){for(var e=0;e<t.length;e++)this.pcm_buffer.push(t[e]),this.ctx.config.audio.save_record_pcm&&this.pcm_buffer_file.push(t[e])},StreamOut.prototype.read_packet=function(t){var e=[];if(this.pcm_buffer.length>=160*t){for(var i=Date.now(),o=new ArrayBuffer(this.buf_size),r=new DataView(o),n=this.pack_add_rtp_head(r),s=new Uint16Array(160*t),a=0;a<160*t;a++)s[a]=this.pcm_buffer.shift();var c=AMR.encode_run(this.encoder,s,8e3,this.ctx.config.audio.amr_mode);if(c){for(a=0;a<c.length;a++)r.setUint8(n+a,c[a]);this.seq+=1,this.ts+=160*t,e=new Uint8Array(o.slice(0,n+c.length))}var u=Date.now()-i;this.pack_duration+=u,this.pack_count+=1}return e},StreamOut.prototype.get_seq=function(){return this.seq},StreamOut.prototype.packet_count=function(){return this.pack_count},StreamOut.prototype.pack_add_rtp_head=function(t){return t.setUint8(0,128),t.setUint8(1,this.ctx.config.audio.codec_type),t.setUint16(2,this.seq),t.setUint32(4,this.ts),t.setUint32(8,this.uid),12},StreamOut.prototype.sav_pcm_to_file=function(t){if(this.pcm_buffer_file.length>0){const e=new Blob([new Uint16Array(this.pcm_buffer_file).buffer],{type:"application/octet-stream"}),i=URL.createObjectURL(e),o=document.createElement("a");o.href=i,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i)}};export default StreamOut;