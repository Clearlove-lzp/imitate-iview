var WEB_CLIENT_VERSION="V1.0.0-20240926";import event_status_total from"../common/event_status.js";import{numberToIpSwap,swap16,isEmptyObject}from"../common/helper.js";import{current_time_str,current_time_millisec}from"../common/helper.js";import{openLog,logInfo,warn,error}from"./log.js";const GROUP_TYPE=event_status_total.GROUP_TYPE,EVENT_STATUS=event_status_total.EVENT_STATUS;import Context from"./context.js";let cs_notify_ui_cb=null;var Client=function(t){this.loginInfo={at:null,ad:null,role:0,type:0},cs_notify_ui_cb=t,this.poc_server_addr=null,this.is_connect=!1,this.is_login=!1,this.tarTimes=null,this.send_ping_timer=null,this.start_record_time=null,this.current_group=null,this.watch_group_map={},this.call_uids=[],this.invite_id=0,this.gid=1,this.reason=0,this.invite_full_duplex=0,this.start_session_gid=0,this.session_group_gid=0,this.current_session_gid=0,this.current_session_status=0,this.session_ping_timerId=0,this.notify_ui_cb=t,this.record_audio_file_timerId=0,this.win_my_speak_record_size=0,this.record_audio_buff=[],this.play_audio_file_timerId=0,this.m_record_enabled=!1,this.play_audio_file_needle_length=0,this.play_audio_file_current_needle=0,this.audio_buffer_list=null,this.play_recordfile_sid=0,this.log=function(t,i,e){switch(t||(t=1),t){case 1:default:logInfo("Client",i,e);break;case 2:warn("Client",i,e);break;case 3:error("Client",i,e)}},this.log=this.log.bind(this),this.on_notify_process=function(i,e){this.ctx.cache.notify_process(i,e),this.ctx.sessionset.notify_process(i,e),this.notify_process(i,e),t&&t(i,e)},this.on_notify_process=this.on_notify_process.bind(this),this.ctx=new Context(this.on_notify_process),this.ping_timer=this.ping_timer.bind(this),this.reconnect_login=function(){console.log("触发重新登录"),this.log("1","触发重新登录"),this.ctx.addressing.connect();var t=this;setTimeout((()=>{t.ctx.addressing.query_server(t.login.account)}),2e3)},this.reconnect_login=this.reconnect_login.bind(this)};function areArraysEqual(t,i){if(t.length!==i.length)return!1;const e={};for(const i of t)e[i]=(e[i]||0)+1;for(const t of i){if(!e[t])return!1;e[t]--}return!0}Client.prototype.notify_process=function(t,i){switch(this.log(1,"Client_status",t.code),t.code){case EVENT_STATUS.UI_SET_GROUP_PRIORITY_ACK.code:this.notify_ui_cb(EVENT_STATUS.UI_SET_GROUP_PRIORITY_ACK,i);break;case EVENT_STATUS.UI_SET_GROUP_SPEAK_TIME_ACK.code:this.notify_ui_cb(EVENT_STATUS.UI_SET_GROUP_SPEAK_TIME_ACK,i);break;case EVENT_STATUS.ERROR_LOGIN_PRIVILEGE.code:console.log("et.session.kick param:",i),this.on_recv_kick_message(i);break;case EVENT_STATUS.RR_SPEAK_STOP.code:this.notify_ui_cb(EVENT_STATUS.RR_SPEAK_STOP,i);break;case EVENT_STATUS.RR_SPEAK.code:this.notify_ui_cb(EVENT_STATUS.RR_SPEAK,i);break;case EVENT_STATUS.RR_RESTOR_ATION.code:i={result:0},this.notify_ui_cb(EVENT_STATUS.RR_RESTOR_ATION_ACK,i);break;case EVENT_STATUS.RR_SET_MEMBER_TOP_ACK.code:this.notify_ui_cb(EVENT_STATUS.RR_SET_MEMBER_TOP_ACK,i);break;case EVENT_STATUS.RR_STOP_SESSION_ACK.code:if(this.log(1,"RR_STOP_SESSION_ACK",i),"SUCCESS"===i.jmsg.result){let t=new Object;t.gid=i.jmsg.gid,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_StopSessionAck,t)}break;case EVENT_STATUS.RR_QUERY_ENTERPRISE_GROUP_ACK.code:break;case EVENT_STATUS.RR_QUERY_SERVERA_ACK.code:if(0==i.result){for(var e=null,s=i.jmsg,o=0;o<s.servers.length;o++){e=s.servers[o].domain+":"+String(swap16(s.servers[o].port));break}e?this.ctx.connection.connect(e):this.log(1,"Client not find server address!!!")}break;case EVENT_STATUS.CONNECTED.code:this.is_connect=!0,JSON.parse(sessionStorage.getItem("logininfo"))&&(this.loginInfo=JSON.parse(sessionStorage.getItem("logininfo"))),this.ctx.connection.login(this.loginInfo.at,this.loginInfo.ad,this.loginInfo.role,this.loginInfo.type);break;case EVENT_STATUS.RR_LOGIN_ACK.code:if("SUCCESS"===i.result){this.log(1,"client login"),this.is_login=!0,this.send_ping_timer=setInterval(this.ping_timer,1e3*this.ctx.config.power.period_sec);let t=new Object;this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_ONLINE_STATUS_CHANGED,t)}break;case EVENT_STATUS.RR_LOGOUT_ACK.code:case EVENT_STATUS.PUSH_KICKOUT.code:console.log("client logout正常执行disconnect"),this.log(1,"client logout正常执行disconnect"),clearInterval(this.send_ping_timer),this.is_login=!1,this.disconnect();break;case EVENT_STATUS.RR_QUERY_MEMBERS_ACK.code:this.notify_ui_cb(EVENT_STATUS.RR_QUERY_MEMBERS_ACK,i);break;case EVENT_STATUS.DISCONNECT.code:this.log(1,"DISCONNECT client logout"),clearInterval(this.send_ping_timer),this.is_connect=!1,this.is_login=!1;break;case EVENT_STATUS.RECONNECT_LOGIN.code:this.log(1,"RECONNECT_LOGIN client logout"),clearInterval(this.send_ping_timer),this.is_connect=!1,this.is_login=!1,this.reconnect_login();break;case EVENT_STATUS.RR_JOIN_GROUP_ACK.code:case EVENT_STATUS.RR_UPLOAD_FILE.code:case EVENT_STATUS.PUSH_MEMBERS_CHANGED.code:break;case EVENT_STATUS.ERROR_SINGLE_CALL.code:case EVENT_STATUS.ERROR_CALL.code:this.call_uids=[];break;case EVENT_STATUS.RR_INVITE_ACK.code:s=i.jmsg;"SUCCESS"===i.result?this.invite_id=s.inviteId:(this.call_uids=[],this.invite_id=0,this.log(1,"Client invite fail reason:",s.reason));break;case EVENT_STATUS.RR_CANCEL_INVITE.code:this.call_uids=[],this.invite_id=0;break;case EVENT_STATUS.PUSH_RESPONSE_INVITE.code:(s=i.jmsg).inviteId==this.invite_id?s.accept?this.ctx.connection.single_call(s.invitee,this.invite_full_duplex):(this.call_uids=[],this.invite_id=0,this.log(1,"Client response accept:",s.accept),this.log(1,"reason:",s.reason)):(this.log(1,"Client response invite_id:",s.inviteId),this.log(1,"!= invite_id:",this.invite_id));break;case EVENT_STATUS.RR_LISTEN_GROUP_ACK.code:case EVENT_STATUS.RR_UNLISTEN_GROUP_ACK.code:i.result;break;case EVENT_STATUS.NOTICE_CURRENT_GROUP_CHANGED.code:{let t=this.ctx.cache.get_group_session_by_gid(i.gid);this.log(1,"current_group:"," gid :"+i.gid),null!=t&&(this.log(1,"NOTICE_CURRENT_GROUP_CHANGED ","g.session.status:"+t.session.status+", gid:",t.gid),0!==t.session.status&&3!==t.session.status&&2!==t.session.status&&"IDLE"!==t.session.status&&"DISCONNECTED"!==t.session.status&&"CONNECTED"!==t.session.status||t.gid!=this.current_session_gid||(this.session_group_gid=0,this.current_session_gid=0,this.current_session_status=0)),this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_CURRENT_GROUP_CHANGED,i)}break;case EVENT_STATUS.NOTICE_DEFAULT_LISTEN_GROUP_UPDATE.code:{let t=this.ctx.cache.get_default_listengrouplist();for(let i=0;i<t.length;i++)this.client_listen_group(t[i]);this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_LISTEN_GROUPLIST_CHANGED,null)}break;case EVENT_STATUS.NOTICE_LISTEN_GROUP_UPDATE.code:{let t=this.ctx.cache.get_listen_group_count(),i=this.ctx.cache.get_listen_group_gids(),e=new Object;e.count=t,e.gids=i,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_LISTEN_GROUPLIST_CHANGED,e)}break;case EVENT_STATUS.NOTICE_GROUP_CHANGED.code:this.log(1,"NOTICE_GROUP_CHANGED",i),this.client_on_group_changed(i);break;case EVENT_STATUS.NOTICE_GROUPLIST_CHANGED.code:this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_GROUPLIST_CHANGED,null);break;case EVENT_STATUS.NOTICE_GROUPS_CHANGED.code:this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_GROUPLIST_CHANGED,i);break;case EVENT_STATUS.NOTICE_MEMBERS_CHANGED.code:case EVENT_STATUS.NOTICE_MEMBERLIST_CHANGED.code:this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_MEMBERS_CHANGED,i);break;case EVENT_STATUS.NOTICE_USER_CHANGED.code:this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_USER_CHANGED,i);break;case EVENT_STATUS.NOTICE_USER_STATUS_CHANGED.code:this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_USER_STATUS_CHANGED,i);break;case EVENT_STATUS.PUSH_ON_DELIVER_CHANGED.code:"SessionGroupPing"==i.msg_name||"SessionGroupPong"==i.msg_name||this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_DELIVER,i);break;case EVENT_STATUS.NOTICE_NAME_CHANGED.code:this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_CHANGE_NAME_RESULT,i);break;case EVENT_STATUS.RR_CHANGE_PASSWORD_ACK.code:{let t=new Object;"SUCCESS"==i.jmsg.result?t.is_success=!0:t.is_success=!1,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_CHANGE_PASSWORD_RESULT,t)}break;case EVENT_STATUS.RR_CONFIGURE_USER_PRECEDENCE.code:this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.RR_CONFIGURE_USER_PRECEDENCE_ACK,i);break;case EVENT_STATUS.RR_CHANGE_GROUP_NAME_ACK.code:{let t=new Object;t.result=this.get_msg_result(i.jmsg.result),this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_CHANGE_GROUP_NAME_RESULT,i.jmsg),this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_CHANGE_SESSION_NAME_RESULT,t)}break;case EVENT_STATUS.RR_GET_WATCH_GROUP_ACK.code:if(this.log(1,"RR_GET_WATCH_GROUP_ACK",i),i.jmsg={})return;if(i.jmsg.groups.length>0){let t=new Object,e=[];t.result=0,t.gid_count=i.jmsg.groups.length;for(let t=0;t<i.jmsg.groups.length;t++)e.push(i.jmsg.groups[t].gid);this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_QueryListenGroupAck,t)}break;case EVENT_STATUS.RR_SET_GROUP_MAX_SPEECHTIME_ACK.code:{let t=new Object;t.gid=i.jmsg.gid,t.duration=i.jmsg.duration,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_SetGroupMaxSpeechTimeAck,t)}break;case EVENT_STATUS.PUSH_QUIT_GROUP.code:{let t=i.jmsg,e={n_gids:0,gids:[],n_left_uids:0,left_uids:[],by_self:!1,operator:0,type:0};e.n_gids=t.gids.length;let s=[];for(let i=0;i<t.gids.length;i++)s.push(t.gids[i]),this.ctx.cache.clean_current_group(t.gids[i]);e.gids=s;let o=[];for(let i=0;i<t.leftUids.length;i++)o.push(t.leftUids[i]);e.left_uids=o,e.by_self=t.bySelf,e.operator_=t.operator_,e.type=t.type,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_QuitGroup,e)}break;case EVENT_STATUS.PUSH_STOP_SESSION.code:{let t=this.ctx.cache.get_myself();if(i.jmsg.uid===t.uid)return void this.log(1,"ack->uid == current user");let e=new Object;e.gid=i.jmsg.gid,e.uid=i.jmsg.uid,e.reason=i.jmsg.reason,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_StopSession,e)}break;case EVENT_STATUS.PUSH_ON_RESPONSE_SESSION_CHANGED.code:{let t=new Object;t.gid=i.jmsg.gid,t.uid=i.jmsg.uid,t.accept=i.jmsg.accept,t.reason=i.jmsg.reason,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_ResponseSession,t)}break;case EVENT_STATUS.PUSH_ON_REQUEST_JOIN_SESSION_CHANGED.code:{let t=new Object;t.gid=i.jmsg.gid,t.uid=i.jmsg.uid,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_RequestJoinSession,t)}break;case EVENT_STATUS.RR_DELETE_CONVERSATION_ACK.code:if("SUCCESS"===i.jmsg.result){let t=new Object;t.gid=i.jmsg.gid,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_DeleteSessionAck,t)}break;case EVENT_STATUS.RR_CREATE_GROUP_ACK.code:this.log(1,"RR_CREATE_GROUP_ACK",i),this.on_recv_create_group_ack(i);break;case EVENT_STATUS.RR_START_SESSION_ACK.code:if(this.log(1,"RR_START_SESSION_ACK"),"SUCCESS"!==i.jmsg.result&&i.jmsg.reason){let t=new Object;t.gid=i.jmsg.gid,this.reason=i.jmsg.reason,t.reason=i.jmsg.reason,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_StartSessionAck,t)}break;case EVENT_STATUS.RR_RESPONSE_SESSION_ACK.code:{if(1001===i.jmsg.reason||1002===i.jmsg.reason)return;let t=new Object;t.gid=i.jmsg.gid,t.accept=i.jmsg.accept,t.reason=i.jmsg.reason,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_ResponseSessionAck,t)}break;case EVENT_STATUS.RR_RESPONSE_JOIN_SESSION_ACK.code:{let t=new Object;t.gid=i.jmsg.gid,t.accept=i.jmsg.accept,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_ResponseJoinSessionAck,t)}break;case EVENT_STATUS.RR_UPDATE_USER_CHAT_ENABLE_ACK.code:this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.RR_UPDATE_USER_CHAT_ENABLE_ACK,{});break;case EVENT_STATUS.RR_DISABLED_USER_ACK.code:{let t=new Object;t.uid=i.jmsg.uid,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_DisableUserAck,t)}break;case EVENT_STATUS.RR_ENABLED_USER_ACK.code:{let t=new Object;t.uid=i.jmsg.uid,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_EnableUserAck,t)}break;case EVENT_STATUS.NOTICE_RECV_FIRST_AUDIO_PACK.code:this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_RecvFirstAudioPack,null)}},Client.prototype.connect=function(){console.log("正常连接"),this.ctx.addressing.connect()},Client.prototype.disconnect=function(){console.log("正常执行disconnect",this.is_connect),this.is_connect&&(this.is_login&&this.ctx.connection.logout(),this.ctx.connection.disconnect())},Client.prototype.ping_timer=function(){this.ctx.connection&&this.ctx.connection.ping(),this.ctx.sessionset&&this.ctx.sessionset.sessionset_on_keepalive_timer()},Client.prototype.login=function(t,i,e,s){this.loginInfo.at=t,this.loginInfo.ad=i,this.loginInfo.role=e,this.loginInfo.type=s,sessionStorage.getItem("logininfo"),console.log("进入1",this.loginInfo),sessionStorage.setItem("logininfo",JSON.stringify(this.loginInfo)),this.reconnect_login()},Client.prototype.logout=function(){this.is_login?this.ctx.connection.logout():this.log(1,"Client No login unable logout")},Client.prototype.play_history=function(t,i){console.log("client123456",this.is_login),this.ctx.connection.playHistory(t,i)},Client.prototype.start_speak=function(){this.log(1,"讲话",this.current_group),this.is_login?this.ctx.sessionset.speak():this.log(1,"Client No group unable start speak")},Client.prototype.stop_speak=function(){this.is_login?this.ctx.sessionset.stop_speak():this.log(1,"Client No group unable stop speak")},Client.prototype.on_recv_kick_message=function(t){let i=new Object;t?t.reason?i.reason=t.reason:(console.log(" param@3."),i.reason=0):(console.log(" param@1."),i.reason=0),i.error=10,i.what="",this.client_play_audio_file(0,null,0,0,!1),this.notify_ui_cb(EVENT_STATUS.EN_ERROR_NOTIFY,i),-9==i.reason&&(i.error=12,this.notify_ui_cb(EVENT_STATUS.EN_ERROR_NOTIFY,i)),this.is_login=!1,this.disconnect(),this.ctx.sessionset.set_locked_group("0")},Client.prototype.query_group=function(){this.log(1,"查看当前组id,client",this.ctx.sessionset.get_current_group())},Client.prototype.get_current_group=function(){return this.log(1,"查看当前组id,client",this.ctx.sessionset.get_current_group()),this.ctx.sessionset.get_current_group()},Client.prototype.join_group=function(t){this.is_login?this.ctx.sessionset.join_group(t):this.log(1,"Client No login unable join group by gid:",t)},Client.prototype.leave_group=function(){this.is_login&&this.ctx.sessionset.leave_group()},Client.prototype.restoration=function(t){this.ctx.addressing.connect(),setTimeout((()=>{this.ctx.addressing.query_server(t)}),2e3)},Client.prototype.client_create_group=function(t,i,e,s,o,n,_){if(this.is_login){if(5==s){let t=this.ctx.cache.get_configure();if(0==t.allow_invite){this.log(1,"client_create_group allow_invite = ",t.allow_invite);let i=new Object;return i.gid=0,i.reason=5,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_StartSessionAck,i),-1}}return this.client_create_group_ex(t,i,e,s,o,n,_)}return-1},Client.prototype.client_create_group_ex=function(t,i,e,s,o,n,_){let l=0;if(!this.is_login)return-1;if(e>0&&null==i)return-1;for(this.client_play_audio_file(0,null,0,0,!1),l=0;l<e;l++);if(null==t&&(t=""),5==s&&0==n){var r=this.get_temporary_group_list();let e=[];console.log("创建会话--name",t),console.log("d---------",r);for(let t=0;t<r.length;t++)if(null!=this.get_member_list(r[t].gid)&&this.get_member_list(r[t].gid).length==i.length+1){let i={gid:r[t].gid,user:this.get_member_list(r[t].gid),nameflag:r[t].nameflag,session_status:r[t].session.status};e.push(i)}let s=[];for(let t=0;t<e.length;t++){let i=[];console.log("arr---",e),console.log("users",i);for(let s=0;s<e[t].user.length;s++)i.push(e[t].user[s].user.account);let o={gid:e[t].gid,userNmae:i,nameflag:e[t].nameflag,session_status:e[t].session_status};s.push(o)}console.log("--this.ctx.cache.get_user_by_uid()",this.ctx.cache.get_myself());let n=JSON.parse(JSON.stringify(i));n.push(this.ctx.cache.get_myself().account);let _=!1,l=0,c=0;for(let i=0;i<s.length;i++){if(areArraysEqual(s[i].userNmae,n)&&0==s[i].nameflag&&0==t.length){_=!0,l=s[i].gid,c=s[i].session_status;break}}if(_&&l){if(this.log(1,"create session is_exist sid:",l),o)switch(c){case 0:case"IDLE":case 1:case"CALLING":case 3:case"DISCONNECTED":this.start_session(l);break;case 2:case"CONNECTED":{this.response_sesssion(l,!0,1);let t={gid:l,reason:1004};this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_StartSessionAck,t)}}else{let t={gid:l,reason:0};this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_StartSessionAck,t)}return 0}}return this.ctx.connection.create_group(t,i,s,o,n,_),0},Client.prototype.delete_session=function(t){return this.is_login?(this.ctx.connection.delete_session(t),0):(this.log(1,"Client No login unable delete_session by gid:",t),-1)},Client.prototype.start_session=function(t){if(console.log("开始会话",this.is_login),this.is_login){let i=this.ctx.cache.get_configure();if(0==i.allow_invite){this.log(1,"start session allow_invite = ",i.allow_invite);let t=new Object;return t.gid=0,t.reason=5,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_StartSessionAck,t),-1}return this.start_session_gid=t,this.ctx.connection.start_session(t),0}return this.log(1,"Client No login unable start_session by gid:",t),-1},Client.prototype.stop_session=function(t,i){return console.log("挂断会话",this.is_login),this.is_login?(this.log(1," stop session sid:",t),this.log(1,"reasons:",i),this.ctx.connection.stop_session(t,i),0):(this.log(1,"Client No login unable stop_session by sid:",t),-1)},Client.prototype.response_sesssion=function(t,i,e){return this.is_login?(this.current_session_gid==t&&1003!=e&&(this.current_session_gid=0),1003==e&&(e=0),this.log(1," response session sid:",t),this.log(1,"accept:",i),this.log(1,"reason:",e),this.log(1,"current_session_gid:",this.current_session_gid),this.ctx.connection.response_sesssion(t,i,e),0):(this.log(1,"Client No login unable get member list by sid:",t),-1)},Client.prototype.single_call=function(t,i){this.is_login?0==this.call_uids.length?(this.call_uids.push(t),this.ctx.connection.single_call(t,i)):this.log(1,"Client already in temp call uids:",this.call_uids):(this.log(1,"Client No login unable single call by uid:",t),this.log(1,"full_duplex:",i))},Client.prototype.call=function(t){this.is_login?0==this.call_uids.length?(this.call_uids=t,this.ctx.connection.call(t)):this.log(1,"Client already in temp call uids:",this.call_uids):this.log(1,"Client No login unable single call by uid:",t)},Client.prototype.single_call_invite=function(t,i){this.is_login?0==this.call_uids.length?(this.call_uids.push(t),this.invite_full_duplex=i,this.ctx.connection.single_call_invite(t,i)):this.log(1,"Client already in temp call uids:",this.call_uids):(this.log(1,"Client No login unable single call invite by uid:",t),this.log(1,"full_duplex:",i))},Client.prototype.cancel_invite=function(){this.invite_id?this.call_uids.length>0?this.ctx.connection.cancel_invite(this.invite_id,this.call_uids[0]):this.log(1,"Client no call uid unable cancel invite"):this.log(1,"Client No invite unable cancel invite")},Client.prototype.response_invite=function(t,i,e,s){this.is_login?this.ctx.connection.response_invite(t,i,e,s):this.log(1,"Client No login unable response invite")},Client.prototype.get_watch_group_list_info=function(t,i){this.is_login?this.ctx.sessionset.get_listen_groups(t,i):this.log(1,"Client No login unable dispatch")},Client.prototype.is_listen_group=function(t){let i=!1;return this.is_login?i=this.ctx.sessionset.is_listen_group(t):this.log(1,"Client No login unable dispatch"),i},Client.prototype.dispatch=function(t,i){this.is_login?this.ctx.connection.dispatch(t,i):this.log(1,"Client No login unable dispatch")},Client.prototype.take_mic=function(t){this.is_login?this.ctx.connection.take_mic(t):this.log(1,"Client No login unable take mic")},Client.prototype.user_enable=function(t,i){this.is_login?this.ctx.connection.user_enable(t,i):this.log(1,"Client No login unable user enable")},Client.prototype.audio_enable=function(t,i){this.is_login?this.ctx.connection.audio_enable(t,i):this.log(1,"Client No login unable audio enable")},Client.prototype.switch_location=function(t,i,e){this.is_login?this.ctx.connection.switch_location(t,i,e):this.log(1,"Client No login unable switch location")},Client.prototype.client_listen_group=function(t){if(this.is_login){let i=this.get_myself().uid;this.ctx.connection.watch_group_ex(t,i)}else this.log(1,"Client No login unable listen group")},Client.prototype.client_unlisten_group=function(t){if(this.is_login){let i=this.get_myself().uid;this.ctx.connection.unlisten_group_ex(t,i)}else this.log(1,"Client No login unable unlisten group")},Client.prototype.get_user=function(t){return this.is_login?this.ctx.cache.get_user(t):null},Client.prototype.set_locked_group=function(t){return this.is_login?(this.ctx.sessionset.set_locked_group(t),this.ctx.connection.msg_content(t)):null},Client.prototype.get_locked_group=function(){return this.is_login?this.ctx.sessionset.get_locked_group():"0"},Client.prototype.get_myself=function(){return this.is_login=!0,this.is_login?this.ctx.cache.get_myself():(this.log(1,"Client No login unable get myself"),{})},Client.prototype.get_group_list=function(){return this.is_login=!0,this.is_login?this.ctx.cache.get_group_list():(this.log(1,"Client No login unable get group list"),{})},Client.prototype.get_temporary_group_list=function(){return this.is_login?this.ctx.cache.get_temporary_group_list():(this.log(1,"Client No login unable get group list"),{})},Client.prototype.get_group_by_gid=function(t){return this.is_login?this.ctx.cache.get_group_by_gid(t):(this.log(1,"Client No login unable get group by gid:",t),{})},Client.prototype.get_group_session_by_gid=function(t){return this.is_login?this.ctx.cache.get_group_session_by_gid(t):(this.log(1,"Client No login unable get group by gid:",t),{})},Client.prototype.get_member_list=function(t){return this.is_login?this.ctx.cache.get_member_list(t):(this.log(1,"Client No login unable get member list by gid:",t),{})},Client.prototype.get_member_by_uid=function(t,i){return this.is_login?this.ctx.cache.get_member_by_uid(t,i):(this.log(1,"Client No login unable get member list by gid:",t),this.log(1,"uid:",i),{})};var PLAY_FILE_REQUESTOP=2,RECORD_FILE_REQUESTOP=3,client_play_recordfile_release=function(t){t.ctx.focus.release(t,PLAY_FILE_REQUESTOP)};let client_play_recordfile_on_stop=function(t){if(t.log("client_play_recordfile_on_stop self:",t),t.log("client_play_recordfile_on_stop self:",cs_notify_ui_cb),t.log("client_play_recordfile_on_stop sid:",t.play_recordfile_sid),0==t.play_recordfile_sid||t.m_record_enabled){console.log("执行client_play_recordfile_on_stop");let i={state:0};i.sid=t.play_recordfile_sid,cs_notify_ui_cb&&cs_notify_ui_cb(EVENT_STATUS.EN_PLAY_AUDIO_FILE_STATUS,i),t.play_recordfile_sid=0}t.m_record_enabled=!1};var client_play_audio_file_on_timer=function(t){let i=t.audio_buffer_list.shift();i?(t.play_audio_file_current_needle++,t.ctx.sound.write_frame(i.data)):(t.log("clearInterval self.play_audio_file_timerId:",t),clearInterval(t.play_audio_file_timerId),t.ctx.sound.stop_play(),client_play_recordfile_on_stop(t),client_play_recordfile_release(t),t.audio_buffer_list=null);let e=0;t.play_audio_file_needle_length&&(e=Math.ceil(t.play_audio_file_current_needle/t.play_audio_file_needle_length*100));let s={};s.progress=e,s.current_needle=t.play_audio_file_current_needle,cs_notify_ui_cb&&cs_notify_ui_cb(EVENT_STATUS.EN_PLAY_PROGRESS,s)},s_frame_size=[13,14,16,18,20,21,27,32,6,0,0,0,0,0,0,1],DecoderAmrGetFrameSize=function(t){return s_frame_size[t>>3&15]},client_on_play_focus_notify=function(t,i){let e=t;i||e.audio_buffer_list&&(clearInterval(e.play_audio_file_timerId),e.ctx.sound.stop_play(),console.log("进入notify"),client_play_recordfile_on_stop(e),e.audio_buffer_list=null),e.log("client_on_play_focus_notify focus:",i)};Client.prototype.client_play_recordfile=function(t,i){if(console.log("进入client_play_recordfile sid",t,this.play_recordfile_sid),console.log("进入client_play_recordfile sid",this),this.ctx.sound.stop_all(),this.play_recordfile_sid){console.log("进入client_play_recordfile");let t=this;client_play_recordfile_on_stop(t),client_play_recordfile_release(t)}if(0==this.ctx.focus.require_nowait(this,PLAY_FILE_REQUESTOP,i,client_on_play_focus_notify))return this.play_recordfile_sid=t,this.log(1,"client_play_recordfile focus_manager_require_nowait == FALSE"),-1;this.ctx.sound.start_play(),this.ctx.sound.play_tone(this.ctx.sound.tone.START_LISTEN);let e={state:1};return e.sid=t,cs_notify_ui_cb&&cs_notify_ui_cb(EVENT_STATUS.EN_PLAY_AUDIO_FILE_STATUS,e),this.play_recordfile_sid=t,this.play_audio_file_timerId=setInterval(client_play_audio_file_on_timer,20,this),0},Client.prototype.client_play_audio_file=function(t,i,e,s,o){let n=0;if(null==i||0==i.length){this.log(1,"play audio file file_data is null audio_buffer.",this.audio_buffer_list);let t=this;return this.audio_buffer_list&&this.audio_buffer_list.length>0&&(clearInterval(this.play_audio_file_timerId),this.ctx.sound.stop_play(),this.log(1,"stop_play."),client_play_recordfile_on_stop(t),client_play_recordfile_release(t),this.audio_buffer_list=null),0}if(this.m_record_enabled=!0,o)n=this.ctx.focus.PriorityType.PLAY_RECORDED_FILE_PRIOR_RECORD;else{if(this.ctx.sessionset.is_speaking()||this.ctx.sessionset.is_listening())return console.log("retuen -1"),-1;n=this.ctx.focus.PriorityType.PLAY_RECORDED_FILE_PRIOR_BROADCAST}console.log("---prior",n);let _=new Uint8Array(i),l=Array.from(_),r=l.length;if(this.audio_buffer_list&&this.audio_buffer_list.length>0){console.log("进入audio_buffer_list",this.audio_buffer_list,this.audio_buffer_list.length),clearInterval(this.play_audio_file_timerId);let t=this;client_play_recordfile_on_stop(t),client_play_recordfile_release(t),this.audio_buffer_list=null}if(this.audio_buffer_list=[],0==t&&(t=101),this.play_audio_file_needle_length=0,console.log("data,size",l,r),console.log("paytype",t),101===t)if(-1==run_in_parse_amr_frame(this,l,r))return console.log("进入-1"),-2;this.play_audio_file_current_needle=Math.ceil(s/100*this.play_audio_file_needle_length);for(let t=0;t<this.play_audio_file_current_needle;t++)this.audio_buffer_list.shift();return this.client_play_recordfile(e,n)};var run_in_parse_amr_frame=function(t,i,e){let s=0,o=e,n=null,_=10;if(null==i||0==e)return-1;n=i;do{if(_=DecoderAmrGetFrameSize(n[0]),0==_){s=-1;break}let i={paytype:101};i.size=_;let e=[];for(let t=0;t<_;t++)e.push(n.shift());i.data=e,t.audio_buffer_list.push(i),o-=_,t.play_audio_file_needle_length++}while(o>0);return t.log("run_in_parse_amr_frame totalframe count:",t.audio_buffer_list.length),t.log(", this.play_audio_file_needle_length:",t.play_audio_file_needle_length),s},recorder_read_frame=function(t){let i=[];if(null==t.ctx.sound.encoder)return void console.error("amr encoder is null");let e=t.ctx.sound.recoder_get_buffer_len();if(e<320)return;let s=Math.floor(e/320);for(let e=0;e<320*s;e++){let e=t.ctx.sound.read_frame();i.push(e)}let o=new Uint16Array(160*s);for(let t=0;t<160*s;t++)if(i.length>=2){var n=new DataView(new ArrayBuffer(2));n.setUint8(0,i.shift()),n.setUint8(1,i.shift()),o[t]=n.getUint16(0,!0)}let _=t.ctx.sound.encode_pcm(o);if(_){for(let i=0;i<_.length;i++)t.record_audio_buff.push(_[i]);return!1}console.error("encode amr error!!")},recorder_on_timer=function(t){recorder_read_frame(t)},recorder_focus_notify=function(t,i){this.log(1,"recorder_focus_notify focus:",i);let e=t;i?e.record_audio_file_timerId=setInterval(recorder_on_timer,20,e):clearInterval(e.record_audio_file_timerId)},recorder_my_speak_voice_post_event=function(t,i,e,s,o){console.log("触发开始本地录音",i);let n={speech_id:"0"};if(n.timenow=i,n.success=s,e)t.tarTimes=o,console.log(" event.Recordname",i,o),t.notify_ui_cb&&t.notify_ui_cb(EVENT_STATUS.EN_RECORD_START,n);else{let i=current_time_millisec(),e=Math.floor((i-t.tarTimes)/1e3);n.Recordname=e+"_"+Date.now()+"_sid.amr",console.log("event.Recordname",n.Recordname),n.record_buff=t.record_audio_buff,t.notify_ui_cb&&setTimeout((()=>{t.notify_ui_cb(EVENT_STATUS.EN_RECORD_STOP,n)}),500)}};Client.prototype.recorder_start=function(){if(!this.ctx.focus.require_nowait(this,RECORD_FILE_REQUESTOP,this.ctx.focus.PriorityType.RECORCER_PRIOR,recorder_focus_notify))return-1;let t=this.ctx.sound.start_record();if(this.log(1,"recorder_start get focus success!",t),0!=t){this.log(1,"recorder_start sound_start_record result:",t);let i=this;return this.ctx.focus.release(i,RECORD_FILE_REQUESTOP),-1}this.record_audio_file_timerId=setInterval(recorder_on_timer,20,this),this.record_audio_buff=[];let i=current_time_str();return recorder_my_speak_voice_post_event(this,i,!0,!0,current_time_millisec()),0},Client.prototype.client_recorder_start=function(){return self.m_record_enabled=!0,this.recorder_start()},Client.prototype.client_recorder_stop=function(){this.m_record_enabled=!1,clearInterval(this.record_audio_file_timerId),recorder_on_timer(this),this.ctx.sound.stop_record();let t=current_time_str();recorder_my_speak_voice_post_event(this,t,!1,!!this.record_audio_buff.length,current_time_millisec());return this.ctx.focus.release(this,RECORD_FILE_REQUESTOP),0},Client.prototype.get_watch_group_list=function(){return this.is_login?this.ctx.sessionset.get_listen_group_count():(this.log(1,"Client No login unable get watch group list"),{})},Client.prototype.set_member_top=function(t,i,e,s){return this.is_login?this.ctx.connection.set_member_top(t,i,e,s):(this.log(1,"Client No login unable get watch group list"),{})},Client.prototype.user_name=function(t){this.is_login?this.ctx.connection.user_name(t):this.log(1,"Client No login unable take mic")},Client.prototype.client_group_speakTime=function(t,i){this.is_login?this.ctx.connection.connection_group_speakTime(t,i):this.log(1,"Client No login unable take mic")},Client.prototype.user_password=function(t){this.is_login?this.ctx.connection.user_password(t):this.log(1,"Client No login unable take mic")},Client.prototype.user_mailbox=function(t){this.is_login?this.ctx.connection.user_mailbox(t):this.log(1,"Client No login unable take mic")},Client.prototype.group_duration=function(t,i){this.is_login?this.ctx.connection.group_duration(t,i):this.log(1,"Client group_duration")},Client.prototype.group_precedence=function(t,i){this.ctx.connection.group_precedence(t,i)},Client.prototype.client_send_file=function(t){this.ctx.connection.client_send_file(t)},Client.prototype.do_cancel_user_precedence=function(t,i,e){this.is_login?this.ctx.connection.do_cancel_user_precedence(t,i,e):this.log(1,"Client do_cancel_user_precedence")},Client.prototype.do_cancel_group_name=function(t,i){this.is_login?this.ctx.connection.do_cancel_group_name(t,i):this.log(1,"Client do_cancel_group_name")},Client.prototype.do_cancel_group_remark=function(t,i){this.is_login?this.ctx.connection.do_cancel_group_remark(t,i):this.log(1,"Client do_cancel_group_remark")},Client.prototype.Query_Enterprise_Group=function(t,i){return this.is_login?this.ctx.connection.Query_Enterprise_Group(t,i):(this.log(1,"Client Query_Enterprise_Group"),{})},Client.prototype.get_enterprise_grouplist=function(){return this.is_login=!0,this.is_login?this.ctx.cache.get_enterprise_grouplist():(this.log(1,"Client get_enterprise_grouplist"),{})},Client.prototype.on_recv_create_group_ack=function(t){this.log(1,"recv create group ack result:",t.jmsg.result);let i=null!=t.jmsg.group?t.jmsg.group.gid:0;if(null!=t.jmsg.group&&(5==t.jmsg.group.type||t.jmsg.group.type==GROUP_TYPE.GROUP_SESSION)){let e=new Object;e.gid=i,t.jmsg.reason?e.reason=t.jmsg.reason:e.reason=0,this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_StartSessionAck,e)}},Client.prototype.client_on_group_changed=function(t){let i=new Object;if(i.gid=t.gid,i.type=t.type,i.session_status=t.session_status,i.type==GROUP_TYPE.GROUP_SESSION||5==i.type){if(2!=i.session_status&&"CALLING"!=i.session_status||(this.current_session_status=i.session_status,this.session_group_gid=i.gid,i.gid==this.current_session_gid&&(this.current_session_gid=0)),this.log(1,"gid:",i.gid),this.log(1,"session_status:",i.session_status),0!=i.session_status&&"IDLE"!=i.session_status&&3!=i.session_status&&"DISCONNECTED"!=i.session_status||i.gid!=this.current_session_gid||(this.session_group_gid=0,this.current_session_gid=0,this.current_session_status=0,this.log(1,"client on group changed  gid:",i.gid),this.log(1,"session_status",i.session_status)),1==i.session_status||"CALLING"==i.session_status){if(this.log(1,"client on group changed session_status= ",i.session_status),this.log(1,"self->current_session_gid:",this.current_session_gid),this.log(1,"gid:",i.gid),0==this.current_session_gid)this.current_session_gid=i.gid,this.current_session_status=i.session_status;else if((1==this.current_session_status||"CALLING"==this.current_session_status)&&this.current_session_gid!=i.gid)return void this.response_sesssion(i.gid,!1,1001);let t=this.ctx.cache.get_configure();if(this.log(1,"client on group changed  cfg->allow_invited:",t.allow_invited),this.log(1,"cfg->auto_answer:",t.auto_answer),i.gid!=this.start_session_gid&&0==t.allow_invited)return this.start_session_gid=0,this.response_session(i.gid,!1,1002),void this.log(1,"client on group changed  cfg->allow_invited:",t.allow_invited);this.start_session_gid=0,t.auto_answer&&this.response_session(i.gid,!0,1003)}}else{let t=this.ctx.cache.get_group_by_gid(i.gid);this.ctx.sessionset.update_group_priority(i.gid,t.priority)}this.log(1,"client on group changed gid:",i.gid),this.log(1,"group type:",i.type),this.log(1,"session_status:",i.session_status),setTimeout((()=>{this.notify_ui_cb&&this.notify_ui_cb(EVENT_STATUS.EN_GROUP_CHANGED,i)}),500)},Client.prototype.session_group_ping=function(t){if(1==t){let t=this;this.session_ping_time=3,this.session_ping_timerId=setInterval(this.session_group_ping_timer,1e3*this.session_ping_time,t)}else clearInterval(this.session_ping_timerId);this.log(1,"session group ping session_group_gid:",this.session_group_gid),this.log(1,"enable:",t),this.log(1,"ping_time:",this.session_ping_time)},Client.prototype.session_group_ping_timer=function(){},Client.prototype.get_msg_result=function(t){let i=-1;return"SUCCESS"===t?i=0:"ERROR"===t?i=-1:"AUTH"===t?i=-2:"NORIGHT"===t?i=-3:"UNEXIST"===t?i=-4:"EXPIRED"===t?i=-5:"LIMIT"===t?i=-6:"EMPTY"===t?i=-7:"DISABLED"===t?i=-8:"DID_DISABLED"===t?i=-9:"CHAT_DISABLED"===t&&(i=-10),i};export default Client;