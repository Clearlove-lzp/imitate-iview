!function(){"use strict";var e;Recorder.prototype.enc_mp3={stable:!0,testmsg:"采样率范围48000, 44100, 32000, 24000, 22050, 16000, 12000, 11025, 8000"},Recorder.prototype.mp3=function(e,t,r){var o=this,i=o.set,s=e.length,c=o.mp3_start(i);if(c)return o.mp3_encode(c,e),void o.mp3_complete(c,t,r,1);var f=new Recorder.lamejs.Mp3Encoder(1,i.sampleRate,i.bitRate),p=[],l=0,u=0,m=function(){if(l<s){(r=f.encodeBuffer(e.subarray(l,l+57600))).length>0&&(u+=r.buffer.byteLength,p.push(r.buffer)),l+=57600,setTimeout(m)}else{var r;(r=f.flush()).length>0&&(u+=r.buffer.byteLength,p.push(r.buffer));var o=a.fn(p,u,s,i.sampleRate);n(o,i),t(new Blob(p,{type:"audio/mp3"}))}};m()},Recorder.BindDestroy("mp3Worker",(function(){console.log("mp3Worker Destroy"),e&&e.terminate(),e=null})),Recorder.prototype.mp3_envCheck=function(e,t){var a="";return t.takeoffEncodeChunk&&(e.canProcess?r()||(a="当前浏览器版本太低，无法实时处理"):a=e.envName+"环境不支持实时处理"),a},Recorder.prototype.mp3_start=function(e){return r(e)};var t={id:0},r=function(r){var n=e;try{if(!n){var o=");wk_lame();var wk_ctxs={};self.onmessage="+function(e){var t=e.data,r=wk_ctxs[t.id];if("init"==t.action)wk_ctxs[t.id]={sampleRate:t.sampleRate,bitRate:t.bitRate,takeoff:t.takeoff,mp3Size:0,pcmSize:0,encArr:[],encObj:new wk_lame.Mp3Encoder(1,t.sampleRate,t.bitRate)};else if(!r)return;switch(t.action){case"stop":r.encObj=null,delete wk_ctxs[t.id];break;case"encode":r.pcmSize+=t.pcm.length,(a=r.encObj.encodeBuffer(t.pcm)).length>0&&(r.takeoff?self.postMessage({action:"takeoff",id:t.id,chunk:a}):(r.mp3Size+=a.buffer.byteLength,r.encArr.push(a.buffer)));break;case"complete":var a;(a=r.encObj.flush()).length>0&&(r.takeoff?self.postMessage({action:"takeoff",id:t.id,chunk:a}):(r.mp3Size+=a.buffer.byteLength,r.encArr.push(a.buffer)));var n=wk_mp3TrimFix.fn(r.encArr,r.mp3Size,r.pcmSize,r.sampleRate);self.postMessage({action:t.action,id:t.id,blob:new Blob(r.encArr,{type:"audio/mp3"}),meta:n})}};o+=";var wk_mp3TrimFix={rm:"+a.rm+",fn:"+a.fn+"}";var i=Recorder.lamejs.toString(),s=(window.URL||webkitURL).createObjectURL(new Blob(["var wk_lame=(",i,o],{type:"text/javascript"}));n=new Worker(s),setTimeout((function(){(window.URL||webkitURL).revokeObjectURL(s)}),1e4),n.onmessage=function(e){var r=e.data,a=t[r.id];a&&("takeoff"==r.action?a.set.takeoffEncodeChunk(new Uint8Array(r.chunk.buffer)):(a.call&&a.call(r),a.call=null))}}var c={worker:n,set:r,takeoffQueue:[]};return r?(c.id=++t.id,t[c.id]=c,n.postMessage({action:"init",id:c.id,sampleRate:r.sampleRate,bitRate:r.bitRate,takeoff:!!r.takeoffEncodeChunk,x:new Int16Array(5)})):n.postMessage({x:new Int16Array(5)}),e=n,c}catch(e){return n&&n.terminate(),console.error(e),null}};Recorder.prototype.mp3_stop=function(e){if(e&&e.worker){e.worker.postMessage({action:"stop",id:e.id}),e.worker=null,delete t[e.id];var r=-1;for(var a in t)r++;r&&console.warn("mp3 worker剩"+r+"个在串行等待")}},Recorder.prototype.mp3_encode=function(e,t){e&&e.worker&&e.worker.postMessage({action:"encode",id:e.id,pcm:t})},Recorder.prototype.mp3_complete=function(e,t,r,a){var o=this;e&&e.worker?(e.call=function(r){n(r.meta,e.set),t(r.blob),a&&o.mp3_stop(e)},e.worker.postMessage({action:"complete",id:e.id})):r("mp3编码器未打开")},Recorder.mp3ReadMeta=function(e,t){var r="object"==typeof window?window.parseInt:self.parseInt,a=new Uint8Array(e[0]||[]);if(a.length<4)return null;var n=function(e,t){return("0000000"+((t||a)[e]||0).toString(2)).substr(-8)},o=n(0)+n(1),i=n(2)+n(3);if(!/^1{11}/.test(o))return null;var s={"00":2.5,10:2,11:1}[o.substr(11,2)],c={"01":3}[o.substr(13,2)],f={1:[44100,48e3,32e3],2:[22050,24e3,16e3],2.5:[11025,12e3,8e3]}[s];f&&(f=f[r(i.substr(4,2),2)]);var p=[[0,8,16,24,32,40,48,56,64,80,96,112,128,144,160],[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320]][1==s?1:0][r(i.substr(0,4),2)];if(!(s&&c&&p&&f))return null;for(var l=Math.round(8*t/p),u=1==c?384:2==c||1==s?1152:576,m=u/f*1e3,d=Math.floor(u*p/8/f*1e3),b=0,R=0,h=0;h<e.length;h++){var k=e[h];if((R+=k.byteLength)>=d+3){var v=new Uint8Array(k);b="1"==n(k.byteLength-(R-(d+3)+1),v).charAt(6);break}}return b&&d++,{version:s,layer:c,sampleRate:f,bitRate:p,duration:l,size:t,hasPadding:b,frameSize:d,frameDurationFloat:m}};var a={rm:Recorder.mp3ReadMeta,fn:function(e,t,r,a){var n=this.rm(e,t);if(!n)return{err:"mp3非预定格式"};var o=Math.round(r/a*1e3),i=Math.floor((n.duration-o)/n.frameDurationFloat);if(i>0){var s=i*n.frameSize-(n.hasPadding?1:0);t-=s;for(var c=0,f=[],p=0;p<e.length;p++){var l=e[p];if(s<=0)break;s>=l.byteLength?(s-=l.byteLength,f.push(l),e.splice(p,1),p--):(e[p]=l.slice(s),c=l,s=0)}if(!this.rm(e,t)){c&&(e[0]=c);for(p=0;p<f.length;p++)e.splice(p,0,f[p]);n.err="fix后数据错误，已还原，错误原因不明"}var u=n.trimFix={};u.remove=i,u.removeDuration=Math.round(i*n.frameDurationFloat),u.duration=Math.round(8*t/n.bitRate)}return n}},n=function(e,t){var r="MP3信息 ";(e.sampleRate&&e.sampleRate!=t.sampleRate||e.bitRate&&e.bitRate!=t.bitRate)&&(console.warn(r+"和设置的不匹配set:"+t.bitRate+"kbps "+t.sampleRate+"hz，已更新set:"+e.bitRate+"kbps "+e.sampleRate+"hz",t),t.sampleRate=e.sampleRate,t.bitRate=e.bitRate);var a=e.trimFix;a?(r+="Fix移除"+a.remove+"帧"+a.removeDuration+"ms -> "+a.duration+"ms",a.remove>2&&(e.err=(e.err?e.err+", ":"")+"移除帧数过多")):r+=(e.duration||"-")+"ms",e.err?console.error(r,e.err,e):console.log(r,e)}}();