!function(e){"use strict";var t="2022-03-05 11:53:19",n=function(){},r=function(e){return new v(e)};r.IsOpen=function(){var e=r.Stream;if(e){var t=(e.getTracks&&e.getTracks()||e.audioTracks||[])[0];if(t){var n=t.readyState;return"live"==n||n==t.LIVE}}return!1},r.BufferSize=4096,r.Destroy=function(){for(var e in u("Recorder Destroy"),f(),a)a[e]()};var a={};r.BindDestroy=function(e,t){a[e]=t},r.Support=function(){var t=e.AudioContext;if(t||(t=e.webkitAudioContext),!t)return!1;var n=navigator.mediaDevices||{};return n.getUserMedia||(n=navigator).getUserMedia||(n.getUserMedia=n.webkitGetUserMedia||n.mozGetUserMedia||n.msGetUserMedia),!!n.getUserMedia&&(r.Scope=n,r.Ctx&&"closed"!=r.Ctx.state||(r.Ctx=new t,r.BindDestroy("Ctx",(function(){var e=r.Ctx;e&&e.close&&(e.close(),r.Ctx=0)}))),!0)};var o="ConnectEnableWorklet";r[o]=!1;var s=function(t){var n=(t=t||r).BufferSize||r.BufferSize,a=r.Ctx,s=t.Stream,i=s._m=a.createMediaStreamSource(s),f=s._call,l=function(e,t){if(!t||C)for(var n in f){for(var r=t||e.inputBuffer.getChannelData(0),a=r.length,o=new Int16Array(a),s=0,i=0;i<a;i++){var c=Math.max(-1,Math.min(1,r[i]));c=c<0?32768*c:32767*c,o[i]=c,s+=Math.abs(c)}for(var l in f)f[l](o,s);return}else u(v+"多余回调",3)},p="ScriptProcessor",v="audioWorklet",m="Recorder",h=m+" "+v,d="RecProc",g=a.createScriptProcessor||a.createJavaScriptNode,S="。由于"+v+"内部1秒375次回调，在移动端可能会有性能问题导致回调丢失录音变短，PC端无影响，暂不建议开启"+v+"。",_=function(){C=s.isWorklet=!1,c(s),u("Connect采用老的"+p+"，"+(r[o]?"但已":"可")+"设置"+m+"."+o+"=true尝试启用"+v+S,3);var e=s._p=g.call(a,n,1,1);i.connect(e),e.connect(a.destination),e.onaudioprocess=function(e){l(e)}},C=s.isWorklet=!g||r[o],y=e.AudioWorkletNode;if(C&&a[v]&&y){var k,x=function(){var e=function(e){return e.toString().replace(/^function|DEL_/g,"").replace(/\$RA/g,h)},t="class "+d+" extends AudioWorkletProcessor{";return t+="constructor "+e((function(e){DEL_super(e);var t=this,n=e.processorOptions.bufferSize;t.bufferSize=n,t.buffer=new Float32Array(2*n),t.pos=0,t.port.onmessage=function(e){e.data.kill&&(t.kill=!0,console.log("$RA kill call"))},console.log("$RA .ctor call",e)})),t+="process "+e((function(e,t,n){var r=this,a=r.bufferSize,o=r.buffer,s=r.pos;if((e=(e[0]||[])[0]||[]).length){o.set(e,s);var i=~~((s+=e.length)/a)*a;if(i){this.port.postMessage({val:o.slice(0,i)});var c=o.subarray(i,s);(o=new Float32Array(2*a)).set(c),s=c.length,r.buffer=o}r.pos=s}return!r.kill})),t+='}try{registerProcessor("'+d+'", '+d+')}catch(e){console.error("'+h+'注册失败",e)}',"data:text/javascript;base64,"+btoa(unescape(encodeURIComponent(t)))},I=function(){return C&&s._na},M=s._na=function(){""!==k&&(clearTimeout(k),k=setTimeout((function(){k=0,u(v+"未返回任何音频，恢复使用"+p,3),I()&&g&&_()}),500))},b=function(){if(I()){var e=s._n=new y(a,d,{processorOptions:{bufferSize:n}});i.connect(e),e.connect(a.destination),e.port.onmessage=function(e){k&&(clearTimeout(k),k=""),l(0,e.data.val)},u("Connect采用"+v+"方式，设置"+m+"."+o+"=false可恢复老式"+p+S,3)}};a.resume()[f&&"finally"]((function(){if(I())if(a[d])b();else{var e=x();a[v].addModule(e).then((function(e){I()&&(a[d]=1,b(),k&&M())}))[f&&"catch"]((function(e){u(v+".addModule失败",1,e),I()&&_()}))}}))}else _()},i=function(e){var t=(e||r).Stream;t._na&&t._na()},c=function(e){e._na=null,e._n&&(e._n.port.postMessage({kill:!0}),e._n.disconnect(),e._n=null)},f=function(e){var t=(e=e||r)==r,n=e.Stream;if(n&&(n._m&&(n._m.disconnect(),n._m=null),n._p&&(n._p.disconnect(),n._p.onaudioprocess=n._p=null),c(n),t)){for(var a=n.getTracks&&n.getTracks()||n.audioTracks||[],o=0;o<a.length;o++){var s=a[o];s.stop&&s.stop()}n.stop&&n.stop()}e.Stream=0};r.SampleData=function(e,t,n,r,a){r||(r={});var o=r.index||0,s=r.offset||0,i=r.frameNext||[];a||(a={});var c=a.frameSize||1;a.frameType&&(c="mp3"==a.frameType?1152:1);for(var f=0,u=o;u<e.length;u++)f+=e[u].length;f=Math.max(0,f-Math.floor(s));var l=t/n;l>1?f=Math.floor(f/l):(l=1,n=t),f+=i.length;var p=new Int16Array(f),v=0;for(u=0;u<i.length;u++)p[v]=i[u],v++;for(var m=e.length;o<m;o++){for(var h=e[o],d=(u=s,h.length);u<d;){var g=Math.floor(u),S=Math.ceil(u),_=u-g,C=h[g],y=S<d?h[S]:(e[o+1]||[C])[0]||0;p[v]=C+(y-C)*_,v++,u+=l}s=u-d}i=null;var k=p.length%c;if(k>0){var x=2*(p.length-k);i=new Int16Array(p.buffer.slice(x)),p=new Int16Array(p.buffer.slice(0,x))}return{index:o,offset:s,frameNext:i,sampleRate:n,data:p}},r.PowerLevel=function(e,t){var n=e/t||0;return n<1251?Math.round(n/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(n/1e4)/Math.log(10)))))};var u=function(t,n){var r=new Date,a=("0"+r.getMinutes()).substr(-2)+":"+("0"+r.getSeconds()).substr(-2)+"."+("00"+r.getMilliseconds()).substr(-3),o=this&&this.envIn&&this.envCheck&&this.id,s=["["+a+" Recorder"+(o?":"+o:"")+"]"+t],i=arguments,c=e.console||{},f=2,u=c.log;for("number"==typeof n?u=1==n?c.error:3==n?c.warn:u:f=1;f<i.length;f++)s.push(i[f]);l?u&&u("[IsLoser]"+s[0],s.length>1?s:""):u.apply(c,s)},l=!0;try{l=!console.log.apply}catch(e){}r.CLog=u;var p=0;function v(e){this.id=++p,r.Traffic&&r.Traffic();var t={type:"mp3",bitRate:16,sampleRate:16e3,onProcess:n};for(var a in e)t[a]=e[a];this.set=t,this._S=9,this.Sync={O:9,C:9}}r.Sync={O:9,C:9},r.prototype=v.prototype={CLog:u,_streamStore:function(){return this.set.sourceStream?this:r},open:function(t,a){var o=this,i=o._streamStore();t=t||n;var c=function(e,t){t=!!t,o.CLog("录音open失败："+e+",isUserNotAllow:"+t,1),a&&a(e,t)},u=function(){o.CLog("open ok id:"+o.id),t(),o._SO=0},l=i.Sync,p=++l.O,v=l.C;o._O=o._O_=p,o._SO=o._S;var m=function(){if(v!=l.C||!o._O){var e="open被取消";return p==l.O?o.close():e="open被中断",c(e),!0}},h=o.envCheck({envName:"H5",canProcess:!0});if(h)c("不能录音："+h);else if(o.set.sourceStream){if(!r.Support())return void c("不支持此浏览器从流中获取录音");f(i),o.Stream=o.set.sourceStream,o.Stream._call={};try{s(i)}catch(e){return void c("从流中打开录音失败："+e.message)}u()}else{var d=function(t,n){try{e.top.a}catch(e){return void c('无权录音(跨域，请尝试给iframe添加麦克风访问策略，如allow="camera;microphone")')}/Permission|Allow/i.test(t)?c("用户拒绝了录音权限",!0):!1===e.isSecureContext?c("无权录音(需https)"):/Found/i.test(t)?c(n+"，无可用麦克风"):c(n)};if(r.IsOpen())u();else if(r.Support()){var g=function(e){r.Stream=e,e._call={},m()||setTimeout((function(){m()||(r.IsOpen()?(s(),u()):c("录音功能无效：无音频流"))}),100)},S=function(e){var t=e.name||e.message||e.code+":"+e;o.CLog("请求录音权限错误",1,e),d(t,"无法录音："+t)},_=r.Scope.getUserMedia({audio:o.set.audioTrackSet||!0},g,S);_&&_.then&&_.then(g)[t&&"catch"](S)}else d("","此浏览器不支持录音")}},close:function(e){e=e||n;var t=this,r=t._streamStore();t._stop();var a=r.Sync;if(t._O=0,t._O_!=a.O)return t.CLog("close被忽略（因为同时open了多个rec，只有最后一个会真正close）",3),void e();a.C++,f(r),t.CLog("close"),e()},mock:function(e,t){var n=this;return n._stop(),n.isMock=1,n.mockEnvInfo=null,n.buffers=[e],n.recSize=e.length,n.srcSampleRate=t,n},envCheck:function(e){var t,n=this,r=n.set;return t||(n[r.type+"_envCheck"]?t=n[r.type+"_envCheck"](e,r):r.takeoffEncodeChunk&&(t=r.type+"类型不支持设置takeoffEncodeChunk")),t||""},envStart:function(e,t){var n=this,r=n.set;if(n.isMock=e?1:0,n.mockEnvInfo=e,n.buffers=[],n.recSize=0,n.envInLast=0,n.envInFirst=0,n.envInFix=0,n.envInFixTs=[],r.sampleRate=Math.min(t,r.sampleRate),n.srcSampleRate=t,n.engineCtx=0,n[r.type+"_start"]){var a=n.engineCtx=n[r.type+"_start"](r);a&&(a.pcmDatas=[],a.pcmSize=0)}},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){var n=this,a=n.set,o=n.engineCtx,s=n.srcSampleRate,i=e.length,c=r.PowerLevel(t,i),f=n.buffers,u=f.length;f.push(e);var l=f,p=u,v=Date.now(),m=Math.round(i/s*1e3);n.envInLast=v,1==n.buffers.length&&(n.envInFirst=v-m);var h=n.envInFixTs;h.splice(0,0,{t:v,d:m});for(var d=v,g=0,S=0;S<h.length;S++){var _=h[S];if(v-_.t>3e3){h.length=S;break}d=_.t,g+=_.d}var C=h[1],y=v-d;if(y-g>y/3&&(C&&y>1e3||h.length>=6)){var k=v-C.t-m;if(k>m/5){var x=!a.disableEnvInFix;if(n.CLog("["+v+"]"+(x?"":"未")+"补偿"+k+"ms",3),n.envInFix+=k,x){var I=new Int16Array(k*s/1e3);i+=I.length,f.push(I)}}}var M=n.recSize,b=i,R=M+b;if(n.recSize=R,o){var L=r.SampleData(f,s,a.sampleRate,o.chunkInfo);o.chunkInfo=L,R=(M=o.pcmSize)+(b=L.data.length),o.pcmSize=R,f=o.pcmDatas,u=f.length,f.push(L.data),s=L.sampleRate}var w=Math.round(R/s*1e3),T=f.length,z=l.length,O=function(){for(var e=D?0:-b,t=null==f[0],r=u;r<T;r++){var s=f[r];null==s?t=1:(e+=s.length,o&&s.length&&n[a.type+"_encode"](o,s))}if(t&&o)for(r=p,l[0]&&(r=0);r<z;r++)l[r]=null;t&&(e=D?b:0,f[0]=null),o?o.pcmSize+=e:n.recSize+=e},D=a.onProcess(f,c,w,s,u,O);if(!0===D){var A=0;for(S=u;S<T;S++)null==f[S]?A=1:f[S]=new Int16Array(0);A?n.CLog("未进入异步前不能清除buffers",3):o?o.pcmSize-=b:n.recSize-=b}else O()},start:function(){var e=this,t=r.Ctx,n=1;if(e.set.sourceStream?e.Stream||(n=0):r.IsOpen()||(n=0),n)if(e.CLog("开始录音"),e._stop(),e.state=0,e.envStart(null,t.sampleRate),e._SO&&e._SO+1!=e._S)e.CLog("start被中断",3);else{e._SO=0;var a=function(){e.state=1,e.resume()};"suspended"==t.state?(e.CLog("wait ctx resume..."),e.state=3,t.resume().then((function(){e.CLog("ctx resume"),3==e.state&&a()}))):a()}else e.CLog("未open",1)},pause:function(){var e=this;e.state&&(e.state=2,e.CLog("pause"),delete e._streamStore().Stream._call[e.id])},resume:function(){var e=this;if(e.state){e.state=1,e.CLog("resume"),e.envResume();var t=e._streamStore();t.Stream._call[e.id]=function(t,n){1==e.state&&e.envIn(t,n)},i(t)}},_stop:function(e){var t=this,n=t.set;t.isMock||t._S++,t.state&&(t.pause(),t.state=0),!e&&t[n.type+"_stop"]&&(t[n.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(e,t,n){var a,o=this,s=o.set;o.CLog("stop "+(o.envInLast?o.envInLast-o.envInFirst+"ms 补"+o.envInFix+"ms":"-"));var i=function(){o._stop(),n&&o.close()},c=function(e){o.CLog("结束录音失败："+e,1),t&&t(e),i()},f=function(t,n){if(o.CLog("结束录音 编码"+(Date.now()-a)+"ms 音频"+n+"ms/"+t.size+"b"),s.takeoffEncodeChunk)o.CLog("启用takeoffEncodeChunk后stop返回的blob长度为0不提供音频数据",3);else if(t.size<Math.max(100,n/2))return void c("生成的"+s.type+"无效");e&&e(t,n),i()};if(!o.isMock){var u=3==o.state;if(!o.state||u)return void c("未开始录音"+(u?"，开始录音前无用户交互导致AudioContext未运行":""));o._stop(!0)}var l=o.recSize;if(l)if(o.buffers[0])if(o[s.type]){if(o.isMock){var p=o.envCheck(o.mockEnvInfo||{envName:"mock",canProcess:!1});if(p)return void c("录音错误："+p)}var v=o.engineCtx;if(o[s.type+"_complete"]&&v){var m=Math.round(v.pcmSize/s.sampleRate*1e3);return a=Date.now(),void o[s.type+"_complete"](v,(function(e){f(e,m)}),c)}a=Date.now();var h=r.SampleData(o.buffers,o.srcSampleRate,s.sampleRate);s.sampleRate=h.sampleRate;var d=h.data;m=Math.round(d.length/s.sampleRate*1e3),o.CLog("采样"+l+"->"+d.length+" 花:"+(Date.now()-a)+"ms"),setTimeout((function(){a=Date.now(),o[s.type](d,(function(e){f(e,m)}),(function(e){c(e)}))}))}else c("未加载"+s.type+"编码器");else c("音频buffers被释放");else c("未采集到录音")}},e.Recorder&&e.Recorder.Destroy(),e.Recorder=r,r.LM=t,r.TrafficImgUrl="//ia.51.la/go1?id=20469973&pvFlag=1",r.Traffic=function(){var e=r.TrafficImgUrl;if(e){var t=r.Traffic,n=location.href.replace(/#.*/,"");0==e.indexOf("//")&&(e=/^https:/i.test(n)?"https:"+e:"http:"+e),t[n]||(t[n]=1,(new Image).src=e,u("Traffic Analysis Image: Recorder.TrafficImgUrl="+r.TrafficImgUrl))}}}(window),"function"==typeof define&&define.amd&&define((function(){return Recorder})),"object"==typeof module&&module.exports&&(module.exports=Recorder);export default Recorder;