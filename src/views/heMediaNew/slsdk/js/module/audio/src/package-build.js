var fs=require("fs"),crypto=require("crypto"),UglifyJS=require("uglify-js");function Run_minify(){deleteFolder("../dist"),!fs.existsSync("../dist")&&fs.mkdirSync("../dist"),fs.mkdirSync("../dist/engine"),fs.mkdirSync("../dist/extensions"),fs.mkdirSync("../dist/app-support"),console.log("[33m%s[0m","å¼€å§‹minifyå¤„ç†æ–‡ä»¶..."),minify("../dist/app-support/app.js",["app-support/app.js","app-support/app-ios-weixin-support.js","app-support/app-native-support.js"]),minify("../recorder.mp3.min.js",["recorder-core.js","engine/mp3.js","engine/mp3-engine.js"]),minify("../recorder.wav.min.js",["recorder-core.js","engine/wav.js"]),minify("../dist/recorder-core.js",["recorder-core.js"]),minify("../dist/engine/mp3.js",["engine/mp3.js","engine/mp3-engine.js"]),minify("../dist/engine/wav.js",["engine/wav.js"]),minify("../dist/engine/pcm.js",["engine/pcm.js"]),minify("../dist/engine/beta-webm.js",["engine/beta-webm.js"]),minify("../dist/engine/beta-ogg.js",["engine/beta-ogg.js","engine/beta-ogg-engine.js"]),minify("../dist/engine/beta-amr.js",["engine/beta-amr.js","engine/beta-amr-engine.js","engine/wav.js"]),minify("../dist/extensions/waveview.js",["extensions/waveview.js"]),minify("../dist/extensions/wavesurfer.view.js",["extensions/wavesurfer.view.js"]),minify("../dist/extensions/lib.fft.js",["extensions/lib.fft.js"]),minify("../dist/extensions/frequency.histogram.view.js",["extensions/frequency.histogram.view.js"]),minify("../dist/extensions/sonic.js",["extensions/sonic.js"]),minify("../dist/extensions/dtmf.encode.js",["extensions/dtmf.encode.js"]),minify("../dist/extensions/dtmf.decode.js",["extensions/dtmf.decode.js"]),minify("../dist/extensions/buffer_stream.player.js",["extensions/buffer_stream.player.js"]),console.log("[33m%s[0m","å¤„ç†å®Œæˆ")}function minify(e,n){console.log("æ­£åœ¨ç”Ÿæˆ"+e);for(var s=[],i=0;i<n.length;i++)s.push(fs.readFileSync(n[i],"utf-8"));var r=s.join("\n").replace(/\/\*=:=\*\/([\S\s]+?)\/\*<@([\S\s]+?)@>\*\//g,(function(e,n,s){return console.log("*******ä½¿ç”¨ç¼–è¯‘æŒ‡ä»¤ï¼š\n"+e+"\n\n"),s})),t=UglifyJS.minify(r);if(t.error)throw new Error(t.error);r=`/*\nå½•éŸ³\nhttps://github.com/xiangyuecn/Recorder\nsrc: ${n.join(",")}\n*/\n`,r+=t.code,fs.writeFileSync(e,r)}function deleteFolder(e,n){fs.existsSync(e)&&(fs.readdirSync(e).forEach((function(s){var i=e+"/"+s;fs.statSync(i).isDirectory()?deleteFolder(i,(n||0)+1):fs.unlinkSync(i)})),n&&fs.rmdirSync(e))}function Run_npm(){console.log("[33m%s[0m","åˆ¶ä½œä½œè€…éœ€è¦ä¸Šä¼ çš„npmåŒ…æ–‡ä»¶...");var e="../assets/npm-home",n=e+"/npm-files",s=n+"/src";deleteFolder(n),!fs.existsSync(n)&&fs.mkdirSync(n),fs.mkdirSync(s);for(var i,r=fs.readFileSync("../README.md","utf-8"),t=fs.readFileSync("../app-support-sample/README.md","utf-8"),o=fs.readFileSync(e+"/README.md","utf-8"),c=fs.readFileSync(e+"/package.json","utf-8"),a=fs.readFileSync(e+"/hash-history.txt","utf-8"),f=fs.existsSync(e+"/version.patch.txt")&&fs.readFileSync(e+"/version.patch.txt","utf-8")||"",m=crypto.createHash("sha1"),p=function(e,n){fs.writeFileSync(e,n),m.update(n)},d={"README.Raw":r,"ç¼–è¾‘æé†’":"[â€‹](?æœ¬æ–‡ä»¶ä¸ºåŠ¨æ€ç”Ÿæˆæ–‡ä»¶ï¼Œè¯·å‹¿ç›´æ¥ç¼–è¾‘ï¼Œéœ€è¦ç¼–è¾‘è¯·ä¿®æ”¹npm-homeä¸­çš„README)"},l=/\(\?Ref=(.+?)&Start\)([\S\s]+?)\[.*?\]\(\?RefEnd/g;i=l.exec(r);)d["README."+i[1]]=i[2].trim();for(l.lastIndex=0;i=l.exec(t);)d["RecordApp.README."+i[1]]=i[2].trim();console.log("Refå·²å®šä¹‰é¡¹",Object.keys(d));l=/@@Ref (.+?)@@/g;o=(o=o.replace(l,(function(e,n){var s=d[n];if(!s)throw new Error("npm READMEä¸­"+e+"ä¸å­˜åœ¨");return s}))).replace(/@@Remove Start@@[\S\s]+@@Remove End@@/g,""),p(n+"/README.md",o),console.log("å·²ç”Ÿæˆ"+n+"/README.md");var g=0,y=0;c=c.replace(/"([\d\.]+)123456.9999"/g,(function(e,n){var s=new Date,i=(""+s.getFullYear()).substr(-2);i+=("0"+(s.getMonth()+1)).substr(-2),i+=("0"+s.getDate()).substr(-2);var r="00";if(f){var t=JSON.parse(f),o=t.date.replace(/-/g,"");if(8!=o.length)throw new Error("versionPatch.dateæ— æ•ˆ");o.substr(-6)==i&&(r=("0"+t.patch).substr(-2))}return y=r,g=i='"'+n+i+r+'"'})),console.log("[32m%s[0m","package version:"+g+" patch:"+y+'ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹patchï¼Œè¯·æ–°å»ºversion.patch.txtï¼Œæ ¼å¼{"date":"2010-01-01","patch":12}patchå–å€¼0-99å½“æ—¥æœ‰æ•ˆ'),fs.writeFileSync(n+"/package.json",c),console.log("å·²ç”Ÿæˆ"+n+"/package.json");var j=function(e,n){var s=fs.readFileSync(e);p(n,s),console.log("å·²å¤åˆ¶"+n)};j("../recorder.mp3.min.js",n+"/recorder.mp3.min.js"),j("../recorder.wav.min.js",n+"/recorder.wav.min.js"),j("recorder-core.js",s+"/recorder-core.js"),["engine","extensions","app-support"].forEach((function(e){var n=fs.readdirSync(e);fs.mkdirSync(s+"/"+e),n.forEach((function(n){j(e+"/"+n,s+"/"+e+"/"+n)}))}));var u=m.digest("hex"),v=JSON.parse(a||"[]"),S=0;v[0]&&v[0].sha1==u||(S=1,v.splice(0,0,{sha1:u,time:(new Date).toLocaleString()}),v.length=Math.min(v.length,5),fs.writeFileSync(e+"/hash-history.txt",JSON.stringify(v,null,"\t")));var h="è¯·è®°å¾—åˆ°"+n+"ç›®å½•ä¸­ä¸Šä¼ npmåŒ…"+(S?"ï¼Œå·²å‘ç”Ÿå˜æ›´":"");console.log("["+(S?31:32)+"m%s[0m",h),console.log("[33m%s[0m","å¤„ç†å®Œæˆ")}console.log("[32m%s[0m","è¯·é€‰æ‹©æ“ä½œï¼š(1)å‹ç¼©js (2)ç”ŸæˆnpmåŒ… (å›è½¦)æ‰€æœ‰"),process.stdin.on("data",(function(e){(e=e.toString().trim())&&"1"!=e||Run_minify(),e&&"2"!=e||Run_npm(),console.log("[33m%s[0m","ç¨‹åºå·²é€€å‡º"),process.exit()}));