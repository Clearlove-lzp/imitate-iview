!function(){"use strict";var n=RecordApp,t=n.CLog,e=n.Platforms.Weixin,r=e.Config;e.IsInit=!0;var o,i={};e.RequestPermission=function(n,e){if(5!=o)if(f.push({t:n,f:e}),1!=o){o=1;var a=function(n,t){o=n?0:5;var e=f;f=[];for(var r=0;r<e.length;r++)n?e[r].f(n,t):e[r].t()};r.WxReady((function(n,e){i.wx=null,e?a("微信JsSDK准备失败："+e):(i.wx=n,v((function(){n.startRecord({success:function(){var n=function(e,r){setTimeout((function(){d((function(e){e&&t("停止wx录音"+(r?"[Final]":"")+":"+e,3),!e||r?a():n(1e3,1)}))}),e)};n(100)},fail:function(n){a("无法微信录音："+n.errMsg)},cancel:function(n){a("用户不允许微信录音："+n.errMsg,!0)}})})))}))}else t("检测到连续的RequestPermission调用，wx环境已加入队列，这种操作是不建议的，如果是用户触发，应当开启遮罩层避免重复点击",3);else n()};var a,u,c,s,f=[],l=0,d=function(n,t){t||(u=0,a=0),i.wx.stopRecord({success:function(){n&&n()},fail:function(t){n&&n("无法结束录音："+t.errMsg)}})},v=function(n,e){!e&&u&&t("录音中，正在kill重试",3),d((function(){setTimeout(n,300)}),e)};e.Start=function(n,r,o){var f=i.wx;if(f){if(u)return t("wx正在录音，但又开始新录音，kill掉老的",3),void v((function(){e.Start(n,r,o)}));if(a)return t("wx上次Start还未完成，等待重试...",3),void setTimeout((function(){e.Start(n,r,o)}),600);var h=++l,m=function(n){a=0,o("开始微信录音失败："+n.errMsg),d()},w=function(e){u=0,a=1,f.startRecord({success:function(){u=1,a=0,i.startTime=Date.now(),i.start=n,t("wx已开始录音"),r()},fail:function(n){e?m(n):v((function(){w(1)}))},cancel:m})};w(),i.chunks=[],i.chunkErr="",c=null,s=null,f.onVoiceRecordEnd({complete:function(n){var e=Date.now();if(c?c(n,"chunk"):n.localId&&i.chunks?i.chunks.push({res:n,duration:e-i.startTime,time:e,from:"chunk"}):t("已忽略wx chunk数据",3,n),s)s();else{t("wx录音超时，正在接续...");var r=function(n){u&&h==l?f.startRecord({success:function(){h==l&&(i.startTime=Date.now(),t("已接续wx录音,中断"+(Date.now()-e)+"ms"))},fail:function(e){if(u&&h==l){var o="无法接续微信录音："+e.errMsg;t(o,1,e),n>2?i.chunkErr=o:(n++,t("尝试重启..."+n),v((function(){r(n)}),1))}}}):t("已停止wx录音，拒绝接续",3)};r(0)}}})}else o("请先调用RequestPermission")},e.Stop=function(o,a){var f=i.wx;u=0;var l=!!s;s=null,t("开始停止录音");var v=function(n){a("录音失败[wx]："+(n.errMsg||n))},h=i.start;if(h){var m=Date.now()-i.startTime;if(!l&&m>59100)return t("wx录音即将满1分钟，等待它录满，不然stop不可控...",3),void(s=function(){e.Stop(o,a)});i.start=null;var w={list:[]};h.DownWxMediaData=w;var p=function(){var e=w.list,r=e[0];if(r.duration){for(var i=atob(r.data),a=i.length,u=new Uint8Array(a);a--;)u[a]=i.charCodeAt(a);var c=new Blob([u.buffer],{type:r.mime});return n._SRec=null,t("微信素材服务器端已转码，不支持RecordApp.GetStopUsedRec方法",3),void o(c,r.duration)}var s=[],f=0,l=0,d=0,m=function(){if(d||(d=Date.now()),l>=e.length)return w.decodeTime=Date.now()-d,void function(){f||(f=Date.now());var e=[],r=h.sampleRate/8e3;r<=1?r=1:t("微信arm素材采样率为8000hz（语音音质勉强能听），已自动提升成设置的采样率"+h.sampleRate+"hz，但音质不可能会变好",3);for(var i=0,a=0,u=0;u<s.length;u++)for(var c=s[u],l=0;l<c.length;l++){var d=c[l],m=Math.floor(i);i+=r;for(var p=Math.floor(i),R=(d-a)/(p-m),g=1;m<p;m++,g++)e.push(Math.floor(a+g*R));a=d}var x=Recorder(h).mock(e,h.sampleRate);x.stop((function(t,e){for(var r in w.encodeTime=Date.now()-f,x.set)h[r]=x.set[r];n._SRec=x,o(t,e)}),v)}();var r=e[l];r.duration=x[l].duration,r.isAmr=!0;for(var i=atob(r.data),a=i.length,u=new Uint8Array(a);a--;)u[a]=i.charCodeAt(a);Recorder.AMR.decode(u,(function(n){s.push(n),l++,m()}),(function(n){v("AMR音频"+(l+1)+"无法解码:"+n)}))};Recorder.AMR?m():v("未加载AMR转换引擎")},R=[],g=function(){if(o){for(var n=[],e=0;e<x.length;e++)n.push(x[e].res.localId);if(t("结束录音共"+n.length+"段，开始上传下载",n,x),n.length){var i=0,a=0,u=function(){w.downTime=Date.now()-a,t("开始转码..."),p()},c=function(n){if(a||(a=Date.now()),i>=R.length)u();else{var e=R[i];r.DownWxMedia({mediaId:e,transform_mediaIds:R.join(","),transform_type:h.type,transform_bitRate:h.bitRate,transform_sampleRate:h.sampleRate},(function(n){w.list.push(n),n.duration?u():/amr/i.test(n.mime)?(i++,c()):v("微信服务器返回了未知音频类型："+n.mime)}),(function(e){(n=n||0)>2?v("下载微信音频失败："+e):(n++,t("DownWxMedia失败，重试..."+n,1,e),c(n))}))}},s=0,l=function(e){if(s>=n.length)return w.uploadTime=Date.now()-d,t("开始下载微信素材..."),void c();var r=n[s];t("wx上传本地录音["+s+"] wx.playVoice({localId:'"+r+"'})"),f.uploadVoice({localId:r,isShowProgressTips:0,fail:function(n){(e=e||0)>2?v("微信uploadVoice失败["+s+"]："+n.errMsg):(e++,t("uploadVoice失败，重试..."+e,1,n),l(e))},success:function(n){var e=n.serverId;t("上传OK serverId:"+e),R.push(e),s++,l()}})},d=Date.now();l()}else v("未获得任何录音")}else v("仅清理资源")},x=i.chunks;if(i.chunkErr)return t(i.chunkErr,1,x),void v("录制失败，已录制"+x.length+"分钟，但后面出错："+i.chunkErr);if(l)g();else{if(x.length&&Date.now()-x[x.length-1].time<900)return t("丢弃结尾未停止太短录音",3),d(),void g();c=function(n,e){c=null;var r=Date.now();n.localId?x.push({res:n,duration:r-i.startTime,time:r,from:e}):t("已忽略"+e+"数据",3,n),i.chunks=null,g()},f.stopRecord({fail:function(n){c=null,x.length&&m<3e3?(t("停止录音出错，但后续录音太短，已忽略此错误："+n.errMsg,3),g()):v(n)},success:function(n){c&&c(n,"stop")}})}}else v("未开始录音")}}();