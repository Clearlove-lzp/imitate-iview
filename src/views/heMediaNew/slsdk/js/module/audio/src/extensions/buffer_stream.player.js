!function(){"use strict";var e=function(e){return new t(e)},t=function(e){var t={play:!0,realtime:!0};for(var r in e)t[r]=e[r];this.set=e=t,e.onInputError||(e.onInputError=function(e,t){console.error("[BufferStreamPlayer]"+e)})};t.prototype=e.prototype={getAudioSrc:function(){return this._src||(this._src=(window.URL||webkitURL).createObjectURL(this.getMediaStream())),this._src},getMediaStream:function(){if(!this._dest)throw new Error("BufferStreamPlayer未start");return this._dest.stream},start:function(t,r){var a=this;a.inputN=0,a.inputQueueIdx=0,a.inputQueue=[],a.bufferSampleRate=0,a.audioBuffer=0,a.pcmBuffer=[[],[]];var n=function(e){r&&r("浏览器不支持打开BufferStreamPlayer"+(e?"："+e:""))},u=1;if(Recorder.Support()){var f=Recorder.Ctx.createBufferSource();f.start&&void 0!==f.onended||(u=0)}else u=0;if(u){var i=function(){var e=Recorder.Ctx.createMediaStreamDestination();e.channelCount=1,a._dest=e,t&&t(),a._inputProcess(),o?(console.warn("BufferStreamPlayer：此浏览器的AudioBuffer实现不支持动态特性，采用兼容模式"),a._writeInt=setInterval((function(){a._writeBad()}),10)):a._writeInt=setInterval((function(){a._writeBuffer()}),500)},o=e.BadAudioBuffer;if(a.__abTest||null!=o)setTimeout(i);else{var c=e({play:!1,sampleRate:8e3});c.__abTest=1,c.start((function(){var t=Recorder({type:"unknown",sourceStream:c.getMediaStream(),onProcess:function(r){for(var a=r[r.length-1],n=1,u=0;u<a.length;u++)if(0!=a[u]){n=0;break}n&&r.length<5||(t.close(),c.stop(),e.BadAudioBuffer=o=n,i())}});t.open((function(){t.start()}),n)}),n);for(var s=new Int16Array(8e3),l=0;l<8e3;l++)s[l]=~~(32767*Math.random()*2-32767);c.input(s)}}else n("")},stop:function(){var e=this;clearInterval(e._writeInt),e.inputQueue=0,e._src&&((window.URL||webkitURL).revokeObjectURL(e._src),e._src=0);var t=e.bufferSource;t&&(t.disconnect(),t.stop()),e.bufferSource=0,e.audioBuffer=0},input:function(e){var t=this,n=t.set,u=++t.inputN;if(!t.inputQueue)throw new Error("未调用start方法");n.decode?a(e,(function(e){t.inputQueue&&(r(e.data,e.sampleRate),t._input2(u,e.data,e.sampleRate))}),(function(e){t._inputErr(e,u)})):t._input2(u,e,n.sampleRate)},_input2:function(e,t,r){var a=this,n=a.set;n.transform?n.transform(t,r,(function(t,n){a.inputQueue&&(r=n||r,a._input3(e,t,r))}),(function(t){a._inputErr(t,e)})):a._input3(e,t,r)},_input3:function(e,t,r){var a=this;t&&t.subarray?r?a.bufferSampleRate&&a.bufferSampleRate!=r?a._inputErr("input调用失败：data的sampleRate="+r+"和之前的="+a.bufferSampleRate+"不同",e):(a.bufferSampleRate||(a.bufferSampleRate=r),a.inputQueue[e]=t,a._dest&&a._inputProcess()):a._inputErr("input调用失败：未提供sampleRate",e):a._inputErr("input调用失败：非pcm[Int16,...]输入时，必须解码或者使用transform转换",e)},_inputErr:function(e,t){this.inputQueue[t]=1,this.set.onInputError(e,t)},_inputProcess:function(){var t=this;if(t.bufferSampleRate){for(var r=t.inputQueue,a=t.inputQueueIdx+1;a<r.length;a++){var n=r[a];if(1!=n){if(!n)return;t.inputQueueIdx=a,r[a]=null;var u=t.pcmBuffer,f=u[0],i=u[1];if(f.length){if(i.length){var o=new Int16Array(f.length+i.length);o.set(f),o.set(i,f.length),u[0]=o}}else u[0]=i;u[1]=n}else t.inputQueueIdx=a}e.BadAudioBuffer?t._writeBad():t.audioBuffer?t._writeBuffer():t._createBuffer(!0)}},_createBuffer:function(e){var t=this,r=t.set;if(e||t.audioBuffer){var a=Recorder.Ctx,n=t.bufferSampleRate,u=60*n,f=a.createBuffer(1,u,n),i=a.createBufferSource();i.channelCount=1,i.buffer=f,i.connect(t._dest),r.play&&i.connect(a.destination),i.onended=function(){i.disconnect(),i.stop(),t._createBuffer()},i.start(),t.bufferSource=i,t.audioBuffer=f,t.audioBufferIdx=0,t._createBufferTime=Date.now(),t._writeBuffer()}},_writeBuffer:function(){var e=this,t=e.set,r=e.audioBuffer,a=e.bufferSampleRate,n=e.audioBufferIdx;if(r){var u=Math.floor((Date.now()-e._createBufferTime)/1e3*a);e.audioBufferIdx+.005*a<u&&(e.audioBufferIdx=u);var f=Math.max(0,e.audioBufferIdx-u),i=r.length-e.audioBufferIdx;if(!((i=Math.min(i,~~(.8*a)-f))<1)){var o=e.pcmBuffer,c=o[0],s=o[1];if(c.length+s.length!=0){for(var l=0,d=1,h=t.realtime;h;){var p=f+c.length;if(p<.3*a){var m=Math.floor(.15*a-p);0==n&&m>0&&(e.audioBufferIdx=Math.max(e.audioBufferIdx,m)),h=!1;break}var B=3*a-f;c.length>B&&(c=c.subarray(c.length-B),o[0]=c),d=1.6,l=Math.min(i,Math.floor((c.length+s.length)/d));break}h||(l=Math.min(i,c.length+s.length)),l&&(e.audioBufferIdx=e._subWrite(r,l,e.audioBufferIdx,d))}}}},_writeBad:function(){var e=this,t=e.set,a=e.audioBuffer,n=e.bufferSampleRate,u=Recorder.Ctx;if(a){var f=a.length/n*1e3;if(Date.now()-e._createBufferTime<f-5)return}var i=~~(.8*n),o=t.PlayBufferDisable?0:n/1e3*300,c=e.pcmBuffer,s=c[0],l=c[1],d=s.length+l.length;if(!(0==d||d<o)){for(var h=0,p=1,m=t.realtime;m;){if(s.length<.3*n){m=!1;break}var B=3*n;s.length>B&&(s=s.subarray(s.length-B),c[0]=s),p=1.6,h=Math.min(i,Math.floor((s.length+l.length)/p));break}if(m||(h=Math.min(i,s.length+l.length)),h){a=u.createBuffer(1,h,n),e._subWrite(a,h,0,p),r(a.getChannelData(0),n);var _=u.createBufferSource();_.channelCount=1,_.buffer=a,_.connect(e._dest),t.play&&_.connect(u.destination),_.start(),e.bufferSource=_,e.audioBuffer=a,e._createBufferTime=Date.now()}}},_subWrite:function(e,t,r,a){for(var n=this.pcmBuffer,u=n[0],f=n[1],i=new Int16Array(t),o=0,c=0,s=0;c<t&&s<u.length;)i[c++]=u[o],s+=a,o=Math.round(s);if(o>=u.length){for(u=new Int16Array(0),s=0,o=0;c<t&&s<f.length;)i[c++]=f[o],s+=a,o=Math.round(s);f=o>=f.length?new Int16Array(0):f.subarray(o),n[1]=f}else u=u.subarray(o);n[0]=u;var l=e.getChannelData(0);for(o=0;o<t;o++,r++)l[r]=i[o]/32767;return r}};var r=e.FadeInOut=function(e,t){for(var r=t/1e3*1,a=0;a<r;a++)e[a]*=a/r;var n=e.length;for(a=~~(n-r);a<n;a++)e[a]*=(n-a)/r},a=e.DecodeAudio=function(e,t,r){Recorder.Support()?Recorder.Ctx.decodeAudioData(e,(function(e){for(var r=e.getChannelData(0),a=e.sampleRate,n=new Int16Array(r.length),u=0;u<r.length;u++){var f=Math.max(-1,Math.min(1,r[u]));f=f<0?32768*f:32767*f,n[u]=f}t&&t({sampleRate:a,duration:Math.round(r.length/a*1e3),data:n})}),(function(e){r&&r("音频解码失败:"+(e&&e.message||"-"))})):r&&r("浏览器不支持音频解码")};Recorder.BufferStreamPlayer=e}();